<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>StaffingOps</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='30' fill='%23070c16'/%3E%3Ccircle cx='32' cy='32' r='30' fill='none' stroke='%23c0c8d4' stroke-width='2'/%3E%3Crect x='16' y='30' width='7' height='18' rx='1.5' fill='%23e8ecf0'/%3E%3Crect x='25' y='20' width='7' height='28' rx='1.5' fill='%23e8ecf0' opacity='.7'/%3E%3Crect x='34' y='36' width='7' height='12' rx='1.5' fill='%23e8ecf0' opacity='.5'/%3E%3Crect x='43' y='16' width='7' height='32' rx='1.5' fill='%23e8ecf0' opacity='.8'/%3E%3Cline x1='14' y1='24' x2='52' y2='24' stroke='%23e8ecf0' stroke-width='1.5' stroke-dasharray='3 2' opacity='.4'/%3E%3C/svg%3E">
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#0b0f16;--panel:#111826;--panel2:#0f1622;--line:#2a3446;--text:#e6edf7;--muted:#a8b3c7;--btn:#1f6feb;--btn2:#233047;--danger:#d94848;--ok:#22c55e;--warn:#eab308;--short:#dc2626}
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text)}
body.light{--bg:#f5f7fa;--panel:#ffffff;--panel2:#f0f2f5;--line:#d1d5db;--text:#1f2937;--muted:#6b7280;--btn:#2563eb;--btn2:#e5e7eb;--short:#dc2626;--ok:#16a34a;--warn:#ca8a04}

/* Login */
.login-overlay{position:fixed;inset:0;background:var(--bg);z-index:100000;display:flex;align-items:center;justify-content:center}
.login-overlay.hidden{display:none}
.login-box{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:32px;width:340px;text-align:center}
.login-box h2{font-size:22px;margin-bottom:4px}
.login-box .sub{color:var(--muted);font-size:12px;margin-bottom:18px}
.login-box input{width:100%;padding:10px 12px;font-size:13px;border-radius:8px;border:1px solid var(--line);background:var(--panel2);color:var(--text);margin-bottom:8px;outline:none}
.login-box input:focus{border-color:var(--btn)}
.login-box button{width:100%;padding:10px;font-size:13px;font-weight:800;border-radius:8px;border:none;background:var(--btn);color:#fff;cursor:pointer;margin-top:4px}
.login-box button:hover{opacity:.9}
.login-box .err{color:var(--short);font-size:11px;margin-top:8px;min-height:16px}

/* Header */
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--panel);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:100}
.header-left{display:flex;align-items:center;gap:10px}
.header-left h1{font-size:22px;font-weight:800;display:flex;align-items:center;gap:6px}
.role-flash{font-size:18px;font-weight:900;color:#4aa3ff;width:46px;text-align:center;font-family:system-ui;letter-spacing:1px;display:inline-block;perspective:100px;overflow:hidden;height:24px;line-height:24px}
.role-flash-inner{display:inline-block;width:46px;text-align:center}
.header-pills{display:flex;gap:8px;align-items:center}
.pill{padding:4px 12px;border-radius:20px;font-size:11px;font-weight:700;border:1px solid var(--line);background:var(--panel2)}
.pill.short{background:rgba(220,38,38,.15);color:#ef4444;border-color:rgba(220,38,38,.3)}
.pill.ok{background:rgba(34,197,94,.15);color:#22c55e;border-color:rgba(34,197,94,.3)}
.role-sel{padding:4px 10px;font-size:11px;font-weight:800;border-radius:20px;border:1px solid var(--line);background:var(--panel2);color:var(--text);cursor:pointer;outline:none;letter-spacing:.5px}
.role-sel:focus{border-color:var(--btn)}
.role-sel option{background:var(--panel);color:var(--text)}
.hire-panel{background:rgba(56,189,248,.06);border:1px solid rgba(56,189,248,.2);border-radius:8px;padding:12px 16px;margin-bottom:8px;display:none;align-items:center;justify-content:center;gap:16px}
.hire-panel.show{display:flex}
.hire-total{font-size:28px;font-weight:900;color:#38bdf8;line-height:1}
.hire-total-label{font-size:10px;font-weight:800;color:rgba(56,189,248,.7);letter-spacing:.5px}
.hire-breakdown{display:flex;gap:10px;flex:1;flex-wrap:wrap}
.hire-row{display:flex;align-items:center;gap:6px;padding:6px 10px;border-radius:6px;background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.15)}
.hire-row-count{font-size:18px;font-weight:900;color:#38bdf8}
.hire-row-shift{font-size:11px;font-weight:700;color:var(--text)}
.hire-row-desc{font-size:9px;color:var(--muted)}
.hire-ok{color:#22c55e;font-size:14px;font-weight:800;display:flex;align-items:center;gap:6px}
.header-right{display:flex;align-items:center;gap:8px}
.btn{padding:6px 14px;font-size:11px;font-weight:700;border-radius:6px;border:1px solid var(--line);background:var(--btn2);color:var(--muted);cursor:pointer;transition:all .15s}
.btn:hover{border-color:var(--btn);color:var(--btn)}
.btn.primary{background:var(--btn);color:#fff;border-color:var(--btn)}
.btn.primary:hover{opacity:.9}
.btn.danger{background:rgba(220,38,38,.15);color:#ef4444;border-color:rgba(220,38,38,.3)}
.btn.danger:hover{background:rgba(220,38,38,.25)}
.user-info{font-size:10px;color:var(--muted);text-align:right}

/* Main layout */
.main-layout{display:flex;gap:12px;padding:12px;height:calc(100vh - 52px);overflow:hidden}
.grid-panel{flex:1;display:flex;flex-direction:column;gap:8px;overflow-y:auto}
.roster-panel{flex:1;display:flex;flex-direction:column;gap:8px;overflow:hidden;transition:all .2s}
.roster-panel.collapsed{flex:0 0 0;min-width:0;overflow:hidden;opacity:0;padding:0;gap:0;pointer-events:none}
.roster-panel.collapsed+*,.grid-panel.full-width{flex:1}
.main-layout .grid-panel{transition:flex .2s}

/* Grid split */
.grid-split{display:flex;gap:2px;justify-content:center}
.grid-split-col{flex:0 1 749px}
.grid-split-label{text-align:center;font-size:13px;font-weight:800;color:var(--muted);letter-spacing:1px;padding:6px 0;margin-bottom:3px;border-bottom:1px solid var(--line)}
.grid-split-label.night{color:#818cf8}

/* Staffing grid */
.staffing-grid{display:grid;grid-template-columns:43px repeat(7,1fr);gap:3px;justify-content:center}
.grid-header{background:var(--panel);border:1px solid var(--line);border-radius:4px;padding:7px 5px;text-align:center;font-size:14px;font-weight:800}
.grid-header.day-short{color:#ef4444}
.grid-header.day-ok{color:#22c55e}
.day-summary{font-size:11px;font-weight:600;display:block;margin-top:2px}
.block-label{background:var(--panel);border:1px solid var(--line);border-radius:4px;padding:5px 4px;font-size:13px;font-weight:700;display:flex;align-items:center;justify-content:center;text-align:center;color:var(--muted)}
.grid-cell{background:var(--panel);border:1px solid var(--line);border-radius:4px;padding:5px 7px;text-align:center;transition:all .15s;cursor:default;position:relative;min-height:36px;display:flex;align-items:center;justify-content:flex-start;gap:5px}
.grid-cell .cell-ratio{font-size:15px;font-weight:800}
.grid-cell .cell-delta{font-size:12px;font-weight:700;text-transform:uppercase}
.grid-cell.short{background:#3b1111;border-color:rgba(220,38,38,.6);color:#fca5a5}
.grid-cell.short .cell-ratio{color:#ef4444}
.grid-cell.short .cell-delta{color:#fca5a5}
.grid-cell.adequate{background:#302a0a;border-color:rgba(234,179,8,.5)}
.grid-cell.adequate .cell-ratio{color:#eab308}
.grid-cell.adequate .cell-delta{color:#ca8a04}
.grid-cell.over{background:#0a2e1a;border-color:rgba(34,197,94,.5)}
.grid-cell.over .cell-ratio{color:#22c55e}
.grid-cell.over .cell-delta{color:#16a34a}
.grid-cell.highlight{box-shadow:0 0 0 3px rgba(74,163,255,.9)!important;z-index:2;animation:none!important}
@keyframes needPulse{0%,100%{box-shadow:0 0 4px rgba(220,38,38,.3)}50%{box-shadow:0 0 12px rgba(220,38,38,.7)}}
.grid-cell.short{animation:needPulse 1.5s ease-in-out infinite}
.cell-change{position:absolute;top:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;padding:0 10px;font-size:15px;font-weight:900;border-radius:0 3px 3px 0;z-index:3;letter-spacing:.3px}
.cell-change-up{background:#15803d;color:#fff;border:1px solid #22c55e}
.cell-change-down{background:#b91c1c;color:#fff;border:1px solid #ef4444}

/* Cell detail popup */
.cell-people{display:none;position:absolute;top:100%;left:50%;transform:translateX(-50%);z-index:50;background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:8px;font-size:10px;font-weight:600;text-align:left;white-space:nowrap;box-shadow:0 4px 20px rgba(0,0,0,.4);max-height:200px;overflow-y:auto;margin-top:4px;min-width:120px}
.grid-cell:hover .cell-people{display:block}
.cell-people div{padding:1px 0;color:var(--text)}

/* Roster */
.roster-controls{display:flex;gap:6px;align-items:center;flex-shrink:0}
.roster-controls input{flex:1;padding:7px 10px;font-size:12px;border-radius:6px;border:1px solid var(--line);background:var(--panel2);color:var(--text);outline:none}
.roster-controls input:focus{border-color:var(--btn)}
.roster-wrap{flex:1;overflow:auto;border:1px solid var(--line);border-radius:8px;background:var(--panel)}
.roster-tbl{min-width:100%;border-collapse:collapse;font-size:11px;width:max-content}
.roster-tbl th{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--line);padding:6px 4px;font-size:10px;font-weight:800;color:var(--muted);text-transform:uppercase;white-space:nowrap;z-index:5}
.roster-tbl td{padding:4px;border-bottom:1px solid rgba(255,255,255,.04);white-space:nowrap;vertical-align:middle}
.roster-tbl tr:hover{background:rgba(255,255,255,.03)}
.roster-tbl .name-col{font-weight:700;font-size:11px;padding-left:6px;min-width:90px}
.roster-tbl .hrs-col{text-align:center;font-weight:700;color:var(--muted);font-size:10px;min-width:36px}
.shift-sel{padding:3px 2px;font-size:10px;font-weight:600;border-radius:4px;border:1px solid transparent;background:var(--panel2);color:var(--text);cursor:pointer;width:64px;outline:none;text-align:center}
.shift-sel option{background:var(--panel);color:var(--text)}
.shift-sel:focus{border-color:var(--btn)}
.shift-sel.off-val{color:var(--muted);opacity:.5}
.cell-changed{background:rgba(234,179,8,.12)!important;border-radius:4px}
.cell-changed .shift-sel{color:#eab308}
tr.excluded{opacity:.35;text-decoration:line-through}
tr.excluded .shift-sel{pointer-events:none}
tr.modified .name-col{color:#eab308}
tr.hypothetical{background:rgba(56,189,248,.06)}
tr.hypothetical .name-col{color:#38bdf8}
.hypo-badge{font-size:8px;padding:1px 5px;border-radius:4px;background:rgba(56,189,248,.2);color:#38bdf8;font-weight:800;vertical-align:middle;margin-left:4px}
.lead-badge{font-size:8px;padding:1px 5px;border-radius:4px;background:rgba(251,146,60,.2);color:#fb923c;font-weight:800;vertical-align:middle;margin-left:4px;border:1px solid rgba(251,146,60,.3)}
.remove-hypo{background:none;border:none;color:#ef4444;font-size:16px;cursor:pointer;font-weight:800;padding:0 4px}
.remove-hypo:hover{opacity:.7}
.toggle-cb{width:16px;height:16px;cursor:pointer;accent-color:var(--btn)}

/* Hypothetical section */
.hypo-section{border:1px solid rgba(56,189,248,.2);border-radius:8px;background:rgba(56,189,248,.03);overflow:hidden;flex-shrink:0;display:flex;flex-direction:column}
.hypo-header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid rgba(56,189,248,.15);background:rgba(56,189,248,.06)}
.hypo-title{font-size:14px;font-weight:800;color:#38bdf8;letter-spacing:.5px}
.btn-sm{padding:5px 12px!important;font-size:12px!important}
.hypo-list{flex-shrink:0;overflow-x:auto}
.hypo-empty{text-align:center;color:var(--muted);padding:16px;font-size:13px}
.hypo-picker{padding:4px 8px;font-size:12px;font-weight:600;border-radius:4px;border:1px solid rgba(56,189,248,.3);background:var(--panel2);color:var(--text);outline:none;max-width:180px;cursor:pointer}
.hypo-picker:focus{border-color:#38bdf8}
.hypo-orig-badge{font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(234,179,8,.2);color:#eab308;font-weight:800;vertical-align:middle;margin-left:4px}
.hypo-new-badge{font-size:10px;padding:2px 6px;border-radius:4px;background:rgba(56,189,248,.2);color:#38bdf8;font-weight:800;vertical-align:middle;margin-left:4px}
.hypo-tbl{width:100%;border-collapse:collapse;font-size:13px}
.hypo-tbl th{background:rgba(56,189,248,.06);border-bottom:1px solid rgba(56,189,248,.1);padding:6px 5px;font-size:11px;font-weight:800;color:#38bdf8;text-transform:uppercase;text-align:center;white-space:nowrap}
.hypo-tbl td{padding:5px 4px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:middle;text-align:center}
.hypo-tbl tr:hover{background:rgba(56,189,248,.04)}
.hypo-tbl .name-col{font-weight:700;font-size:14px;padding-left:6px;color:#38bdf8;text-align:left;white-space:nowrap}
.hypo-tbl .hrs-col{text-align:center;font-weight:700;color:var(--muted);font-size:12px}
tr.hypo-disabled{opacity:.5}
tr.hypo-disabled .name-col{text-decoration:line-through}
.remove-hypo{background:none;border:none;color:#ef4444;font-size:16px;cursor:pointer;font-weight:800;padding:0 4px}
.remove-hypo:hover{opacity:.7}
.toggle-cb{width:16px;height:16px;cursor:pointer;accent-color:var(--btn)}
.hypo-pill{display:inline-block;padding:5px 10px;border-radius:999px;border:1px solid rgba(56,189,248,.2);background:rgba(56,189,248,.08);color:#38bdf8;font-size:12px;font-weight:700;cursor:pointer;transition:all .12s;white-space:nowrap;min-width:44px;text-align:center}
.hypo-pill:hover{border-color:#38bdf8;background:rgba(56,189,248,.18)}
.hypo-pill.off{background:rgba(255,255,255,.03);color:var(--muted);border-color:var(--line);opacity:.45;font-weight:600}
.hypo-pill.changed{background:rgba(234,179,8,.12);color:#eab308;border-color:rgba(234,179,8,.3)}
.hypo-tbl .split-hdr{font-size:11px;font-weight:800;letter-spacing:1px;text-transform:uppercase;padding:7px 5px 4px;text-align:center;border-bottom:2px solid var(--line)}
.hypo-tbl .split-hdr.orig{color:var(--muted);background:rgba(255,255,255,.03)}
.hypo-tbl .split-hdr.new{color:#38bdf8;background:rgba(56,189,248,.08);border-left:2px solid rgba(56,189,248,.3)}
.hypo-tbl .orig-day{color:var(--muted)!important;font-size:10px!important}
.hypo-tbl .new-divider{border-left:2px solid rgba(56,189,248,.25)!important}
.orig-cell{font-size:11px;font-weight:600;color:var(--muted);white-space:nowrap;text-align:center;padding:5px 3px}
.orig-cell.off{opacity:.3}
.orig-cell.was-changed{text-decoration:line-through;color:#eab308;opacity:.65}
.new-cell{text-align:center;padding:4px 2px}
.hypo-edit{display:none;gap:6px;align-items:center;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px 12px;box-shadow:0 8px 32px rgba(0,0,0,.55);z-index:10000}
.hypo-edit.open{display:flex!important;position:fixed!important}
.hypo-edit-lbl{font-size:9px;font-weight:800;color:var(--muted);letter-spacing:.3px}
.hypo-edit input[type="text"]{padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:var(--panel2);color:var(--text);font-size:14px;font-weight:700;width:60px;outline:none;text-align:center;font-family:'Segoe UI',monospace;letter-spacing:1px}
.hypo-edit input[type="text"]:focus{border-color:#38bdf8}
.hypo-edit input[type="text"]::placeholder{color:var(--muted);opacity:.4;font-weight:600;font-size:11px}
.hypo-edit-clr{padding:4px 10px;border-radius:6px;border:1px solid rgba(239,68,68,.3);background:rgba(239,68,68,.1);color:#ef4444;font-size:9px;font-weight:800;cursor:pointer;letter-spacing:.3px}
.hypo-edit-clr:hover{background:rgba(239,68,68,.2)}
/* Status bar */
.status-bar{display:flex;align-items:center;justify-content:center;gap:16px;padding:10px 14px;background:var(--panel);border:1px solid var(--line);border-radius:8px;font-size:12px;font-weight:700}
.status-bar .sb-item{display:flex;align-items:center;gap:6px}
.status-bar .sb-label{color:var(--muted)}
.status-bar .sb-val{font-size:14px;font-weight:800}
.status-bar .sb-val.short{color:#ef4444}
.status-bar .sb-val.ok{color:#22c55e}
.status-bar .sb-delta{padding:3px 10px;border-radius:12px;font-size:11px;font-weight:800}
.status-bar .sb-delta.improved{background:rgba(34,197,94,.15);color:#22c55e}
.status-bar .sb-delta.worsened{background:rgba(220,38,38,.15);color:#ef4444}
.status-bar .sb-delta.neutral{background:rgba(148,163,184,.1);color:var(--muted)}
.status-bar .sb-sep{width:1px;height:20px;background:var(--line)}
.pill-wrap{position:relative;display:inline-block}
.excl-pill{background:rgba(239,68,68,.15);color:#ef4444;border-color:rgba(239,68,68,.3);cursor:pointer}
.excl-pill.none{background:var(--panel2);color:var(--muted);border-color:var(--line);cursor:default}
.excl-dropdown{display:none;position:absolute;top:100%;left:50%;transform:translateX(-50%);margin-top:6px;background:var(--panel);border:1px solid rgba(239,68,68,.3);border-radius:8px;padding:8px 0;min-width:180px;box-shadow:0 8px 28px rgba(0,0,0,.5);z-index:200;max-height:300px;overflow-y:auto}
.pill-wrap:hover .excl-dropdown.has-items{display:block}
.excl-dropdown-item{display:flex;align-items:center;justify-content:space-between;padding:5px 12px;font-size:11px;font-weight:700;color:#fca5a5;cursor:pointer;transition:background .1s}
.excl-dropdown-item:hover{background:rgba(239,68,68,.12)}
.excl-dropdown-item .excl-x{color:#ef4444;font-weight:900;font-size:13px;margin-left:8px}

.hypo-apply-bar{display:flex;justify-content:center;gap:10px;padding:8px 10px;border-top:1px solid rgba(56,189,248,.15);flex-wrap:wrap;align-items:center}
.btn-apply-toggle{padding:8px 24px;font-size:12px;font-weight:800;border-radius:8px;border:2px solid var(--btn);background:var(--btn);color:#fff;cursor:pointer;transition:all .15s;letter-spacing:.5px}
.btn-apply-toggle:hover{opacity:.9}
.btn-apply-toggle.active{background:rgba(34,197,94,.15);color:#22c55e;border-color:#22c55e}
.btn-apply-toggle.active:hover{background:rgba(34,197,94,.25)}
.btn-clear-set{padding:6px 14px;font-size:10px;font-weight:800;border-radius:6px;border:1px solid rgba(239,68,68,.3);background:rgba(239,68,68,.1);color:#ef4444;cursor:pointer;letter-spacing:.3px}
.btn-clear-set:hover{background:rgba(239,68,68,.2)}
.btn-print-report{padding:6px 14px;font-size:10px;font-weight:800;border-radius:6px;border:1px solid rgba(56,189,248,.3);background:rgba(56,189,248,.1);color:#38bdf8;cursor:pointer;letter-spacing:.3px}
.btn-print-report:hover{background:rgba(56,189,248,.2)}

/* Hypo drawer (inline) */
.hypo-drawer{display:none;background:var(--panel);border:1px solid rgba(56,189,248,.3);border-radius:8px;padding:12px;margin-top:8px}
.hypo-drawer.open{display:block}
/* Hypo tabs */
.hypo-tabs{display:flex;gap:0;margin-bottom:8px;border-bottom:2px solid var(--line)}
.hypo-tab{padding:8px 18px;font-size:12px;font-weight:800;letter-spacing:.5px;cursor:pointer;border:1px solid transparent;border-bottom:none;border-radius:6px 6px 0 0;color:var(--muted);background:transparent;transition:all .12s;position:relative;display:flex;align-items:center;gap:6px}
.hypo-tab:hover{color:var(--text);background:rgba(56,189,248,.06)}
.hypo-tab.active{color:#38bdf8;background:rgba(56,189,248,.08);border-color:rgba(56,189,248,.3)}
.hypo-tab .tab-count{font-size:9px;background:rgba(56,189,248,.2);color:#38bdf8;padding:1px 6px;border-radius:8px;font-weight:900}
.hypo-tab .tab-applied{font-size:8px;background:rgba(34,197,94,.2);color:#22c55e;padding:1px 5px;border-radius:4px;font-weight:900;margin-left:2px}
.hypo-tab-name{cursor:text}
.hypo-tab-edit-icon{font-size:10px;opacity:.4;cursor:pointer}
.hypo-tab-edit-icon:hover{opacity:1}
.hypo-tab-name-input{background:transparent;border:1px solid #38bdf8;border-radius:3px;color:#38bdf8;font-size:12px;font-weight:800;width:80px;padding:1px 4px;outline:none}
.btn-hypo-drawer{position:relative}
.btn-hypo-drawer .hypo-badge-count{position:absolute;top:-6px;right:-6px;background:#38bdf8;color:#000;font-size:9px;font-weight:900;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 4px}

/* Vacation drawer */
.vac-drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:88;display:none}
.vac-drawer-backdrop.open{display:block}
.vac-drawer{position:fixed;top:52px;left:0;right:0;max-height:calc(100vh - 52px);overflow-y:auto;background:var(--panel);border-bottom:2px solid rgba(34,197,94,.3);box-shadow:0 8px 40px rgba(0,0,0,.5);z-index:89;transform:translateY(-100%);transition:transform .25s ease;padding:12px}
.vac-drawer.open{transform:translateY(0)}
.btn-vac-drawer{position:relative}
.btn-vac-drawer .vac-badge-count{position:absolute;top:-6px;right:-6px;background:#22c55e;color:#000;font-size:9px;font-weight:900;min-width:16px;height:16px;border-radius:8px;display:flex;align-items:center;justify-content:center;padding:0 4px}
.vac-section{border:1px solid rgba(34,197,94,.2);border-radius:8px;background:rgba(34,197,94,.03);overflow:hidden}
.vac-header{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid rgba(34,197,94,.15);background:rgba(34,197,94,.06);font-size:14px;font-weight:800;color:#22c55e;letter-spacing:.5px}
.vac-form{display:flex;gap:8px;align-items:center;padding:10px;flex-wrap:wrap}
.vac-form select,.vac-form input{padding:6px 8px;font-size:12px;font-weight:600;border-radius:6px;border:1px solid var(--line);background:var(--panel2);color:var(--text);outline:none}
.vac-form select:focus,.vac-form input:focus{border-color:#22c55e}
.vac-form .btn-vac-add{padding:6px 16px;font-size:11px;font-weight:800;border-radius:6px;border:1px solid rgba(34,197,94,.3);background:rgba(34,197,94,.15);color:#22c55e;cursor:pointer}
.vac-form .btn-vac-add:hover{background:rgba(34,197,94,.25)}
.vac-tbl{width:100%;border-collapse:collapse;font-size:12px}
.vac-tbl th{background:rgba(34,197,94,.06);border-bottom:1px solid rgba(34,197,94,.1);padding:6px 8px;font-size:10px;font-weight:800;color:#22c55e;text-transform:uppercase;text-align:left}
.vac-tbl td{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.03);vertical-align:middle}
.vac-tbl tr:hover{background:rgba(34,197,94,.04)}
.vac-tbl .vac-name{font-weight:700;color:#22c55e}
.vac-tbl .vac-del{background:none;border:none;color:#ef4444;font-size:16px;cursor:pointer;font-weight:800;padding:0 4px}
.vac-tbl .vac-del:hover{opacity:.7}
.vac-empty{text-align:center;color:var(--muted);padding:16px;font-size:13px}
tr.on-vacation{opacity:.35;text-decoration:line-through;background:rgba(34,197,94,.04)!important}
tr.on-vacation .shift-sel{pointer-events:none}

/* Impact bar */
.impact-bar{position:fixed;bottom:0;left:0;right:0;background:var(--panel);border-top:1px solid var(--line);padding:8px 16px;display:none;align-items:center;justify-content:center;gap:16px;font-size:12px;font-weight:700;z-index:99}
.impact-label{color:var(--muted)}
.impact-label b{color:var(--text)}
.impact-delta{padding:3px 10px;border-radius:12px;font-size:11px}
.impact-delta.improved{background:rgba(34,197,94,.15);color:#22c55e}
.impact-delta.worsened{background:rgba(220,38,38,.15);color:#ef4444}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:10000;display:none;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal-box{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:24px;width:380px}
.modal-box h3{font-size:15px;margin-bottom:12px}
.modal-box label{display:block;font-size:11px;font-weight:700;color:var(--muted);margin-bottom:4px;margin-top:10px}
.modal-box input,.modal-box select{width:100%;padding:8px 10px;font-size:12px;border-radius:6px;border:1px solid var(--line);background:var(--panel2);color:var(--text);outline:none}
.modal-box input:focus,.modal-box select:focus{border-color:var(--btn)}
.modal-actions{display:flex;gap:8px;margin-top:16px;justify-content:flex-end}

/* OT Needs panel */
.ot-needs-panel{background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:12px;margin-top:8px}
.ot-needs-title{font-size:16px;font-weight:900;letter-spacing:1px;text-align:center;margin-bottom:10px;color:#ef4444}
.ot-needs-subtitle{font-size:11px;font-weight:700;color:var(--muted);text-align:center;margin-bottom:12px}
.ot-needs-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:8px}
.ot-date-card{background:var(--panel2);border:1px solid var(--line);border-radius:6px;padding:8px 10px;transition:all .15s}
.ot-date-card.has-short{border-color:rgba(220,38,38,.4);background:rgba(220,38,38,.04)}
.ot-date-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.ot-date-label{font-size:13px;font-weight:800}
.ot-date-label.weekend{color:#818cf8}
.ot-date-total{font-size:11px;font-weight:800;color:#ef4444;background:rgba(220,38,38,.15);padding:2px 8px;border-radius:10px}
.ot-block-row{display:flex;align-items:center;gap:6px;padding:3px 0;font-size:11px}
.ot-block-label{font-weight:700;color:var(--muted);min-width:70px}
.ot-block-need{font-weight:800;color:#ef4444}
.ot-block-bar{flex:1;height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden}
.ot-block-bar-fill{height:100%;background:#ef4444;border-radius:3px;transition:width .2s}
.ot-needs-empty{text-align:center;color:var(--ok);font-size:14px;font-weight:700;padding:20px}
.ot-vac-names{font-size:10px;color:rgba(34,197,94,.7);font-weight:600;margin-bottom:4px}

/* OT Monthly calendar */
.ot-month-hdr{display:flex;align-items:center;justify-content:center;gap:14px;padding:10px 0}
.ot-month-title{font-size:24px;font-weight:900;letter-spacing:2px;color:var(--text)}
.ot-month-summary{font-size:12px;font-weight:700;color:var(--muted);text-align:center;margin-bottom:10px}

/* OT horizontal scroll */
.ot-scroll-x{overflow-x:auto;overflow-y:hidden;max-width:100%;max-height:100%;flex:1;padding-bottom:6px}

/* Month roster table */
.ot-roster-tbl{border-collapse:separate;border-spacing:0;width:max-content;font-size:11px}
.ot-roster-tbl th,.ot-roster-tbl td{border:1px solid rgba(255,255,255,.08);padding:4px 5px;vertical-align:top}
.ot-roster-tbl th{background:var(--panel);font-weight:800;color:var(--muted);text-align:center;white-space:nowrap}
.ot-roster-tbl th.sticky-col{position:sticky;left:0;z-index:5;background:rgba(15,22,34,.98);text-align:left;padding-left:10px;min-width:90px;font-size:13px;font-weight:900;letter-spacing:.5px}
.ot-roster-tbl th.dayhead{font-size:12px;font-weight:900;color:var(--muted);padding:10px 4px;text-align:center}
.ot-roster-tbl th.dayhead.weekend{color:#818cf8}
.ot-roster-tbl th.dayhead.today{color:var(--btn);border-bottom-color:var(--btn)}
.ot-roster-tbl th.subhead{font-size:10px;font-weight:800;color:var(--muted);padding:3px 4px;text-transform:none}
.ot-roster-tbl td{min-width:130px}
.ot-roster-tbl td.sticky-col{position:sticky;left:0;z-index:4;background:rgba(15,22,34,.98);font-size:12px;font-weight:900;color:var(--text);text-align:left;padding-left:10px;white-space:nowrap;min-width:90px}

/* Name chips — RotationOps style */
.ot-name{display:block;border-radius:8px;padding:6px 10px;margin:2px 0;font-size:11px;font-weight:700;min-width:110px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;border:1px solid rgba(255,255,255,.14)}
.ot-num{display:inline-block;width:18px;height:18px;line-height:18px;border-radius:50%;background:rgba(0,0,0,.25);color:#fff;font-size:9px;font-weight:900;text-align:center;margin-right:6px;flex-shrink:0}
.ot-name.needed{background:#dc2626!important;border:2px solid #fca5a5!important;color:#fff!important;font-weight:900!important;font-size:11px!important;letter-spacing:1px;animation:needPulse 1.2s ease-in-out infinite;text-shadow:0 1px 4px rgba(0,0,0,.5)}
.ot-name.needed .ot-num{background:rgba(0,0,0,.35)}
.ot-name.vac{background:rgba(125,211,252,.15);border-color:rgba(125,211,252,.3);color:#7dd3fc;font-weight:700}
@keyframes needPulse{0%,100%{box-shadow:0 0 4px rgba(220,38,38,.4)}50%{box-shadow:0 0 14px rgba(220,38,38,.8),0 0 24px rgba(220,38,38,.3)}}
.ct-badge{display:inline-block;margin-left:4px;padding:1px 5px;border-radius:4px;background:#0ea5e9;color:#fff;font-size:8px;font-weight:900;vertical-align:middle}
.ot-badge{display:inline-block;margin-left:4px;padding:1px 5px;border-radius:4px;background:#dc2626;color:#fff;font-size:8px;font-weight:900;vertical-align:middle}
#otAssignBox{display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--panel);border:1px solid var(--line);border-radius:10px;padding:18px 20px;min-width:300px;max-width:400px;box-shadow:0 8px 32px rgba(0,0,0,.6);z-index:10000}
#otAssignBox.show{display:block}
#otAssignBackdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,.45);z-index:9999}
#otAssignBackdrop.show{display:block}
#otAssignBox select{width:100%;padding:8px 10px;font-size:13px;font-weight:700;border-radius:6px;border:1px solid var(--line);background:var(--panel2);color:var(--text);outline:none;margin-bottom:12px}
#otAssignBox select:focus{border-color:var(--btn)}

/* OT Explanation */
.ot-explain{background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:10px 14px;margin-bottom:12px;font-size:11px;line-height:1.6;color:var(--muted)}
.ot-explain-title{font-size:12px;font-weight:800;color:var(--text);margin-bottom:4px;letter-spacing:.5px}
.ot-explain ol{margin:4px 0 0 18px;padding:0}
.ot-explain li{margin-bottom:2px}

/* Loading */
.loading{display:flex;align-items:center;justify-content:center;height:300px;color:var(--muted);font-size:13px;font-weight:700}

/* Toast */
.toast{position:fixed;bottom:60px;left:50%;transform:translateX(-50%);background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:8px 16px;font-size:11px;font-weight:700;color:var(--text);box-shadow:0 4px 20px rgba(0,0,0,.4);z-index:99999;opacity:0;transition:opacity .2s;pointer-events:none}
.toast.show{opacity:1}

@media(max-width:1100px){.main-layout{flex-direction:column;height:auto}.grid-panel{flex:none}.roster-panel{flex:none;max-height:50vh}}
</style>
</head>
<body>

<div class="login-overlay" id="loginOverlay">
  <div class="login-box">
    <h2>&#128202; StaffingOps</h2>
    <div class="sub">Sign in to continue</div>
    <input type="email" id="loginEmail" placeholder="Email" />
    <input type="password" id="loginPass" placeholder="Password" />
    <button id="btnLogin">SIGN IN</button>
    <div class="err" id="loginErr"></div>
  </div>
</div>

<div id="app" style="display:none">
  <div class="header">
    <div class="header-left">
      <h1><span class="role-flash"><span class="role-flash-inner" id="roleFlashInner">CT</span></span> StaffingOps</h1>
      <select class="role-sel" id="roleSelector">
        <option value="CALLTAKER">CALLTAKER</option>
        <option value="DISPATCHER">DISPATCHER</option>
        <option value="PIC">PIC</option>
      </select>
      <select class="role-sel" id="monthSelector"></select>
      <select class="role-sel" id="viewMode">
        <option value="ot">OT NEEDS</option>
        <option value="staffing">STAFFING NUMBERS</option>
      </select>
      <div class="header-pills">
        <span class="pill-wrap" id="pillExcludedWrap">
          <span class="pill excl-pill" id="pillExcluded">0 EXCLUDED</span>
          <div class="excl-dropdown" id="exclDropdown"></div>
        </span>
        <span class="pill" id="pillDispatchers">0 DISPATCHERS</span>
      </div>
    </div>
    <div class="header-right">
      <div style="position:relative;display:inline-block">
        <button class="btn" id="btnHowItWorks" style="border-color:rgba(74,163,255,.3);color:#4aa3ff;background:rgba(74,163,255,.06)">HOW IT WORKS</button>
        <div id="howItWorksPopup" style="display:none;position:absolute;top:calc(100% + 6px);right:0;z-index:999;width:520px;max-height:80vh;overflow-y:auto;background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,.5)">
          <div id="howItWorksContent"></div>
        </div>
      </div>
      <button class="btn btn-vac-drawer" id="btnVacDrawer">VACATIONS</button>
      <button class="btn btn-hypo-drawer" id="btnHypoDrawer">HYPOTHETICALS</button>
      <button class="btn danger" id="btnReset" style="display:none">RESET ALL</button>
      <button class="btn" id="btnPrintChanges">PRINT CHANGES</button>
      <button class="btn" id="btnExport">EXPORT DATA</button>
      <button class="btn" id="btnCollapseRoster">SHOW ROSTER</button>
      <button class="btn" id="btnTheme"><span id="themeIcon">&#9728;&#65039;</span> <span id="themeLabel">LIGHT</span></button>
      <button id="btnBugReport" type="button" title="Report a Bug" style="background:transparent;border:1px solid var(--muted);border-radius:6px;padding:4px 10px;cursor:pointer;font-size:11px;font-weight:700;color:var(--muted);display:inline-flex;align-items:center;gap:5px;transition:border-color .15s,color .15s;font-family:inherit" onmouseenter="this.style.borderColor='#ef4444';this.style.color='#ef4444'" onmouseleave="this.style.borderColor='var(--muted)';this.style.color='var(--muted)'">&#x1fab2; REPORT BUG</button>
      <div class="user-info"><span id="userEmail"></span><br><a href="#" id="btnLogout" style="color:var(--muted);font-size:9px">SIGN OUT</a></div>
    </div>
  </div>


  <div class="main-layout">
    <div class="grid-panel" id="gridPanel">
      <div id="hirePanel" style="display:none"></div>
      <!-- STAFFING NUMBERS view -->
      <div id="staffingView">
        <div style="text-align:center;font-size:26px;font-weight:900;letter-spacing:2px;color:var(--text);padding:10px 0 0">STAFFING GRID</div>
        <div id="gridMonthLabel" style="text-align:center;font-size:13px;font-weight:700;color:var(--muted);letter-spacing:1px;padding:0 0 6px"></div>
        <div class="grid-split">
          <div class="grid-split-col">
            <div class="grid-split-label">DAY SHIFT</div>
            <div class="staffing-grid" id="staffingGridDay"></div>
          </div>
          <div class="grid-split-col">
            <div class="grid-split-label night">NIGHT SHIFT</div>
            <div class="staffing-grid" id="staffingGridNight"></div>
          </div>
        </div>
        <div class="status-bar" id="statusBar"></div>
        <div class="hypo-drawer" id="hypoDrawer">
          <div id="verifyPanel" style="display:none;background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:12px;margin-bottom:8px;max-height:300px;overflow-y:auto">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <span style="font-size:13px;font-weight:800;color:#38bdf8">VERIFY: Hypothetical Impact Per Cell</span>
              <button onclick="document.getElementById('verifyPanel').style.display='none'" style="background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer">&times;</button>
            </div>
            <table id="verifyTable" style="width:100%;border-collapse:collapse;font-size:11px"></table>
          </div>
          <div class="hypo-tabs" id="hypoTabs"></div>
          <div class="hypo-section" id="hypoSection">
            <div class="hypo-header">
              <span class="hypo-title">HYPOTHETICALS</span>
              <div style="display:flex;gap:6px;align-items:center">
                <select id="hypoPickDispatcher" class="hypo-picker"><option value="">Load dispatcher...</option></select>
                <button class="btn btn-sm" id="btnAddHypoBlank">+ NEW</button>
                <button class="btn btn-sm" id="btnLoadRecs" style="background:rgba(34,197,94,.15);color:#22c55e;border-color:rgba(34,197,94,.3)">LOAD RECS</button>
                <button class="btn btn-sm" id="btnTrimRecs" style="background:rgba(239,68,68,.15);color:#ef4444;border-color:rgba(239,68,68,.3)">TRIM</button>
                <button class="btn btn-sm" id="btnSuggest" style="background:rgba(99,102,241,.15);color:#818cf8;border-color:rgba(99,102,241,.3)">SUGGEST</button>
              </div>
            </div>
            <div class="hypo-list" id="hypoList"></div>
            <div class="hypo-apply-bar" id="hypoApplyBar" style="display:none">
              <button class="btn-apply-toggle" id="btnApplyA">APPLY SET A</button>
              <button class="btn-apply-toggle" id="btnApplyB">APPLY SET B</button>
              <button class="btn-clear-set" id="btnClearSet">CLEAR SET</button>
              <button class="btn-print-report" id="btnPrintReport" style="display:none">PRINT REPORT</button>
            </div>
          </div>
        </div>
      </div>
      <!-- OT NEEDS monthly view -->
      <div id="otMonthView" style="display:none"></div>
    </div>
    <div class="roster-panel collapsed" id="rosterPanel">
      <div class="roster-controls">
        <input type="text" id="rosterSearch" placeholder="Search name..." />
      </div>
      <div class="roster-wrap" id="rosterWrap">
        <div class="loading">Loading roster...</div>
      </div>
    </div>
  </div>

  <div class="vac-drawer-backdrop" id="vacBackdrop"></div>
  <div class="vac-drawer" id="vacDrawer">
    <div class="vac-section">
      <div class="vac-header">VACATIONS <span style="font-size:10px;font-weight:600;color:var(--muted);margin-left:8px">(read-only — manage in VacationOps)</span></div>
      <div id="vacList"></div>
    </div>
  </div>

  <div class="impact-bar" id="impactBar"></div>
</div>

<!-- Hypothetical modal -->
<div class="modal-overlay" id="hypoModal">
  <div class="modal-box">
    <h3>Add Hypothetical Person</h3>
    <label>NAME</label>
    <input type="text" id="hypoName" placeholder="e.g. NEW HIRE 1" />
    <p style="font-size:11px;color:var(--muted);margin-top:12px">Schedule defaults to OFF. Set IN/OUT times in the table after adding.</p>
    <div class="modal-actions">
      <button class="btn" id="btnHypoCancel">CANCEL</button>
      <button class="btn primary" id="btnHypoAdd">ADD</button>
    </div>
  </div>
</div>

<!-- Export modal -->
<div class="modal-overlay" id="exportModal">
  <div class="modal-box" style="width:600px;max-height:80vh;display:flex;flex-direction:column">
    <h3>Export Data</h3>
    <p style="font-size:11px;color:var(--muted);margin-bottom:10px">Copy this and paste it to Claude for analysis.</p>
    <textarea id="exportText" style="flex:1;min-height:350px;width:100%;padding:10px;font-size:10px;font-family:monospace;border-radius:6px;border:1px solid var(--line);background:var(--panel2);color:var(--text);resize:none;outline:none" readonly></textarea>
    <div class="modal-actions">
      <button class="btn primary" id="btnCopyExport">COPY TO CLIPBOARD</button>
      <button class="btn" id="btnCloseExport">CLOSE</button>
    </div>
  </div>
</div>

<div id="otAssignBackdrop"></div>
<div id="otAssignBox">
  <div style="font-weight:900;font-size:14px;margin-bottom:4px;letter-spacing:.5px" id="otAssignTitle">ASSIGN OT SLOT</div>
  <div style="font-size:11px;color:var(--muted);margin-bottom:12px" id="otAssignInfo"></div>
  <select id="otAssignSelect"><option value="">Select person...</option></select>
  <div style="display:flex;gap:8px">
    <button class="btn primary" id="btnOtAssign">ASSIGN</button>
    <button class="btn" id="btnOtAssignCancel">CANCEL</button>
  </div>
</div>

<div id="bugReportModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.5);z-index:99999;align-items:center;justify-content:center">
  <div style="background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:20px;min-width:360px;max-width:440px;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)">
    <h3 style="margin:0 0 15px;color:#ef4444">&#x1fab2; REPORT A BUG</h3>
    <div style="margin-bottom:12px">
      <label style="font-size:12px;font-weight:700;display:block;margin-bottom:6px">YOUR NAME:</label>
      <input type="text" id="bugReportName" placeholder="Enter your name" style="width:100%;padding:8px;font-size:13px;border-radius:6px;border:1px solid var(--line);background:var(--panel2);color:var(--text);outline:none" />
    </div>
    <div style="margin-bottom:15px">
      <label style="font-size:12px;font-weight:700;display:block;margin-bottom:6px">DETAILS:</label>
      <textarea id="bugReportDetails" placeholder="Describe the bug — what happened, what you expected, and what you were doing when it happened." style="width:100%;padding:8px;font-size:13px;border-radius:6px;border:1px solid var(--line);background:var(--panel2);color:var(--text);min-height:120px;resize:vertical;font-family:inherit;outline:none"></textarea>
    </div>
    <div style="display:flex;gap:10px">
      <button id="btnBugSubmit" style="padding:8px 16px;font-size:12px;font-weight:700;border-radius:6px;border:none;background:#ef4444;color:#fff;cursor:pointer">SUBMIT</button>
      <button id="btnBugCancel" style="padding:8px 16px;font-size:12px;font-weight:700;border-radius:6px;border:1px solid var(--line);background:transparent;color:var(--text);cursor:pointer">CANCEL</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div style="position:fixed;bottom:4px;right:8px;font-size:9px;color:#334155;z-index:1;pointer-events:none">v12</div>

<script>
// ========== FIREBASE ==========
const firebaseConfig = {
  apiKey: "AIzaSyA6KELmSyotefK0zhahQZ0-mbYur8_nTsg",
  authDomain: "commandops-93846.firebaseapp.com",
  databaseURL: "https://commandops-93846-default-rtdb.firebaseio.com",
  projectId: "commandops-93846",
  storageBucket: "commandops-93846.firebasestorage.app",
  messagingSenderId: "262613721964",
  appId: "1:262613721964:web:478a694d357234e3be4949"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();
let SETTINGS_REF = db.collection('staffingops').doc('settings');

// ========== AUTH ==========
document.getElementById('btnLogin').addEventListener('click', async () => {
  const email = document.getElementById('loginEmail').value.trim();
  const pass = document.getElementById('loginPass').value;
  try { await auth.signInWithEmailAndPassword(email, pass); }
  catch (e) { document.getElementById('loginErr').textContent = e.message; }
});
document.getElementById('loginPass').addEventListener('keydown', e => {
  if (e.key === 'Enter') document.getElementById('btnLogin').click();
});
document.getElementById('btnLogout').addEventListener('click', e => {
  e.preventDefault();
  auth.signOut();
});
auth.onAuthStateChanged(user => {
  document.getElementById('loginOverlay').classList.toggle('hidden', !!user);
  document.getElementById('app').style.display = user ? '' : 'none';
  if (user) {
    document.getElementById('userEmail').textContent = user.email;
    loadAllData();
  }
});

// ========== CONSTANTS ==========
const DAYS = ["MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY","SATURDAY","SUNDAY"];
const DAY_LABELS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

const SHIFT_CODES = {
  "6A-2P":[6,14], "6A-6P":[6,18], "10A-6P":[10,18], "10A-10P":[10,22],
  "2P-10P":[14,22], "6P-2A":[18,26], "6P-6A":[18,30], "10P-6A":[22,30],
  "2A-2P":[2,14], "2A-10A":[2,10]
};
const SHIFT_HOURS = {
  "6A-2P":8,"6A-6P":12,"10A-6P":8,"10A-10P":12,
  "2P-10P":8,"6P-2A":8,"6P-6A":12,"10P-6A":8,
  "2A-2P":12,"2A-10A":8,"OFF":0,"":0
};
const VALID_SHIFTS = ["6A-2P","6A-6P","10A-6P","10A-10P","2P-10P","6P-2A","6P-6A","10P-6A","2A-2P","2A-10A","OFF"];

const BLOCKS = [
  {key:"0600",label:"6A",  start:6, end:7},
  {key:"0700",label:"7A",  start:7, end:8},
  {key:"0800",label:"8A",  start:8, end:9},
  {key:"0900",label:"9A",  start:9, end:10},
  {key:"1000",label:"10A", start:10,end:11},
  {key:"1100",label:"11A", start:11,end:12},
  {key:"1200",label:"12P", start:12,end:13},
  {key:"1300",label:"1P",  start:13,end:14},
  {key:"1400",label:"2P",  start:14,end:15},
  {key:"1500",label:"3P",  start:15,end:16},
  {key:"1600",label:"4P",  start:16,end:17},
  {key:"1700",label:"5P",  start:17,end:18},
  {key:"1800",label:"6P",  start:18,end:19},
  {key:"1900",label:"7P",  start:19,end:20},
  {key:"2000",label:"8P",  start:20,end:21},
  {key:"2100",label:"9P",  start:21,end:22},
  {key:"2200",label:"10P", start:22,end:23},
  {key:"2300",label:"11P", start:23,end:24},
  {key:"2400",label:"12A", start:24,end:25},
  {key:"0100",label:"1A",  start:25,end:26},
  {key:"0200",label:"2A",  start:26,end:27},
  {key:"0300",label:"3A",  start:27,end:28},
  {key:"0400",label:"4A",  start:28,end:29},
  {key:"0500",label:"5A",  start:29,end:30}
];

// ========== ROLE CONFIG ==========
let currentRole = 'CALLTAKER';
let currentMonth = (() => { const d = new Date(); return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0'); })();

function getSettingsDocId() {
  return ROLE_CONFIG[currentRole].settingsDoc + '-' + currentMonth;
}

const ROLE_CONFIG = {
  DISPATCHER: {
    posFilter: p => p.includes('DISPATCH'),
    adeqCollection: 'Dispatcher_Adequate_Staffing',
    adeqTimeField: 'Dispatcher Adequate Staffing',
    settingsDoc: 'settings',
    sdEligible: new Set(["RAMIREZ","FOWLERL","GROUNDS","GUIDRY","BROWNC","MARZAHN","CLEMENT"]),
    label: 'DISPATCHERS'
  },
  CALLTAKER: {
    posFilter: p => p.includes('CALL') || p === 'CT',
    adeqCollection: 'Calltaker_Adequate_Staffing',
    adeqTimeField: 'Calltaker Adequate staffing',
    settingsDoc: 'calltaker-settings',
    sdEligible: new Set(),
    label: 'CALLTAKERS'
  },
  PIC: {
    posFilter: p => p.includes('PIC'),
    adeqCollection: 'PIC_Adequate_Staffing',
    adeqTimeField: 'PIC Adequate Staffing',
    settingsDoc: 'pic-settings',
    sdEligible: new Set(),
    label: 'PICS'
  }
};

// ========== STATE ==========
let _ALL_EMPLOYEES = []; // all positions — for OT assignment availability
let ORIG_DISPATCHERS = [];
let ADEQ = {};
let dispatchers = [];
let modifications = new Set();
let excluded = new Set();
let vacations = [];
let BASELINE_SHORTFALL = 0;
let BASELINE_GRID = null; // [dayIdx][blockIdx].current — cached on first load
let rosterSort = 'name'; // 'seniority' or 'name'
let _otAssignments = {}; // key "day-blockIdx" → [names]
let _ctAssignments = {}; // key "day-blockIdx" → [names]  (from RotationOps CT)
let _ctUnsub = null; // onSnapshot unsubscribe for rotation_plans
let _rotationPlanDays = null; // full rotation plan days object for DISPATCHER read-only view

// ========== DUAL HYPO SETS ==========
let hypoSets = { A: [], B: [] };
let hypoSetNames = { A: 'SET A', B: 'SET B' };
let _activeHypoTab = 'A';
let _appliedHypoSet = null; // null | 'A' | 'B'

// Proxy: `hypotheticals` always refers to the active tab's array.
// All ~50 existing references to `hypotheticals` continue to work.
Object.defineProperty(window, 'hypotheticals', {
  get() { return hypoSets[_activeHypoTab]; },
  set(v) { hypoSets[_activeHypoTab] = v; },
  configurable: true
});

function getAppliedHypos() {
  if (!_hypoApplied || !_appliedHypoSet) return [];
  return hypoSets[_appliedHypoSet];
}

// ========== DATA LOADING ==========
async function loadAllData() {
  SETTINGS_REF = db.collection('staffingops').doc(getSettingsDocId());
  try {
    const [empSnap, adeqSnap] = await Promise.all([
      db.collection('employees').get(),
      db.collection(ROLE_CONFIG[currentRole].adeqCollection).get()
    ]);

    // Parse employees
    ORIG_DISPATCHERS = [];
    _ALL_EMPLOYEES = [];
    empSnap.docs.forEach(doc => {
      const d = doc.data();
      const name = String(d.Employee || doc.id || "").trim().toUpperCase();
      if (!name) return;
      const pos = String(d.POSITION ?? d.Position ?? "").toUpperCase();
      const emp = {
        name,
        position: pos,
        isLead: ROLE_CONFIG[currentRole].sdEligible.has(name),
        seniority: Number(d.SENIORITY ?? d.Seniority ?? 999),
        schedule: {
          MONDAY: normalizeShift(d.MONDAY ?? ""),
          TUESDAY: normalizeShift(d.TUESDAY ?? ""),
          WEDNESDAY: normalizeShift(d.WEDNESDAY ?? ""),
          THURSDAY: normalizeShift(d.THURSDAY ?? ""),
          FRIDAY: normalizeShift(d.FRIDAY ?? ""),
          SATURDAY: normalizeShift(d.SATURDAY ?? ""),
          SUNDAY: normalizeShift(d.SUNDAY ?? "")
        }
      };
      _ALL_EMPLOYEES.push(emp);
      if (ROLE_CONFIG[currentRole].posFilter(pos)) {
        ORIG_DISPATCHERS.push(emp);
      }
    });
    ORIG_DISPATCHERS.sort((a, b) => a.seniority - b.seniority);
    _ALL_EMPLOYEES.sort((a, b) => a.seniority - b.seniority);

    // Parse adequate staffing
    ADEQ = {};
    const dayColMap = {"Sun":"SUNDAY","Mon":"MONDAY","Tue":"TUESDAY","Wed":"WEDNESDAY","Thu":"THURSDAY","Fri":"FRIDAY","Sat":"SATURDAY"};
    adeqSnap.docs.forEach(doc => {
      const data = doc.data();
      const timeVal = data[ROLE_CONFIG[currentRole].adeqTimeField];
      if (!timeVal || timeVal === "Time") return;
      const hourKey = String(timeVal).replace(/[^0-9]/g, "").padStart(4, "0");
      for (const [col, day] of Object.entries(dayColMap)) {
        const val = data[col];
        if (val !== undefined && val !== null && val !== "") {
          const num = Number(val);
          if (Number.isFinite(num)) {
            if (!ADEQ[day]) ADEQ[day] = {};
            ADEQ[day][hourKey] = num;
          }
        }
      }
    });

    resetState();
    const baseResult = computeStaffing();
    BASELINE_SHORTFALL = 0;
    for (let d = 0; d < 7; d++) for (let b = 0; b < BLOCKS.length; b++) {
      if (baseResult.grid[d][b].delta < 0) BASELINE_SHORTFALL++;
    }
    BASELINE_GRID = baseResult.grid.map(dayRow => dayRow.map(c => ({ current: c.current })));
    await loadExcluded();
    await loadVacations();
    await loadHypoState();
    listenSettings();
    listenVacations();
    loadRotationCT();
    toggleRoster(true);
    renderAll();
  } catch (e) {
    console.error("Load failed:", e);
    document.getElementById('staffingGrid').innerHTML = '<div class="loading" style="color:#ef4444">Failed to load data. Check console.</div>';
  }
}

function normalizeShift(val) {
  const s = String(val || "").trim().toUpperCase();
  // Map common variants
  if (s === "" || s === "OFF" || s === "O") return "OFF";
  // Try exact match
  if (SHIFT_CODES[s]) return s;
  // Try common formats
  const map = {
    "6A-2P":["6A2P","06-14","0600-1400"],
    "6A-6P":["6A6P","06-18","0600-1800"],
    "10A-6P":["10A6P","10-18","1000-1800"],
    "10A-10P":["10A10P","10-22","1000-2200"],
    "2P-10P":["2P10P","14-22","1400-2200"],
    "6P-2A":["6P2A","18-02","1800-0200"],
    "6P-6A":["6P6A","18-06","1800-0600"],
    "10P-6A":["10P6A","22-06","2200-0600"]
  };
  for (const [code, alts] of Object.entries(map)) {
    if (alts.includes(s)) return code;
  }
  // If contains the shift pattern, try matching
  for (const code of Object.keys(SHIFT_CODES)) {
    if (s.replace(/\s/g, "") === code.replace(/\s/g, "")) return code;
  }
  return s || "OFF";
}

function resetState() {
  dispatchers = ORIG_DISPATCHERS.map(d => ({
    name: d.name,
    isLead: d.isLead,
    seniority: d.seniority,
    schedule: { ...d.schedule }
  }));
  modifications.clear();
  excluded.clear();
  hypoSets = { A: [], B: [] };
  hypoSetNames = { A: 'SET A', B: 'SET B' };
  _activeHypoTab = 'A';
  _appliedHypoSet = null;
  vacations = [];
}

// ========== VACATION HELPER ==========
function isOnVacation(name) {
  if (!vacations.length) return false;
  const upperName = name.toUpperCase();
  const [yr, mo] = currentMonth.split('-').map(Number);
  const monthStart = new Date(yr, mo - 1, 1);
  const monthEnd = new Date(yr, mo, 0); // last day of month
  for (const v of vacations) {
    if (v.name.toUpperCase() !== upperName) continue;
    const from = v.from ? new Date(v.from + 'T00:00:00') : monthStart;
    const to = v.to ? new Date(v.to + 'T00:00:00') : monthEnd;
    // Overlap check: vacation range overlaps month range
    if (from <= monthEnd && to >= monthStart) return true;
  }
  return false;
}

function isOnVacationDate(name, dateObj) {
  if (!vacations.length) return false;
  const nm = name.toUpperCase();
  const dt = dateObj.getTime();
  const [yr, mo] = currentMonth.split('-').map(Number);
  const monthEnd = new Date(yr, mo, 0);
  for (const v of vacations) {
    if (v.name.toUpperCase() !== nm) continue;
    const f = v.from ? new Date(v.from + 'T00:00:00') : new Date(yr, mo - 1, 1);
    const t = v.to ? new Date(v.to + 'T00:00:00') : monthEnd;
    if (dt >= f.getTime() && dt <= t.getTime()) return true;
  }
  return false;
}

// ========== ROTATION CT LOADER ==========
const _ROT_BLOCK_KEYS = ['0600-1000','1000-1400','1400-1800','1800-2200','2200-0200','0200-0600'];
function loadRotationCT() {
  if (_ctUnsub) { _ctUnsub(); _ctUnsub = null; }
  _ctAssignments = {};
  // RotationOps doc ID: rotation_{year}_{0-based monthIndex}
  const [yr, mo] = currentMonth.split('-').map(Number);
  const docId = 'rotation_' + yr + '_' + (mo - 1);
  _ctUnsub = db.collection('rotation_plans').doc(docId).onSnapshot(doc => {
    _ctAssignments = {};
    _rotationPlanDays = null;
    if (!doc.exists) return;
    const data = doc.data();
    if (!data || !data.plan || !data.plan.days) return;
    const days = data.plan.days;
    _rotationPlanDays = days;
    for (const [dayKey, blocks] of Object.entries(days)) {
      // dayKey = "YYYY-MM-DD"
      const parts = dayKey.split('-');
      if (parts.length !== 3) continue;
      const dayOfMonth = parseInt(parts[2], 10);
      if (!dayOfMonth) continue;
      for (let bi = 0; bi < _ROT_BLOCK_KEYS.length; bi++) {
        const bk = _ROT_BLOCK_KEYS[bi];
        if (blocks[bk] && blocks[bk].ct && Array.isArray(blocks[bk].ct) && blocks[bk].ct.length > 0) {
          const key = dayOfMonth + '-' + bi;
          _ctAssignments[key] = blocks[bk].ct.map(n => String(n).toUpperCase());
        }
      }
    }
    renderAll();
  });
}

// Map rotation block keys to the first hour start for adequate staffing lookup
const _ROT_BLOCK_HOURS = [6, 10, 14, 18, 22, 26]; // start hours for each OT block
const _ROT_BLOCK_TO_DAY_IDX = { 0:6, 1:0, 2:1, 3:2, 4:3, 5:4, 6:5 }; // JS dow → DAYS index

function computeMonthlyFromRotation() {
  const [yr, mo] = currentMonth.split('-').map(Number);
  const daysInMonth = new Date(yr, mo, 0).getDate();
  const result = [];
  if (!_rotationPlanDays) return result;
  for (let date = 1; date <= daysInMonth; date++) {
    const dateObj = new Date(yr, mo - 1, date);
    const dow = dateObj.getDay();
    const dayIdx = _ROT_BLOCK_TO_DAY_IDX[dow];
    const day = DAYS[dayIdx];
    const dayKey = yr + '-' + String(mo).padStart(2,'0') + '-' + String(date).padStart(2,'0');
    const dayData = _rotationPlanDays[dayKey];
    // Vacations for this date
    const vacNamesOnDate = [];
    for (const v of vacations) {
      const f = v.from ? new Date(v.from + 'T00:00:00') : new Date(yr, mo - 1, 1);
      const t = v.to ? new Date(v.to + 'T00:00:00') : new Date(yr, mo, 0);
      if (dateObj.getTime() >= f.getTime() && dateObj.getTime() <= t.getTime()) vacNamesOnDate.push(v.name.toUpperCase());
    }
    const blocks = [];
    for (let bi = 0; bi < _ROT_BLOCK_KEYS.length; bi++) {
      const bk = _ROT_BLOCK_KEYS[bi];
      const bd = dayData ? dayData[bk] : null;
      const names = [];
      const otNames = [];
      // Look up adequate staffing from the ADEQ table for this day + block hour
      const blockHour = _ROT_BLOCK_HOURS[bi];
      const adeqBlock = { start: blockHour, end: blockHour + 1 };
      const needed = getNeededForBlock(day, adeqBlock);
      let filled = 0;
      if (bd) {
        // Regular assignments
        if (bd.assignments) {
          for (const [ch, nm] of Object.entries(bd.assignments)) {
            if (nm && String(nm).trim()) {
              filled++;
              const nameUp = String(nm).trim().toUpperCase();
              const isOT = (bd.ot || []).some(o => String(o).toUpperCase() === nameUp);
              if (isOT) {
                otNames.push(nameUp);
              } else {
                names.push({ name: nameUp, isLead: false });
              }
            }
          }
        }
      }
      names.sort((a, b) => a.name.localeCompare(b.name));
      const otNeed = Math.max(0, needed - filled);
      blocks.push({ label: _ROT_BLOCK_KEYS[bi], names, needed, current: filled, otNeed, delta: filled - needed, ctNames: [], otNames });
    }
    result.push({ date, dow, vacNames: [...new Set(vacNamesOnDate)].sort(), blocks });
  }
  return result;
}

// 4-hour OT blocks matching rotationops
const OT_BLOCKS = [
  { label: '6A-10A',  hourStart: 6,  hourEnd: 10, blockIdxs: [0,1,2,3] },
  { label: '10A-2P',  hourStart: 10, hourEnd: 14, blockIdxs: [4,5,6,7] },
  { label: '2P-6P',   hourStart: 14, hourEnd: 18, blockIdxs: [8,9,10,11] },
  { label: '6P-10P',  hourStart: 18, hourEnd: 22, blockIdxs: [12,13,14,15] },
  { label: '10P-2A',  hourStart: 22, hourEnd: 26, blockIdxs: [16,17,18,19] },
  { label: '2A-6A',   hourStart: 26, hourEnd: 30, blockIdxs: [20,21,22,23] }
];

function computeOTNeeds() {
  const [yr, mo] = currentMonth.split('-').map(Number);
  const daysInMonth = new Date(yr, mo, 0).getDate();
  const jsDay2idx = { 0:6, 1:0, 2:1, 3:2, 4:3, 5:4, 6:5 }; // JS Sunday=0 → our index
  const results = [];

  for (let date = 1; date <= daysInMonth; date++) {
    const dateObj = new Date(yr, mo - 1, date);
    const dayIdx = jsDay2idx[dateObj.getDay()];
    const day = DAYS[dayIdx];

    // Get vacation names for this specific date
    const vacNamesOnDate = [];
    for (const v of vacations) {
      const f = v.from ? new Date(v.from + 'T00:00:00') : new Date(yr, mo - 1, 1);
      const t = v.to ? new Date(v.to + 'T00:00:00') : new Date(yr, mo, 0);
      if (dateObj.getTime() >= f.getTime() && dateObj.getTime() <= t.getTime()) {
        vacNamesOnDate.push(v.name.toUpperCase());
      }
    }
    const vacSet = new Set(vacNamesOnDate);

    // Compute staffing per hour-block — uses ORIG dispatchers only, no hypotheticals
    const hourlyStaffing = [];
    for (let bi = 0; bi < BLOCKS.length; bi++) {
      const block = BLOCKS[bi];
      let current = 0;
      for (let i = 0; i < ORIG_DISPATCHERS.length; i++) {
        if (vacSet.has(ORIG_DISPATCHERS[i].name.toUpperCase())) continue;
        if (shiftCoversBlock(ORIG_DISPATCHERS[i].schedule[day], block)) current++;
      }
      const needed = getNeededForBlock(day, block);
      hourlyStaffing.push({ current, needed, delta: current - needed });
    }

    // Aggregate into 4-hour OT blocks
    const dateBlocks = [];
    let dateTotalOT = 0;
    for (let obi = 0; obi < OT_BLOCKS.length; obi++) {
      const ob = OT_BLOCKS[obi];
      let maxShort = 0;
      for (const bi of ob.blockIdxs) {
        if (hourlyStaffing[bi].delta < 0) {
          maxShort = Math.max(maxShort, Math.abs(hourlyStaffing[bi].delta));
        }
      }
      // Subtract CT + OT coverage
      const ctKey = date + '-' + obi;
      const ctCount = (_ctAssignments[ctKey] || []).length;
      const otCount = (_otAssignments[ctKey] || []).length;
      maxShort = Math.max(0, maxShort - ctCount - otCount);
      if (maxShort > 0) {
        dateBlocks.push({ label: ob.label, need: maxShort });
        dateTotalOT += maxShort;
      }
    }

    if (dateBlocks.length > 0) {
      const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      const dayName = dayNames[dateObj.getDay()];
      const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;
      results.push({
        date,
        dayName,
        isWeekend,
        dateStr: String(mo).padStart(2,'0') + '/' + String(date).padStart(2,'0'),
        blocks: dateBlocks,
        totalOT: dateTotalOT,
        vacNames: [...vacSet].sort()
      });
    }
  }
  return results;
}

function computeMonthlyStaffing() {
  const [yr, mo] = currentMonth.split('-').map(Number);
  const daysInMonth = new Date(yr, mo, 0).getDate();
  const jsDay2idx = { 0:6, 1:0, 2:1, 3:2, 4:3, 5:4, 6:5 };
  const result = [];

  for (let date = 1; date <= daysInMonth; date++) {
    const dateObj = new Date(yr, mo - 1, date);
    const dow = dateObj.getDay();
    const dayIdx = jsDay2idx[dow];
    const day = DAYS[dayIdx];

    // Vacations for this specific date
    const vacNamesOnDate = [];
    for (const v of vacations) {
      const f = v.from ? new Date(v.from + 'T00:00:00') : new Date(yr, mo - 1, 1);
      const t = v.to ? new Date(v.to + 'T00:00:00') : new Date(yr, mo, 0);
      if (dateObj.getTime() >= f.getTime() && dateObj.getTime() <= t.getTime()) {
        vacNamesOnDate.push(v.name.toUpperCase());
      }
    }
    const vacSet = new Set(vacNamesOnDate);

    // Compute per-hour: who is working + needed count
    const hourlyNames = [];
    const hourlyNeeded = [];
    for (let bi = 0; bi < BLOCKS.length; bi++) {
      const block = BLOCKS[bi];
      const names = [];
      for (let i = 0; i < ORIG_DISPATCHERS.length; i++) {
        if (vacSet.has(ORIG_DISPATCHERS[i].name.toUpperCase())) continue;
        if (shiftCoversBlock(ORIG_DISPATCHERS[i].schedule[day], block)) {
          names.push({ name: ORIG_DISPATCHERS[i].name, isLead: ORIG_DISPATCHERS[i].isLead });
        }
      }
      hourlyNames.push(names);
      hourlyNeeded.push(getNeededForBlock(day, block));
    }

    // Aggregate into 4-hour OT blocks: use first hour of each block for names/needed
    const blocks = [];
    for (let obi = 0; obi < OT_BLOCKS.length; obi++) {
      const ob = OT_BLOCKS[obi];
      // Use the first hour-block index to get the representative names
      const repIdx = ob.blockIdxs[0];
      const names = hourlyNames[repIdx];
      const needed = hourlyNeeded[repIdx];
      // Also compute max shortfall across all hours in this OT block
      let maxShort = 0;
      for (const bi of ob.blockIdxs) {
        const delta = hourlyNames[bi].length - hourlyNeeded[bi];
        if (delta < 0) maxShort = Math.max(maxShort, Math.abs(delta));
      }
      names.sort((a, b) => {
        if (a.isLead !== b.isLead) return a.isLead ? -1 : 1;
        return a.name.localeCompare(b.name);
      });
      // CT dispatchers from RotationOps
      const ctKey = date + '-' + obi;
      const ctNames = (_ctAssignments[ctKey] || []).slice();
      // OT manually assigned
      const otNames = (_otAssignments[ctKey] || []).slice();
      // Reduce otNeed by CT + OT coverage
      const adjustedOtNeed = Math.max(0, maxShort - ctNames.length - otNames.length);
      blocks.push({ label: ob.label, names, needed, current: names.length, otNeed: adjustedOtNeed, delta: names.length - needed, ctNames, otNames });
    }

    result.push({ date, dow, vacNames: [...vacSet].sort(), blocks });
  }
  return result;
}

function renderMonthlyOTView() {
  const wrap = document.getElementById('otMonthView');
  if (!wrap) return;

  const [yr, mo] = currentMonth.split('-').map(Number);
  const MONTHS = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
  const today = new Date();
  const todayDate = (today.getFullYear() === yr && today.getMonth() === mo - 1) ? today.getDate() : -1;
  const DOW_LABELS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  const roleLabel = ROLE_CONFIG[currentRole].label;
  const roleSingular = roleLabel.replace(/S$/, '');

  const isDispatcher = currentRole === 'DISPATCHER';
  const monthly = isDispatcher ? computeMonthlyFromRotation() : computeMonthlyStaffing();
  let grandTotal = 0, daysWithOT = 0;
  if (!isDispatcher) {
    const needs = computeOTNeeds();
    for (const d of needs) { grandTotal += d.totalOT; daysWithOT++; }
  } else {
    for (const d of monthly) { for (const b of d.blocks) { if (b.otNeed > 0) { grandTotal += b.otNeed; } } if (d.blocks.some(b => b.otNeed > 0)) daysWithOT++; }
  }

  const colsPerDay = 6;

  // Build a stable color map for all employees — soft pastels
  const NAME_COLORS = [
    'rgba(245,158,11,.25)',
    'rgba(16,185,129,.25)',
    'rgba(59,130,246,.25)',
    'rgba(239,68,68,.25)',
    'rgba(168,85,247,.25)',
    'rgba(14,165,233,.25)',
    'rgba(244,63,94,.25)',
    'rgba(34,197,94,.25)',
    'rgba(250,204,21,.25)',
    'rgba(99,102,241,.25)',
    'rgba(236,72,153,.25)',
    'rgba(20,184,166,.25)',
  ];
  const nameColorMap = {};
  let colorIdx = 0;
  for (const emp of ORIG_DISPATCHERS) {
    if (!nameColorMap[emp.name]) {
      nameColorMap[emp.name] = NAME_COLORS[colorIdx % NAME_COLORS.length];
      colorIdx++;
    }
  }
  // Also assign colors for CT dispatchers and OT assignees
  for (const d of monthly) {
    for (const b of d.blocks) {
      for (const n of (b.ctNames || [])) { if (!nameColorMap[n]) { nameColorMap[n] = NAME_COLORS[colorIdx % NAME_COLORS.length]; colorIdx++; } }
      for (const n of (b.otNames || [])) { if (!nameColorMap[n]) { nameColorMap[n] = NAME_COLORS[colorIdx % NAME_COLORS.length]; colorIdx++; } }
    }
  }

  // Day border style — thicker border between every 2 days
  function dayBorder(dateIdx) {
    return dateIdx % 2 === 0 ? 'border-left:3px solid rgba(255,255,255,.2);' : '';
  }

  // Header
  let html = '<div class="ot-month-hdr">';
  html += '<span class="ot-month-title">' + roleLabel + ' — ' + MONTHS[mo - 1] + ' ' + yr + '</span>';
  if (!isDispatcher) {
    html += '<button class="btn" id="btnExportOT" style="font-size:10px;padding:5px 14px;background:rgba(220,38,38,.15);color:#ef4444;border-color:rgba(220,38,38,.3)">EXPORT OT NEEDS</button>';
  }
  html += '</div>';

  if (isDispatcher) {
    html += '<div class="ot-month-summary" style="color:var(--muted)">Read-only — from RotationOps' + (grandTotal > 0 ? ' &mdash; ' + grandTotal + ' unfilled slot' + (grandTotal !== 1 ? 's' : '') : '') + '</div>';
  } else if (grandTotal > 0) {
    html += '<div class="ot-month-summary">' + grandTotal + ' total OT slot' + (grandTotal !== 1 ? 's' : '') + ' needed across ' + daysWithOT + ' day' + (daysWithOT !== 1 ? 's' : '') + '</div>';
  } else {
    html += '<div class="ot-month-summary" style="color:#22c55e">No overtime needed — adequate staffing all month</div>';
  }

  // Month roster table
  html += '<div class="ot-scroll-x">';
  html += '<table class="ot-roster-tbl">';

  // Row 1: Date headers spanning all 6 blocks each
  html += '<thead><tr><th class="sticky-col" rowspan="2">STAFF</th>';
  for (let di = 0; di < monthly.length; di++) {
    const d = monthly[di];
    const isWknd = d.dow === 0 || d.dow === 6;
    const isTdy = d.date === todayDate;
    html += '<th class="dayhead' + (isWknd ? ' weekend' : '') + (isTdy ? ' today' : '') + '" colspan="' + colsPerDay + '" style="' + dayBorder(di) + '">' + DOW_LABELS[d.dow] + ' ' + mo + '/' + d.date + '</th>';
  }
  html += '</tr>';

  // Row 2: Block sub-headers (all 6 per day)
  html += '<tr>';
  for (let di = 0; di < monthly.length; di++) {
    for (let bi = 0; bi < OT_BLOCKS.length; bi++) {
      const db = (bi === 0) ? dayBorder(di) : '';
      html += '<th class="subhead" style="' + db + '">' + OT_BLOCKS[bi].label + '</th>';
    }
  }
  html += '</tr></thead><tbody>';

  // Single STAFF data row — all 6 blocks per day
  html += '<tr><td class="sticky-col">' + roleLabel + '</td>';
  for (let di = 0; di < monthly.length; di++) {
    const d = monthly[di];
    for (let bi = 0; bi < 6; bi++) {
      const b = d.blocks[bi];
      const db = (bi === 0) ? dayBorder(di) : '';
      html += '<td style="' + db + '">';
      let count = 0;
      // 1. Regular calltaker names
      for (const p of b.names) {
        count++;
        const bg = nameColorMap[p.name] || 'rgba(255,255,255,.08)';
        html += '<div class="ot-name" style="background:' + bg + '"><span class="ot-num">' + count + '</span>' + esc(p.name) + '</div>';
      }
      // 2. DISP IN CT names (blue badge)
      for (const cn of (b.ctNames || [])) {
        count++;
        const bg = nameColorMap[cn] || 'rgba(255,255,255,.08)';
        html += '<div class="ot-name" style="background:' + bg + '"><span class="ot-num">' + count + '</span>' + esc(cn) + '<span class="ct-badge">DISP IN CT</span></div>';
      }
      // 3. OT-assigned names (red badge — click to remove, read-only for DISPATCHER)
      for (const on of (b.otNames || [])) {
        count++;
        const bg = nameColorMap[on] || 'rgba(255,255,255,.08)';
        if (isDispatcher) {
          html += '<div class="ot-name" style="background:' + bg + '"><span class="ot-num">' + count + '</span>' + esc(on) + '<span class="ot-badge">OT</span></div>';
        } else {
          html += '<div class="ot-name" style="background:' + bg + ';cursor:pointer" onclick="removeOTAssign(\'' + esc(on).replace(/'/g, "\\'") + '\',' + d.date + ',' + bi + ')" title="Click to remove"><span class="ot-num">' + count + '</span>' + esc(on) + '<span class="ot-badge">OT</span></div>';
        }
      }
      // 4. Remaining NEEDED badges (clickable for CT/PIC, read-only for DISPATCHER)
      for (let n = 0; n < b.otNeed; n++) {
        count++;
        if (isDispatcher) {
          html += '<div class="ot-name needed"><span class="ot-num">' + count + '</span>' + roleSingular + ' NEEDED</div>';
        } else {
          html += '<div class="ot-name needed" style="cursor:pointer" onclick="openOTAssignBox(' + d.date + ',' + bi + ')"><span class="ot-num">' + count + '</span>' + roleSingular + ' NEEDED</div>';
        }
      }
      // 5. Block status summary
      const totalFilled = b.names.length + (b.ctNames||[]).length + (b.otNames||[]).length;
      const over = totalFilled - b.needed;
      if (b.otNeed > 0) {
        html += '<div style="text-align:center;font-size:9px;font-weight:900;color:#ef4444;padding:4px 0;letter-spacing:.5px;border-top:1px solid rgba(220,38,38,.2);margin-top:3px">NEED ' + b.otNeed + '</div>';
      } else if (over > 0) {
        html += '<div style="text-align:center;font-size:9px;font-weight:900;color:#818cf8;padding:4px 0;letter-spacing:.5px;border-top:1px solid rgba(129,140,248,.2);margin-top:3px">OVER +' + over + '</div>';
      } else {
        html += '<div style="text-align:center;font-size:9px;font-weight:900;color:#22c55e;padding:4px 0;letter-spacing:.5px;border-top:1px solid rgba(34,197,94,.2);margin-top:3px">FULL STAFFED</div>';
      }
      html += '</td>';
    }
  }
  html += '</tr>';

  // VACATION row — spans all 6 sub-columns per day
  html += '<tr><td class="sticky-col" style="color:#7dd3fc">VACATION</td>';
  for (let di = 0; di < monthly.length; di++) {
    const d = monthly[di];
    html += '<td colspan="' + colsPerDay + '" style="' + dayBorder(di) + '">';
    for (const vn of d.vacNames) {
      html += '<div class="ot-name vac">' + esc(vn) + '</div>';
    }
    if (!d.vacNames.length) html += '<span style="color:var(--muted);font-size:9px">&mdash;</span>';
    html += '</td>';
  }
  html += '</tr>';

  html += '</tbody></table>';
  html += '</div>';

  wrap.innerHTML = html;

  // Wire export button
  const btn = document.getElementById('btnExportOT');
  if (btn) btn.addEventListener('click', exportOTNeedsXlsx);
}

// ========== OT EXPORT (Teams XLSX) ==========
const _OT_BLOCK_TIME_MAP = {
  '6A-10A':  { key:'0600-1000', startTime:'06:00', endTime:'10:00', nextDay:false },
  '10A-2P':  { key:'1000-1400', startTime:'10:00', endTime:'14:00', nextDay:false },
  '2P-6P':   { key:'1400-1800', startTime:'14:00', endTime:'18:00', nextDay:false },
  '6P-10P':  { key:'1800-2200', startTime:'18:00', endTime:'22:00', nextDay:false },
  '10P-2A':  { key:'2200-0200', startTime:'22:00', endTime:'02:00', nextDay:true },
  '2A-6A':   { key:'0200-0600', startTime:'02:00', endTime:'06:00', nextDay:false, startNextDay:true }
};
const _TEMPLATE_B64 = "UEsDBBQAAAAAAAAAAAA+HACiIAcAACAHAAAaAAAAeGwvX3JlbHMvd29ya2Jvb2sueG1sLnJlbHM8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJVVEYtOCIgc3RhbmRhbG9uZT0ieWVzIj8+DQo8UmVsYXRpb25zaGlwcyB4bWxucz0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL3BhY2thZ2UvMjAwNi9yZWxhdGlvbnNoaXBzIj48UmVsYXRpb25zaGlwIElkPSJySWQxIiBUeXBlPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzL3dvcmtzaGVldCIgVGFyZ2V0PSJ3b3Jrc2hlZXRzL3NoZWV0MS54bWwiLz48UmVsYXRpb25zaGlwIElkPSJySWQyIiBUeXBlPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzL3dvcmtzaGVldCIgVGFyZ2V0PSJ3b3Jrc2hlZXRzL3NoZWV0Mi54bWwiLz48UmVsYXRpb25zaGlwIElkPSJySWQzIiBUeXBlPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzL3dvcmtzaGVldCIgVGFyZ2V0PSJ3b3Jrc2hlZXRzL3NoZWV0My54bWwiLz48UmVsYXRpb25zaGlwIElkPSJySWQ0IiBUeXBlPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzL3dvcmtzaGVldCIgVGFyZ2V0PSJ3b3Jrc2hlZXRzL3NoZWV0NC54bWwiLz48UmVsYXRpb25zaGlwIElkPSJySWQ1IiBUeXBlPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzL3dvcmtzaGVldCIgVGFyZ2V0PSJ3b3Jrc2hlZXRzL3NoZWV0NS54bWwiLz48UmVsYXRpb25zaGlwIElkPSJySWQ2IiBUeXBlPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzL3dvcmtzaGVldCIgVGFyZ2V0PSJ3b3Jrc2hlZXRzL3NoZWV0Ni54bWwiLz48UmVsYXRpb25zaGlwIElkPSJySWQ3IiBUeXBlPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzL3dvcmtzaGVldCIgVGFyZ2V0PSJ3b3Jrc2hlZXRzL3NoZWV0Ny54bWwiLz48UmVsYXRpb25zaGlwIElkPSJySWQ4IiBUeXBlPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzL3dvcmtzaGVldCIgVGFyZ2V0PSJ3b3Jrc2hlZXRzL3NoZWV0OC54bWwiLz48UmVsYXRpb25zaGlwIElkPSJySWQ5IiBUeXBlPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzL3dvcmtzaGVldCIgVGFyZ2V0PSJ3b3Jrc2hlZXRzL3NoZWV0OS54bWwiLz48UmVsYXRpb25zaGlwIElkPSJySWQxMCIgVHlwZT0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL29mZmljZURvY3VtZW50LzIwMDYvcmVsYXRpb25zaGlwcy90aGVtZSIgVGFyZ2V0PSJ0aGVtZS90aGVtZTEueG1sIi8+PFJlbGF0aW9uc2hpcCBJZD0icklkMTEiIFR5cGU9Imh0dHA6Ly9zY2hlbWFzLm9wZW54bWxmb3JtYXRzLm9yZy9vZmZpY2VEb2N1bWVudC8yMDA2L3JlbGF0aW9uc2hpcHMvc3R5bGVzIiBUYXJnZXQ9InN0eWxlcy54bWwiLz48UmVsYXRpb25zaGlwIElkPSJySWQxMiIgVHlwZT0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL29mZmljZURvY3VtZW50LzIwMDYvcmVsYXRpb25zaGlwcy9zaGVldE1ldGFkYXRhIiBUYXJnZXQ9Im1ldGFkYXRhLnhtbCIvPjwvUmVsYXRpb25zaGlwcz5QSwMEFAAAAAAAAAAAAOyRzqO5GwAAuRsAABMAAAB4bC90aGVtZS90aGVtZTEueG1sPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/Pg0KPGE6dGhlbWUgeG1sbnM6YT0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL2RyYXdpbmdtbC8yMDA2L21haW4iIG5hbWU9Ik9mZmljZSBUaGVtZSI+PGE6dGhlbWVFbGVtZW50cz48YTpjbHJTY2hlbWUgbmFtZT0iT2ZmaWNlIj48YTpkazE+PGE6c3lzQ2xyIHZhbD0id2luZG93VGV4dCIgbGFzdENscj0iMDAwMDAwIi8+PC9hOmRrMT48YTpsdDE+PGE6c3lzQ2xyIHZhbD0id2luZG93IiBsYXN0Q2xyPSJGRkZGRkYiLz48L2E6bHQxPjxhOmRrMj48YTpzcmdiQ2xyIHZhbD0iMUY0OTdEIi8+PC9hOmRrMj48YTpsdDI+PGE6c3JnYkNsciB2YWw9IkVFRUNFMSIvPjwvYTpsdDI+PGE6YWNjZW50MT48YTpzcmdiQ2xyIHZhbD0iNEY4MUJEIi8+PC9hOmFjY2VudDE+PGE6YWNjZW50Mj48YTpzcmdiQ2xyIHZhbD0iQzA1MDREIi8+PC9hOmFjY2VudDI+PGE6YWNjZW50Mz48YTpzcmdiQ2xyIHZhbD0iOUJCQjU5Ii8+PC9hOmFjY2VudDM+PGE6YWNjZW50ND48YTpzcmdiQ2xyIHZhbD0iODA2NEEyIi8+PC9hOmFjY2VudDQ+PGE6YWNjZW50NT48YTpzcmdiQ2xyIHZhbD0iNEJBQ0M2Ii8+PC9hOmFjY2VudDU+PGE6YWNjZW50Nj48YTpzcmdiQ2xyIHZhbD0iRjc5NjQ2Ii8+PC9hOmFjY2VudDY+PGE6aGxpbms+PGE6c3JnYkNsciB2YWw9IjAwMDBGRiIvPjwvYTpobGluaz48YTpmb2xIbGluaz48YTpzcmdiQ2xyIHZhbD0iODAwMDgwIi8+PC9hOmZvbEhsaW5rPjwvYTpjbHJTY2hlbWU+PGE6Zm9udFNjaGVtZSBuYW1lPSJPZmZpY2UiPjxhOm1ham9yRm9udD48YTpsYXRpbiB0eXBlZmFjZT0iQ2FtYnJpYSIvPjxhOmVhIHR5cGVmYWNlPSIiLz48YTpjcyB0eXBlZmFjZT0iIi8+PGE6Zm9udCBzY3JpcHQ9IkpwYW4iIHR5cGVmYWNlPSLDr8K8wq3Dr8K8wrMgw6/CvMKww6PCgsK0w6PCgsK3w6PCg8KDw6PCgsKvIi8+PGE6Zm9udCBzY3JpcHQ9IkhhbmciIHR5cGVmYWNlPSLDq8KnwpHDrMKdwoAgw6rCs8Kgw6vClMKVIi8+PGE6Zm9udCBzY3JpcHQ9IkhhbnMiIHR5cGVmYWNlPSLDpcKuwovDpMK9wpMiLz48YTpmb250IHNjcmlwdD0iSGFudCIgdHlwZWZhY2U9IsOmwpbCsMOnwrTCsMOmwpjCjsOpwqvClCIvPjxhOmZvbnQgc2NyaXB0PSJBcmFiIiB0eXBlZmFjZT0iVGltZXMgTmV3IFJvbWFuIi8+PGE6Zm9udCBzY3JpcHQ9IkhlYnIiIHR5cGVmYWNlPSJUaW1lcyBOZXcgUm9tYW4iLz48YTpmb250IHNjcmlwdD0iVGhhaSIgdHlwZWZhY2U9IlRhaG9tYSIvPjxhOmZvbnQgc2NyaXB0PSJFdGhpIiB0eXBlZmFjZT0iTnlhbGEiLz48YTpmb250IHNjcmlwdD0iQmVuZyIgdHlwZWZhY2U9IlZyaW5kYSIvPjxhOmZvbnQgc2NyaXB0PSJHdWpyIiB0eXBlZmFjZT0iU2hydXRpIi8+PGE6Zm9udCBzY3JpcHQ9IktobXIiIHR5cGVmYWNlPSJNb29sQm9yYW4iLz48YTpmb250IHNjcmlwdD0iS25kYSIgdHlwZWZhY2U9IlR1bmdhIi8+PGE6Zm9udCBzY3JpcHQ9Ikd1cnUiIHR5cGVmYWNlPSJSYWF2aSIvPjxhOmZvbnQgc2NyaXB0PSJDYW5zIiB0eXBlZmFjZT0iRXVwaGVtaWEiLz48YTpmb250IHNjcmlwdD0iQ2hlciIgdHlwZWZhY2U9IlBsYW50YWdlbmV0IENoZXJva2VlIi8+PGE6Zm9udCBzY3JpcHQ9IllpaWkiIHR5cGVmYWNlPSJNaWNyb3NvZnQgWWkgQmFpdGkiLz48YTpmb250IHNjcmlwdD0iVGlidCIgdHlwZWZhY2U9Ik1pY3Jvc29mdCBIaW1hbGF5YSIvPjxhOmZvbnQgc2NyaXB0PSJUaGFhIiB0eXBlZmFjZT0iTVYgQm9saSIvPjxhOmZvbnQgc2NyaXB0PSJEZXZhIiB0eXBlZmFjZT0iTWFuZ2FsIi8+PGE6Zm9udCBzY3JpcHQ9IlRlbHUiIHR5cGVmYWNlPSJHYXV0YW1pIi8+PGE6Zm9udCBzY3JpcHQ9IlRhbWwiIHR5cGVmYWNlPSJMYXRoYSIvPjxhOmZvbnQgc2NyaXB0PSJTeXJjIiB0eXBlZmFjZT0iRXN0cmFuZ2VsbyBFZGVzc2EiLz48YTpmb250IHNjcmlwdD0iT3J5YSIgdHlwZWZhY2U9IkthbGluZ2EiLz48YTpmb250IHNjcmlwdD0iTWx5bSIgdHlwZWZhY2U9IkthcnRpa2EiLz48YTpmb250IHNjcmlwdD0iTGFvbyIgdHlwZWZhY2U9IkRva0NoYW1wYSIvPjxhOmZvbnQgc2NyaXB0PSJTaW5oIiB0eXBlZmFjZT0iSXNrb29sYSBQb3RhIi8+PGE6Zm9udCBzY3JpcHQ9Ik1vbmciIHR5cGVmYWNlPSJNb25nb2xpYW4gQmFpdGkiLz48YTpmb250IHNjcmlwdD0iVmlldCIgdHlwZWZhY2U9IlRpbWVzIE5ldyBSb21hbiIvPjxhOmZvbnQgc2NyaXB0PSJVaWdoIiB0eXBlZmFjZT0iTWljcm9zb2Z0IFVpZ2h1ciIvPjwvYTptYWpvckZvbnQ+PGE6bWlub3JGb250PjxhOmxhdGluIHR5cGVmYWNlPSJDYWxpYnJpIi8+PGE6ZWEgdHlwZWZhY2U9IiIvPjxhOmNzIHR5cGVmYWNlPSIiLz48YTpmb250IHNjcmlwdD0iSnBhbiIgdHlwZWZhY2U9IsOvwrzCrcOvwrzCsyDDr8K8wrDDo8KCwrTDo8KCwrfDo8KDwoPDo8KCwq8iLz48YTpmb250IHNjcmlwdD0iSGFuZyIgdHlwZWZhY2U9IsOrwqfCkcOswp3CgCDDqsKzwqDDq8KUwpUiLz48YTpmb250IHNjcmlwdD0iSGFucyIgdHlwZWZhY2U9IsOlwq7Ci8Okwr3CkyIvPjxhOmZvbnQgc2NyaXB0PSJIYW50IiB0eXBlZmFjZT0iw6bClsKww6fCtMKww6bCmMKOw6nCq8KUIi8+PGE6Zm9udCBzY3JpcHQ9IkFyYWIiIHR5cGVmYWNlPSJBcmlhbCIvPjxhOmZvbnQgc2NyaXB0PSJIZWJyIiB0eXBlZmFjZT0iQXJpYWwiLz48YTpmb250IHNjcmlwdD0iVGhhaSIgdHlwZWZhY2U9IlRhaG9tYSIvPjxhOmZvbnQgc2NyaXB0PSJFdGhpIiB0eXBlZmFjZT0iTnlhbGEiLz48YTpmb250IHNjcmlwdD0iQmVuZyIgdHlwZWZhY2U9IlZyaW5kYSIvPjxhOmZvbnQgc2NyaXB0PSJHdWpyIiB0eXBlZmFjZT0iU2hydXRpIi8+PGE6Zm9udCBzY3JpcHQ9IktobXIiIHR5cGVmYWNlPSJEYXVuUGVuaCIvPjxhOmZvbnQgc2NyaXB0PSJLbmRhIiB0eXBlZmFjZT0iVHVuZ2EiLz48YTpmb250IHNjcmlwdD0iR3VydSIgdHlwZWZhY2U9IlJhYXZpIi8+PGE6Zm9udCBzY3JpcHQ9IkNhbnMiIHR5cGVmYWNlPSJFdXBoZW1pYSIvPjxhOmZvbnQgc2NyaXB0PSJDaGVyIiB0eXBlZmFjZT0iUGxhbnRhZ2VuZXQgQ2hlcm9rZWUiLz48YTpmb250IHNjcmlwdD0iWWlpaSIgdHlwZWZhY2U9Ik1pY3Jvc29mdCBZaSBCYWl0aSIvPjxhOmZvbnQgc2NyaXB0PSJUaWJ0IiB0eXBlZmFjZT0iTWljcm9zb2Z0IEhpbWFsYXlhIi8+PGE6Zm9udCBzY3JpcHQ9IlRoYWEiIHR5cGVmYWNlPSJNViBCb2xpIi8+PGE6Zm9udCBzY3JpcHQ9IkRldmEiIHR5cGVmYWNlPSJNYW5nYWwiLz48YTpmb250IHNjcmlwdD0iVGVsdSIgdHlwZWZhY2U9IkdhdXRhbWkiLz48YTpmb250IHNjcmlwdD0iVGFtbCIgdHlwZWZhY2U9IkxhdGhhIi8+PGE6Zm9udCBzY3JpcHQ9IlN5cmMiIHR5cGVmYWNlPSJFc3RyYW5nZWxvIEVkZXNzYSIvPjxhOmZvbnQgc2NyaXB0PSJPcnlhIiB0eXBlZmFjZT0iS2FsaW5nYSIvPjxhOmZvbnQgc2NyaXB0PSJNbHltIiB0eXBlZmFjZT0iS2FydGlrYSIvPjxhOmZvbnQgc2NyaXB0PSJMYW9vIiB0eXBlZmFjZT0iRG9rQ2hhbXBhIi8+PGE6Zm9udCBzY3JpcHQ9IlNpbmgiIHR5cGVmYWNlPSJJc2tvb2xhIFBvdGEiLz48YTpmb250IHNjcmlwdD0iTW9uZyIgdHlwZWZhY2U9Ik1vbmdvbGlhbiBCYWl0aSIvPjxhOmZvbnQgc2NyaXB0PSJWaWV0IiB0eXBlZmFjZT0iQXJpYWwiLz48YTpmb250IHNjcmlwdD0iVWlnaCIgdHlwZWZhY2U9Ik1pY3Jvc29mdCBVaWdodXIiLz48L2E6bWlub3JGb250PjwvYTpmb250U2NoZW1lPjxhOmZtdFNjaGVtZSBuYW1lPSJPZmZpY2UiPjxhOmZpbGxTdHlsZUxzdD48YTpzb2xpZEZpbGw+PGE6c2NoZW1lQ2xyIHZhbD0icGhDbHIiLz48L2E6c29saWRGaWxsPjxhOmdyYWRGaWxsIHJvdFdpdGhTaGFwZT0iMSI+PGE6Z3NMc3Q+PGE6Z3MgcG9zPSIwIj48YTpzY2hlbWVDbHIgdmFsPSJwaENsciI+PGE6dGludCB2YWw9IjUwMDAwIi8+PGE6c2F0TW9kIHZhbD0iMzAwMDAwIi8+PC9hOnNjaGVtZUNscj48L2E6Z3M+PGE6Z3MgcG9zPSIzNTAwMCI+PGE6c2NoZW1lQ2xyIHZhbD0icGhDbHIiPjxhOnRpbnQgdmFsPSIzNzAwMCIvPjxhOnNhdE1vZCB2YWw9IjMwMDAwMCIvPjwvYTpzY2hlbWVDbHI+PC9hOmdzPjxhOmdzIHBvcz0iMTAwMDAwIj48YTpzY2hlbWVDbHIgdmFsPSJwaENsciI+PGE6dGludCB2YWw9IjE1MDAwIi8+PGE6c2F0TW9kIHZhbD0iMzUwMDAwIi8+PC9hOnNjaGVtZUNscj48L2E6Z3M+PC9hOmdzTHN0PjxhOmxpbiBhbmc9IjE2MjAwMDAwIiBzY2FsZWQ9IjEiLz48L2E6Z3JhZEZpbGw+PGE6Z3JhZEZpbGwgcm90V2l0aFNoYXBlPSIxIj48YTpnc0xzdD48YTpncyBwb3M9IjAiPjxhOnNjaGVtZUNsciB2YWw9InBoQ2xyIj48YTpzaGFkZSB2YWw9IjUxMDAwIi8+PGE6c2F0TW9kIHZhbD0iMTMwMDAwIi8+PC9hOnNjaGVtZUNscj48L2E6Z3M+PGE6Z3MgcG9zPSI4MDAwMCI+PGE6c2NoZW1lQ2xyIHZhbD0icGhDbHIiPjxhOnNoYWRlIHZhbD0iOTMwMDAiLz48YTpzYXRNb2QgdmFsPSIxMzAwMDAiLz48L2E6c2NoZW1lQ2xyPjwvYTpncz48YTpncyBwb3M9IjEwMDAwMCI+PGE6c2NoZW1lQ2xyIHZhbD0icGhDbHIiPjxhOnNoYWRlIHZhbD0iOTQwMDAiLz48YTpzYXRNb2QgdmFsPSIxMzUwMDAiLz48L2E6c2NoZW1lQ2xyPjwvYTpncz48L2E6Z3NMc3Q+PGE6bGluIGFuZz0iMTYyMDAwMDAiIHNjYWxlZD0iMCIvPjwvYTpncmFkRmlsbD48L2E6ZmlsbFN0eWxlTHN0PjxhOmxuU3R5bGVMc3Q+PGE6bG4gdz0iOTUyNSIgY2FwPSJmbGF0IiBjbXBkPSJzbmciIGFsZ249ImN0ciI+PGE6c29saWRGaWxsPjxhOnNjaGVtZUNsciB2YWw9InBoQ2xyIj48YTpzaGFkZSB2YWw9Ijk1MDAwIi8+PGE6c2F0TW9kIHZhbD0iMTA1MDAwIi8+PC9hOnNjaGVtZUNscj48L2E6c29saWRGaWxsPjxhOnByc3REYXNoIHZhbD0ic29saWQiLz48L2E6bG4+PGE6bG4gdz0iMjU0MDAiIGNhcD0iZmxhdCIgY21wZD0ic25nIiBhbGduPSJjdHIiPjxhOnNvbGlkRmlsbD48YTpzY2hlbWVDbHIgdmFsPSJwaENsciIvPjwvYTpzb2xpZEZpbGw+PGE6cHJzdERhc2ggdmFsPSJzb2xpZCIvPjwvYTpsbj48YTpsbiB3PSIzODEwMCIgY2FwPSJmbGF0IiBjbXBkPSJzbmciIGFsZ249ImN0ciI+PGE6c29saWRGaWxsPjxhOnNjaGVtZUNsciB2YWw9InBoQ2xyIi8+PC9hOnNvbGlkRmlsbD48YTpwcnN0RGFzaCB2YWw9InNvbGlkIi8+PC9hOmxuPjwvYTpsblN0eWxlTHN0PjxhOmVmZmVjdFN0eWxlTHN0PjxhOmVmZmVjdFN0eWxlPjxhOmVmZmVjdExzdD48YTpvdXRlclNoZHcgYmx1clJhZD0iNDAwMDAiIGRpc3Q9IjIwMDAwIiBkaXI9IjU0MDAwMDAiIHJvdFdpdGhTaGFwZT0iMCI+PGE6c3JnYkNsciB2YWw9IjAwMDAwMCI+PGE6YWxwaGEgdmFsPSIzODAwMCIvPjwvYTpzcmdiQ2xyPjwvYTpvdXRlclNoZHc+PC9hOmVmZmVjdExzdD48L2E6ZWZmZWN0U3R5bGU+PGE6ZWZmZWN0U3R5bGU+PGE6ZWZmZWN0THN0PjxhOm91dGVyU2hkdyBibHVyUmFkPSI0MDAwMCIgZGlzdD0iMjMwMDAiIGRpcj0iNTQwMDAwMCIgcm90V2l0aFNoYXBlPSIwIj48YTpzcmdiQ2xyIHZhbD0iMDAwMDAwIj48YTphbHBoYSB2YWw9IjM1MDAwIi8+PC9hOnNyZ2JDbHI+PC9hOm91dGVyU2hkdz48L2E6ZWZmZWN0THN0PjwvYTplZmZlY3RTdHlsZT48YTplZmZlY3RTdHlsZT48YTplZmZlY3RMc3Q+PGE6b3V0ZXJTaGR3IGJsdXJSYWQ9IjQwMDAwIiBkaXN0PSIyMzAwMCIgZGlyPSI1NDAwMDAwIiByb3RXaXRoU2hhcGU9IjAiPjxhOnNyZ2JDbHIgdmFsPSIwMDAwMDAiPjxhOmFscGhhIHZhbD0iMzUwMDAiLz48L2E6c3JnYkNscj48L2E6b3V0ZXJTaGR3PjwvYTplZmZlY3RMc3Q+PGE6c2NlbmUzZD48YTpjYW1lcmEgcHJzdD0ib3J0aG9ncmFwaGljRnJvbnQiPjxhOnJvdCBsYXQ9IjAiIGxvbj0iMCIgcmV2PSIwIi8+PC9hOmNhbWVyYT48YTpsaWdodFJpZyByaWc9InRocmVlUHQiIGRpcj0idCI+PGE6cm90IGxhdD0iMCIgbG9uPSIwIiByZXY9IjEyMDAwMDAiLz48L2E6bGlnaHRSaWc+PC9hOnNjZW5lM2Q+PGE6c3AzZD48YTpiZXZlbFQgdz0iNjM1MDAiIGg9IjI1NDAwIi8+PC9hOnNwM2Q+PC9hOmVmZmVjdFN0eWxlPjwvYTplZmZlY3RTdHlsZUxzdD48YTpiZ0ZpbGxTdHlsZUxzdD48YTpzb2xpZEZpbGw+PGE6c2NoZW1lQ2xyIHZhbD0icGhDbHIiLz48L2E6c29saWRGaWxsPjxhOmdyYWRGaWxsIHJvdFdpdGhTaGFwZT0iMSI+PGE6Z3NMc3Q+PGE6Z3MgcG9zPSIwIj48YTpzY2hlbWVDbHIgdmFsPSJwaENsciI+PGE6dGludCB2YWw9IjQwMDAwIi8+PGE6c2F0TW9kIHZhbD0iMzUwMDAwIi8+PC9hOnNjaGVtZUNscj48L2E6Z3M+PGE6Z3MgcG9zPSI0MDAwMCI+PGE6c2NoZW1lQ2xyIHZhbD0icGhDbHIiPjxhOnRpbnQgdmFsPSI0NTAwMCIvPjxhOnNoYWRlIHZhbD0iOTkwMDAiLz48YTpzYXRNb2QgdmFsPSIzNTAwMDAiLz48L2E6c2NoZW1lQ2xyPjwvYTpncz48YTpncyBwb3M9IjEwMDAwMCI+PGE6c2NoZW1lQ2xyIHZhbD0icGhDbHIiPjxhOnNoYWRlIHZhbD0iMjAwMDAiLz48YTpzYXRNb2QgdmFsPSIyNTUwMDAiLz48L2E6c2NoZW1lQ2xyPjwvYTpncz48L2E6Z3NMc3Q+PGE6cGF0aCBwYXRoPSJjaXJjbGUiPjxhOmZpbGxUb1JlY3QgbD0iNTAwMDAiIHQ9Ii04MDAwMCIgcj0iNTAwMDAiIGI9IjE4MDAwMCIvPjwvYTpwYXRoPjwvYTpncmFkRmlsbD48YTpncmFkRmlsbCByb3RXaXRoU2hhcGU9IjEiPjxhOmdzTHN0PjxhOmdzIHBvcz0iMCI+PGE6c2NoZW1lQ2xyIHZhbD0icGhDbHIiPjxhOnRpbnQgdmFsPSI4MDAwMCIvPjxhOnNhdE1vZCB2YWw9IjMwMDAwMCIvPjwvYTpzY2hlbWVDbHI+PC9hOmdzPjxhOmdzIHBvcz0iMTAwMDAwIj48YTpzY2hlbWVDbHIgdmFsPSJwaENsciI+PGE6c2hhZGUgdmFsPSIzMDAwMCIvPjxhOnNhdE1vZCB2YWw9IjIwMDAwMCIvPjwvYTpzY2hlbWVDbHI+PC9hOmdzPjwvYTpnc0xzdD48YTpwYXRoIHBhdGg9ImNpcmNsZSI+PGE6ZmlsbFRvUmVjdCBsPSI1MDAwMCIgdD0iNTAwMDAiIHI9IjUwMDAwIiBiPSI1MDAwMCIvPjwvYTpwYXRoPjwvYTpncmFkRmlsbD48L2E6YmdGaWxsU3R5bGVMc3Q+PC9hOmZtdFNjaGVtZT48L2E6dGhlbWVFbGVtZW50cz48YTpvYmplY3REZWZhdWx0cy8+PGE6ZXh0cmFDbHJTY2hlbWVMc3QvPjwvYTp0aGVtZT5QSwMEFAAAAAAAAAAAAFX0BJRaBAAAWgQAAA0AAAB4bC9zdHlsZXMueG1sPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/Pg0KPHN0eWxlU2hlZXQgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm9wZW54bWxmb3JtYXRzLm9yZy9zcHJlYWRzaGVldG1sLzIwMDYvbWFpbiIgeG1sbnM6dnQ9Imh0dHA6Ly9zY2hlbWFzLm9wZW54bWxmb3JtYXRzLm9yZy9vZmZpY2VEb2N1bWVudC8yMDA2L2RvY1Byb3BzVlR5cGVzIj48bnVtRm10cyBjb3VudD0iMSI+PG51bUZtdCBudW1GbXRJZD0iNTYiIGZvcm1hdENvZGU9IiZxdW90O+S4iuWNiC/kuIvljYggJnF1b3Q7aGgmcXVvdDvmmYImcXVvdDttbSZxdW90O+WIhiZxdW90O3NzJnF1b3Q756eSICZxdW90OyIvPjwvbnVtRm10cz48Zm9udHMgY291bnQ9IjEiPjxmb250PjxzeiB2YWw9IjEyIi8+PGNvbG9yIHRoZW1lPSIxIi8+PG5hbWUgdmFsPSJDYWxpYnJpIi8+PGZhbWlseSB2YWw9IjIiLz48c2NoZW1lIHZhbD0ibWlub3IiLz48L2ZvbnQ+PC9mb250cz48ZmlsbHMgY291bnQ9IjIiPjxmaWxsPjxwYXR0ZXJuRmlsbCBwYXR0ZXJuVHlwZT0ibm9uZSIvPjwvZmlsbD48ZmlsbD48cGF0dGVybkZpbGwgcGF0dGVyblR5cGU9ImdyYXkxMjUiLz48L2ZpbGw+PC9maWxscz48Ym9yZGVycyBjb3VudD0iMSI+PGJvcmRlcj48bGVmdC8+PHJpZ2h0Lz48dG9wLz48Ym90dG9tLz48ZGlhZ29uYWwvPjwvYm9yZGVyPjwvYm9yZGVycz48Y2VsbFN0eWxlWGZzIGNvdW50PSIxIj48eGYgbnVtRm10SWQ9IjAiIGZvbnRJZD0iMCIgZmlsbElkPSIwIiBib3JkZXJJZD0iMCIvPjwvY2VsbFN0eWxlWGZzPjxjZWxsWGZzIGNvdW50PSIxIj48eGYgbnVtRm10SWQ9IjAiIGZvbnRJZD0iMCIgZmlsbElkPSIwIiBib3JkZXJJZD0iMCIgeGZJZD0iMCIgYXBwbHlOdW1iZXJGb3JtYXQ9IjEiLz48L2NlbGxYZnM+PGNlbGxTdHlsZXMgY291bnQ9IjEiPjxjZWxsU3R5bGUgbmFtZT0iTm9ybWFsIiB4ZklkPSIwIiBidWlsdGluSWQ9IjAiLz48L2NlbGxTdHlsZXM+PGR4ZnMgY291bnQ9IjAiLz48dGFibGVTdHlsZXMgY291bnQ9IjAiIGRlZmF1bHRUYWJsZVN0eWxlPSJUYWJsZVN0eWxlTWVkaXVtOSIgZGVmYXVsdFBpdm90U3R5bGU9IlBpdm90U3R5bGVNZWRpdW00Ii8+PC9zdHlsZVNoZWV0PlBLAwQUAAAAAAAAAAAAp0uMyvEBAADxAQAAGAAAAHhsL3dvcmtzaGVldHMvc2hlZXQxLnhtbDw/eG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IlVURi04IiBzdGFuZGFsb25lPSJ5ZXMiPz4NCjx3b3Jrc2hlZXQgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm9wZW54bWxmb3JtYXRzLm9yZy9zcHJlYWRzaGVldG1sLzIwMDYvbWFpbiIgeG1sbnM6cj0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL29mZmljZURvY3VtZW50LzIwMDYvcmVsYXRpb25zaGlwcyI+PGRpbWVuc2lvbiByZWY9IkExIi8+PHNoZWV0Vmlld3M+PHNoZWV0VmlldyB3b3JrYm9va1ZpZXdJZD0iMCIgcmlnaHRUb0xlZnQ9IjAiLz48L3NoZWV0Vmlld3M+PHNoZWV0RGF0YS8+PHBhZ2VNYXJnaW5zIGxlZnQ9IjAuNyIgcmlnaHQ9IjAuNyIgdG9wPSIwLjc1IiBib3R0b209IjAuNzUiIGhlYWRlcj0iMC4zIiBmb290ZXI9IjAuMyIvPjxpZ25vcmVkRXJyb3JzPjxpZ25vcmVkRXJyb3IgbnVtYmVyU3RvcmVkQXNUZXh0PSIxIiBzcXJlZj0iQTEiLz48L2lnbm9yZWRFcnJvcnM+PC93b3Jrc2hlZXQ+UEsDBBQAAAAAAAAAAABeiJu7lS0AAJUtAAAYAAAAeGwvd29ya3NoZWV0cy9zaGVldDIueG1sPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/Pg0KPHdvcmtzaGVldCB4bWxucz0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL3NwcmVhZHNoZWV0bWwvMjAwNi9tYWluIiB4bWxuczpyPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzIj48ZGltZW5zaW9uIHJlZj0iQTE6QTI1NSIvPjxzaGVldFZpZXdzPjxzaGVldFZpZXcgd29ya2Jvb2tWaWV3SWQ9IjAiIHJpZ2h0VG9MZWZ0PSIwIi8+PC9zaGVldFZpZXdzPjxzaGVldERhdGE+PHJvdyByPSIxIj48YyByPSJBMSI+PHY+MTwvdj48L2M+PC9yb3c+PHJvdyByPSIyIj48YyByPSJBMiI+PHY+Mjwvdj48L2M+PC9yb3c+PHJvdyByPSIzIj48YyByPSJBMyI+PHY+Mzwvdj48L2M+PC9yb3c+PHJvdyByPSI0Ij48YyByPSJBNCI+PHY+NDwvdj48L2M+PC9yb3c+PHJvdyByPSI1Ij48YyByPSJBNSI+PHY+NTwvdj48L2M+PC9yb3c+PHJvdyByPSI2Ij48YyByPSJBNiI+PHY+Njwvdj48L2M+PC9yb3c+PHJvdyByPSI3Ij48YyByPSJBNyI+PHY+Nzwvdj48L2M+PC9yb3c+PHJvdyByPSI4Ij48YyByPSJBOCI+PHY+ODwvdj48L2M+PC9yb3c+PHJvdyByPSI5Ij48YyByPSJBOSI+PHY+OTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMCI+PGMgcj0iQTEwIj48dj4xMDwvdj48L2M+PC9yb3c+PHJvdyByPSIxMSI+PGMgcj0iQTExIj48dj4xMTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMiI+PGMgcj0iQTEyIj48dj4xMjwvdj48L2M+PC9yb3c+PHJvdyByPSIxMyI+PGMgcj0iQTEzIj48dj4xMzwvdj48L2M+PC9yb3c+PHJvdyByPSIxNCI+PGMgcj0iQTE0Ij48dj4xNDwvdj48L2M+PC9yb3c+PHJvdyByPSIxNSI+PGMgcj0iQTE1Ij48dj4xNTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNiI+PGMgcj0iQTE2Ij48dj4xNjwvdj48L2M+PC9yb3c+PHJvdyByPSIxNyI+PGMgcj0iQTE3Ij48dj4xNzwvdj48L2M+PC9yb3c+PHJvdyByPSIxOCI+PGMgcj0iQTE4Ij48dj4xODwvdj48L2M+PC9yb3c+PHJvdyByPSIxOSI+PGMgcj0iQTE5Ij48dj4xOTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMCI+PGMgcj0iQTIwIj48dj4yMDwvdj48L2M+PC9yb3c+PHJvdyByPSIyMSI+PGMgcj0iQTIxIj48dj4yMTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMiI+PGMgcj0iQTIyIj48dj4yMjwvdj48L2M+PC9yb3c+PHJvdyByPSIyMyI+PGMgcj0iQTIzIj48dj4yMzwvdj48L2M+PC9yb3c+PHJvdyByPSIyNCI+PGMgcj0iQTI0Ij48dj4yNDwvdj48L2M+PC9yb3c+PHJvdyByPSIyNSI+PGMgcj0iQTI1Ij48dj4yNTwvdj48L2M+PC9yb3c+PHJvdyByPSIyNiI+PGMgcj0iQTI2Ij48dj4yNjwvdj48L2M+PC9yb3c+PHJvdyByPSIyNyI+PGMgcj0iQTI3Ij48dj4yNzwvdj48L2M+PC9yb3c+PHJvdyByPSIyOCI+PGMgcj0iQTI4Ij48dj4yODwvdj48L2M+PC9yb3c+PHJvdyByPSIyOSI+PGMgcj0iQTI5Ij48dj4yOTwvdj48L2M+PC9yb3c+PHJvdyByPSIzMCI+PGMgcj0iQTMwIj48dj4zMDwvdj48L2M+PC9yb3c+PHJvdyByPSIzMSI+PGMgcj0iQTMxIj48dj4zMTwvdj48L2M+PC9yb3c+PHJvdyByPSIzMiI+PGMgcj0iQTMyIj48dj4zMjwvdj48L2M+PC9yb3c+PHJvdyByPSIzMyI+PGMgcj0iQTMzIj48dj4zMzwvdj48L2M+PC9yb3c+PHJvdyByPSIzNCI+PGMgcj0iQTM0Ij48dj4zNDwvdj48L2M+PC9yb3c+PHJvdyByPSIzNSI+PGMgcj0iQTM1Ij48dj4zNTwvdj48L2M+PC9yb3c+PHJvdyByPSIzNiI+PGMgcj0iQTM2Ij48dj4zNjwvdj48L2M+PC9yb3c+PHJvdyByPSIzNyI+PGMgcj0iQTM3Ij48dj4zNzwvdj48L2M+PC9yb3c+PHJvdyByPSIzOCI+PGMgcj0iQTM4Ij48dj4zODwvdj48L2M+PC9yb3c+PHJvdyByPSIzOSI+PGMgcj0iQTM5Ij48dj4zOTwvdj48L2M+PC9yb3c+PHJvdyByPSI0MCI+PGMgcj0iQTQwIj48dj40MDwvdj48L2M+PC9yb3c+PHJvdyByPSI0MSI+PGMgcj0iQTQxIj48dj40MTwvdj48L2M+PC9yb3c+PHJvdyByPSI0MiI+PGMgcj0iQTQyIj48dj40Mjwvdj48L2M+PC9yb3c+PHJvdyByPSI0MyI+PGMgcj0iQTQzIj48dj40Mzwvdj48L2M+PC9yb3c+PHJvdyByPSI0NCI+PGMgcj0iQTQ0Ij48dj40NDwvdj48L2M+PC9yb3c+PHJvdyByPSI0NSI+PGMgcj0iQTQ1Ij48dj40NTwvdj48L2M+PC9yb3c+PHJvdyByPSI0NiI+PGMgcj0iQTQ2Ij48dj40Njwvdj48L2M+PC9yb3c+PHJvdyByPSI0NyI+PGMgcj0iQTQ3Ij48dj40Nzwvdj48L2M+PC9yb3c+PHJvdyByPSI0OCI+PGMgcj0iQTQ4Ij48dj40ODwvdj48L2M+PC9yb3c+PHJvdyByPSI0OSI+PGMgcj0iQTQ5Ij48dj40OTwvdj48L2M+PC9yb3c+PHJvdyByPSI1MCI+PGMgcj0iQTUwIj48dj41MDwvdj48L2M+PC9yb3c+PHJvdyByPSI1MSI+PGMgcj0iQTUxIj48dj41MTwvdj48L2M+PC9yb3c+PHJvdyByPSI1MiI+PGMgcj0iQTUyIj48dj41Mjwvdj48L2M+PC9yb3c+PHJvdyByPSI1MyI+PGMgcj0iQTUzIj48dj41Mzwvdj48L2M+PC9yb3c+PHJvdyByPSI1NCI+PGMgcj0iQTU0Ij48dj41NDwvdj48L2M+PC9yb3c+PHJvdyByPSI1NSI+PGMgcj0iQTU1Ij48dj41NTwvdj48L2M+PC9yb3c+PHJvdyByPSI1NiI+PGMgcj0iQTU2Ij48dj41Njwvdj48L2M+PC9yb3c+PHJvdyByPSI1NyI+PGMgcj0iQTU3Ij48dj41Nzwvdj48L2M+PC9yb3c+PHJvdyByPSI1OCI+PGMgcj0iQTU4Ij48dj41ODwvdj48L2M+PC9yb3c+PHJvdyByPSI1OSI+PGMgcj0iQTU5Ij48dj41OTwvdj48L2M+PC9yb3c+PHJvdyByPSI2MCI+PGMgcj0iQTYwIj48dj42MDwvdj48L2M+PC9yb3c+PHJvdyByPSI2MSI+PGMgcj0iQTYxIj48dj42MTwvdj48L2M+PC9yb3c+PHJvdyByPSI2MiI+PGMgcj0iQTYyIj48dj42Mjwvdj48L2M+PC9yb3c+PHJvdyByPSI2MyI+PGMgcj0iQTYzIj48dj42Mzwvdj48L2M+PC9yb3c+PHJvdyByPSI2NCI+PGMgcj0iQTY0Ij48dj42NDwvdj48L2M+PC9yb3c+PHJvdyByPSI2NSI+PGMgcj0iQTY1Ij48dj42NTwvdj48L2M+PC9yb3c+PHJvdyByPSI2NiI+PGMgcj0iQTY2Ij48dj42Njwvdj48L2M+PC9yb3c+PHJvdyByPSI2NyI+PGMgcj0iQTY3Ij48dj42Nzwvdj48L2M+PC9yb3c+PHJvdyByPSI2OCI+PGMgcj0iQTY4Ij48dj42ODwvdj48L2M+PC9yb3c+PHJvdyByPSI2OSI+PGMgcj0iQTY5Ij48dj42OTwvdj48L2M+PC9yb3c+PHJvdyByPSI3MCI+PGMgcj0iQTcwIj48dj43MDwvdj48L2M+PC9yb3c+PHJvdyByPSI3MSI+PGMgcj0iQTcxIj48dj43MTwvdj48L2M+PC9yb3c+PHJvdyByPSI3MiI+PGMgcj0iQTcyIj48dj43Mjwvdj48L2M+PC9yb3c+PHJvdyByPSI3MyI+PGMgcj0iQTczIj48dj43Mzwvdj48L2M+PC9yb3c+PHJvdyByPSI3NCI+PGMgcj0iQTc0Ij48dj43NDwvdj48L2M+PC9yb3c+PHJvdyByPSI3NSI+PGMgcj0iQTc1Ij48dj43NTwvdj48L2M+PC9yb3c+PHJvdyByPSI3NiI+PGMgcj0iQTc2Ij48dj43Njwvdj48L2M+PC9yb3c+PHJvdyByPSI3NyI+PGMgcj0iQTc3Ij48dj43Nzwvdj48L2M+PC9yb3c+PHJvdyByPSI3OCI+PGMgcj0iQTc4Ij48dj43ODwvdj48L2M+PC9yb3c+PHJvdyByPSI3OSI+PGMgcj0iQTc5Ij48dj43OTwvdj48L2M+PC9yb3c+PHJvdyByPSI4MCI+PGMgcj0iQTgwIj48dj44MDwvdj48L2M+PC9yb3c+PHJvdyByPSI4MSI+PGMgcj0iQTgxIj48dj44MTwvdj48L2M+PC9yb3c+PHJvdyByPSI4MiI+PGMgcj0iQTgyIj48dj44Mjwvdj48L2M+PC9yb3c+PHJvdyByPSI4MyI+PGMgcj0iQTgzIj48dj44Mzwvdj48L2M+PC9yb3c+PHJvdyByPSI4NCI+PGMgcj0iQTg0Ij48dj44NDwvdj48L2M+PC9yb3c+PHJvdyByPSI4NSI+PGMgcj0iQTg1Ij48dj44NTwvdj48L2M+PC9yb3c+PHJvdyByPSI4NiI+PGMgcj0iQTg2Ij48dj44Njwvdj48L2M+PC9yb3c+PHJvdyByPSI4NyI+PGMgcj0iQTg3Ij48dj44Nzwvdj48L2M+PC9yb3c+PHJvdyByPSI4OCI+PGMgcj0iQTg4Ij48dj44ODwvdj48L2M+PC9yb3c+PHJvdyByPSI4OSI+PGMgcj0iQTg5Ij48dj44OTwvdj48L2M+PC9yb3c+PHJvdyByPSI5MCI+PGMgcj0iQTkwIj48dj45MDwvdj48L2M+PC9yb3c+PHJvdyByPSI5MSI+PGMgcj0iQTkxIj48dj45MTwvdj48L2M+PC9yb3c+PHJvdyByPSI5MiI+PGMgcj0iQTkyIj48dj45Mjwvdj48L2M+PC9yb3c+PHJvdyByPSI5MyI+PGMgcj0iQTkzIj48dj45Mzwvdj48L2M+PC9yb3c+PHJvdyByPSI5NCI+PGMgcj0iQTk0Ij48dj45NDwvdj48L2M+PC9yb3c+PHJvdyByPSI5NSI+PGMgcj0iQTk1Ij48dj45NTwvdj48L2M+PC9yb3c+PHJvdyByPSI5NiI+PGMgcj0iQTk2Ij48dj45Njwvdj48L2M+PC9yb3c+PHJvdyByPSI5NyI+PGMgcj0iQTk3Ij48dj45Nzwvdj48L2M+PC9yb3c+PHJvdyByPSI5OCI+PGMgcj0iQTk4Ij48dj45ODwvdj48L2M+PC9yb3c+PHJvdyByPSI5OSI+PGMgcj0iQTk5Ij48dj45OTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMDAiPjxjIHI9IkExMDAiPjx2PjEwMDwvdj48L2M+PC9yb3c+PHJvdyByPSIxMDEiPjxjIHI9IkExMDEiPjx2PjEwMTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMDIiPjxjIHI9IkExMDIiPjx2PjEwMjwvdj48L2M+PC9yb3c+PHJvdyByPSIxMDMiPjxjIHI9IkExMDMiPjx2PjEwMzwvdj48L2M+PC9yb3c+PHJvdyByPSIxMDQiPjxjIHI9IkExMDQiPjx2PjEwNDwvdj48L2M+PC9yb3c+PHJvdyByPSIxMDUiPjxjIHI9IkExMDUiPjx2PjEwNTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMDYiPjxjIHI9IkExMDYiPjx2PjEwNjwvdj48L2M+PC9yb3c+PHJvdyByPSIxMDciPjxjIHI9IkExMDciPjx2PjEwNzwvdj48L2M+PC9yb3c+PHJvdyByPSIxMDgiPjxjIHI9IkExMDgiPjx2PjEwODwvdj48L2M+PC9yb3c+PHJvdyByPSIxMDkiPjxjIHI9IkExMDkiPjx2PjEwOTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMTAiPjxjIHI9IkExMTAiPjx2PjExMDwvdj48L2M+PC9yb3c+PHJvdyByPSIxMTEiPjxjIHI9IkExMTEiPjx2PjExMTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMTIiPjxjIHI9IkExMTIiPjx2PjExMjwvdj48L2M+PC9yb3c+PHJvdyByPSIxMTMiPjxjIHI9IkExMTMiPjx2PjExMzwvdj48L2M+PC9yb3c+PHJvdyByPSIxMTQiPjxjIHI9IkExMTQiPjx2PjExNDwvdj48L2M+PC9yb3c+PHJvdyByPSIxMTUiPjxjIHI9IkExMTUiPjx2PjExNTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMTYiPjxjIHI9IkExMTYiPjx2PjExNjwvdj48L2M+PC9yb3c+PHJvdyByPSIxMTciPjxjIHI9IkExMTciPjx2PjExNzwvdj48L2M+PC9yb3c+PHJvdyByPSIxMTgiPjxjIHI9IkExMTgiPjx2PjExODwvdj48L2M+PC9yb3c+PHJvdyByPSIxMTkiPjxjIHI9IkExMTkiPjx2PjExOTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMjAiPjxjIHI9IkExMjAiPjx2PjEyMDwvdj48L2M+PC9yb3c+PHJvdyByPSIxMjEiPjxjIHI9IkExMjEiPjx2PjEyMTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMjIiPjxjIHI9IkExMjIiPjx2PjEyMjwvdj48L2M+PC9yb3c+PHJvdyByPSIxMjMiPjxjIHI9IkExMjMiPjx2PjEyMzwvdj48L2M+PC9yb3c+PHJvdyByPSIxMjQiPjxjIHI9IkExMjQiPjx2PjEyNDwvdj48L2M+PC9yb3c+PHJvdyByPSIxMjUiPjxjIHI9IkExMjUiPjx2PjEyNTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMjYiPjxjIHI9IkExMjYiPjx2PjEyNjwvdj48L2M+PC9yb3c+PHJvdyByPSIxMjciPjxjIHI9IkExMjciPjx2PjEyNzwvdj48L2M+PC9yb3c+PHJvdyByPSIxMjgiPjxjIHI9IkExMjgiPjx2PjEyODwvdj48L2M+PC9yb3c+PHJvdyByPSIxMjkiPjxjIHI9IkExMjkiPjx2PjEyOTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMzAiPjxjIHI9IkExMzAiPjx2PjEzMDwvdj48L2M+PC9yb3c+PHJvdyByPSIxMzEiPjxjIHI9IkExMzEiPjx2PjEzMTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMzIiPjxjIHI9IkExMzIiPjx2PjEzMjwvdj48L2M+PC9yb3c+PHJvdyByPSIxMzMiPjxjIHI9IkExMzMiPjx2PjEzMzwvdj48L2M+PC9yb3c+PHJvdyByPSIxMzQiPjxjIHI9IkExMzQiPjx2PjEzNDwvdj48L2M+PC9yb3c+PHJvdyByPSIxMzUiPjxjIHI9IkExMzUiPjx2PjEzNTwvdj48L2M+PC9yb3c+PHJvdyByPSIxMzYiPjxjIHI9IkExMzYiPjx2PjEzNjwvdj48L2M+PC9yb3c+PHJvdyByPSIxMzciPjxjIHI9IkExMzciPjx2PjEzNzwvdj48L2M+PC9yb3c+PHJvdyByPSIxMzgiPjxjIHI9IkExMzgiPjx2PjEzODwvdj48L2M+PC9yb3c+PHJvdyByPSIxMzkiPjxjIHI9IkExMzkiPjx2PjEzOTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNDAiPjxjIHI9IkExNDAiPjx2PjE0MDwvdj48L2M+PC9yb3c+PHJvdyByPSIxNDEiPjxjIHI9IkExNDEiPjx2PjE0MTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNDIiPjxjIHI9IkExNDIiPjx2PjE0Mjwvdj48L2M+PC9yb3c+PHJvdyByPSIxNDMiPjxjIHI9IkExNDMiPjx2PjE0Mzwvdj48L2M+PC9yb3c+PHJvdyByPSIxNDQiPjxjIHI9IkExNDQiPjx2PjE0NDwvdj48L2M+PC9yb3c+PHJvdyByPSIxNDUiPjxjIHI9IkExNDUiPjx2PjE0NTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNDYiPjxjIHI9IkExNDYiPjx2PjE0Njwvdj48L2M+PC9yb3c+PHJvdyByPSIxNDciPjxjIHI9IkExNDciPjx2PjE0Nzwvdj48L2M+PC9yb3c+PHJvdyByPSIxNDgiPjxjIHI9IkExNDgiPjx2PjE0ODwvdj48L2M+PC9yb3c+PHJvdyByPSIxNDkiPjxjIHI9IkExNDkiPjx2PjE0OTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNTAiPjxjIHI9IkExNTAiPjx2PjE1MDwvdj48L2M+PC9yb3c+PHJvdyByPSIxNTEiPjxjIHI9IkExNTEiPjx2PjE1MTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNTIiPjxjIHI9IkExNTIiPjx2PjE1Mjwvdj48L2M+PC9yb3c+PHJvdyByPSIxNTMiPjxjIHI9IkExNTMiPjx2PjE1Mzwvdj48L2M+PC9yb3c+PHJvdyByPSIxNTQiPjxjIHI9IkExNTQiPjx2PjE1NDwvdj48L2M+PC9yb3c+PHJvdyByPSIxNTUiPjxjIHI9IkExNTUiPjx2PjE1NTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNTYiPjxjIHI9IkExNTYiPjx2PjE1Njwvdj48L2M+PC9yb3c+PHJvdyByPSIxNTciPjxjIHI9IkExNTciPjx2PjE1Nzwvdj48L2M+PC9yb3c+PHJvdyByPSIxNTgiPjxjIHI9IkExNTgiPjx2PjE1ODwvdj48L2M+PC9yb3c+PHJvdyByPSIxNTkiPjxjIHI9IkExNTkiPjx2PjE1OTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNjAiPjxjIHI9IkExNjAiPjx2PjE2MDwvdj48L2M+PC9yb3c+PHJvdyByPSIxNjEiPjxjIHI9IkExNjEiPjx2PjE2MTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNjIiPjxjIHI9IkExNjIiPjx2PjE2Mjwvdj48L2M+PC9yb3c+PHJvdyByPSIxNjMiPjxjIHI9IkExNjMiPjx2PjE2Mzwvdj48L2M+PC9yb3c+PHJvdyByPSIxNjQiPjxjIHI9IkExNjQiPjx2PjE2NDwvdj48L2M+PC9yb3c+PHJvdyByPSIxNjUiPjxjIHI9IkExNjUiPjx2PjE2NTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNjYiPjxjIHI9IkExNjYiPjx2PjE2Njwvdj48L2M+PC9yb3c+PHJvdyByPSIxNjciPjxjIHI9IkExNjciPjx2PjE2Nzwvdj48L2M+PC9yb3c+PHJvdyByPSIxNjgiPjxjIHI9IkExNjgiPjx2PjE2ODwvdj48L2M+PC9yb3c+PHJvdyByPSIxNjkiPjxjIHI9IkExNjkiPjx2PjE2OTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNzAiPjxjIHI9IkExNzAiPjx2PjE3MDwvdj48L2M+PC9yb3c+PHJvdyByPSIxNzEiPjxjIHI9IkExNzEiPjx2PjE3MTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNzIiPjxjIHI9IkExNzIiPjx2PjE3Mjwvdj48L2M+PC9yb3c+PHJvdyByPSIxNzMiPjxjIHI9IkExNzMiPjx2PjE3Mzwvdj48L2M+PC9yb3c+PHJvdyByPSIxNzQiPjxjIHI9IkExNzQiPjx2PjE3NDwvdj48L2M+PC9yb3c+PHJvdyByPSIxNzUiPjxjIHI9IkExNzUiPjx2PjE3NTwvdj48L2M+PC9yb3c+PHJvdyByPSIxNzYiPjxjIHI9IkExNzYiPjx2PjE3Njwvdj48L2M+PC9yb3c+PHJvdyByPSIxNzciPjxjIHI9IkExNzciPjx2PjE3Nzwvdj48L2M+PC9yb3c+PHJvdyByPSIxNzgiPjxjIHI9IkExNzgiPjx2PjE3ODwvdj48L2M+PC9yb3c+PHJvdyByPSIxNzkiPjxjIHI9IkExNzkiPjx2PjE3OTwvdj48L2M+PC9yb3c+PHJvdyByPSIxODAiPjxjIHI9IkExODAiPjx2PjE4MDwvdj48L2M+PC9yb3c+PHJvdyByPSIxODEiPjxjIHI9IkExODEiPjx2PjE4MTwvdj48L2M+PC9yb3c+PHJvdyByPSIxODIiPjxjIHI9IkExODIiPjx2PjE4Mjwvdj48L2M+PC9yb3c+PHJvdyByPSIxODMiPjxjIHI9IkExODMiPjx2PjE4Mzwvdj48L2M+PC9yb3c+PHJvdyByPSIxODQiPjxjIHI9IkExODQiPjx2PjE4NDwvdj48L2M+PC9yb3c+PHJvdyByPSIxODUiPjxjIHI9IkExODUiPjx2PjE4NTwvdj48L2M+PC9yb3c+PHJvdyByPSIxODYiPjxjIHI9IkExODYiPjx2PjE4Njwvdj48L2M+PC9yb3c+PHJvdyByPSIxODciPjxjIHI9IkExODciPjx2PjE4Nzwvdj48L2M+PC9yb3c+PHJvdyByPSIxODgiPjxjIHI9IkExODgiPjx2PjE4ODwvdj48L2M+PC9yb3c+PHJvdyByPSIxODkiPjxjIHI9IkExODkiPjx2PjE4OTwvdj48L2M+PC9yb3c+PHJvdyByPSIxOTAiPjxjIHI9IkExOTAiPjx2PjE5MDwvdj48L2M+PC9yb3c+PHJvdyByPSIxOTEiPjxjIHI9IkExOTEiPjx2PjE5MTwvdj48L2M+PC9yb3c+PHJvdyByPSIxOTIiPjxjIHI9IkExOTIiPjx2PjE5Mjwvdj48L2M+PC9yb3c+PHJvdyByPSIxOTMiPjxjIHI9IkExOTMiPjx2PjE5Mzwvdj48L2M+PC9yb3c+PHJvdyByPSIxOTQiPjxjIHI9IkExOTQiPjx2PjE5NDwvdj48L2M+PC9yb3c+PHJvdyByPSIxOTUiPjxjIHI9IkExOTUiPjx2PjE5NTwvdj48L2M+PC9yb3c+PHJvdyByPSIxOTYiPjxjIHI9IkExOTYiPjx2PjE5Njwvdj48L2M+PC9yb3c+PHJvdyByPSIxOTciPjxjIHI9IkExOTciPjx2PjE5Nzwvdj48L2M+PC9yb3c+PHJvdyByPSIxOTgiPjxjIHI9IkExOTgiPjx2PjE5ODwvdj48L2M+PC9yb3c+PHJvdyByPSIxOTkiPjxjIHI9IkExOTkiPjx2PjE5OTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMDAiPjxjIHI9IkEyMDAiPjx2PjIwMDwvdj48L2M+PC9yb3c+PHJvdyByPSIyMDEiPjxjIHI9IkEyMDEiPjx2PjIwMTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMDIiPjxjIHI9IkEyMDIiPjx2PjIwMjwvdj48L2M+PC9yb3c+PHJvdyByPSIyMDMiPjxjIHI9IkEyMDMiPjx2PjIwMzwvdj48L2M+PC9yb3c+PHJvdyByPSIyMDQiPjxjIHI9IkEyMDQiPjx2PjIwNDwvdj48L2M+PC9yb3c+PHJvdyByPSIyMDUiPjxjIHI9IkEyMDUiPjx2PjIwNTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMDYiPjxjIHI9IkEyMDYiPjx2PjIwNjwvdj48L2M+PC9yb3c+PHJvdyByPSIyMDciPjxjIHI9IkEyMDciPjx2PjIwNzwvdj48L2M+PC9yb3c+PHJvdyByPSIyMDgiPjxjIHI9IkEyMDgiPjx2PjIwODwvdj48L2M+PC9yb3c+PHJvdyByPSIyMDkiPjxjIHI9IkEyMDkiPjx2PjIwOTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMTAiPjxjIHI9IkEyMTAiPjx2PjIxMDwvdj48L2M+PC9yb3c+PHJvdyByPSIyMTEiPjxjIHI9IkEyMTEiPjx2PjIxMTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMTIiPjxjIHI9IkEyMTIiPjx2PjIxMjwvdj48L2M+PC9yb3c+PHJvdyByPSIyMTMiPjxjIHI9IkEyMTMiPjx2PjIxMzwvdj48L2M+PC9yb3c+PHJvdyByPSIyMTQiPjxjIHI9IkEyMTQiPjx2PjIxNDwvdj48L2M+PC9yb3c+PHJvdyByPSIyMTUiPjxjIHI9IkEyMTUiPjx2PjIxNTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMTYiPjxjIHI9IkEyMTYiPjx2PjIxNjwvdj48L2M+PC9yb3c+PHJvdyByPSIyMTciPjxjIHI9IkEyMTciPjx2PjIxNzwvdj48L2M+PC9yb3c+PHJvdyByPSIyMTgiPjxjIHI9IkEyMTgiPjx2PjIxODwvdj48L2M+PC9yb3c+PHJvdyByPSIyMTkiPjxjIHI9IkEyMTkiPjx2PjIxOTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMjAiPjxjIHI9IkEyMjAiPjx2PjIyMDwvdj48L2M+PC9yb3c+PHJvdyByPSIyMjEiPjxjIHI9IkEyMjEiPjx2PjIyMTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMjIiPjxjIHI9IkEyMjIiPjx2PjIyMjwvdj48L2M+PC9yb3c+PHJvdyByPSIyMjMiPjxjIHI9IkEyMjMiPjx2PjIyMzwvdj48L2M+PC9yb3c+PHJvdyByPSIyMjQiPjxjIHI9IkEyMjQiPjx2PjIyNDwvdj48L2M+PC9yb3c+PHJvdyByPSIyMjUiPjxjIHI9IkEyMjUiPjx2PjIyNTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMjYiPjxjIHI9IkEyMjYiPjx2PjIyNjwvdj48L2M+PC9yb3c+PHJvdyByPSIyMjciPjxjIHI9IkEyMjciPjx2PjIyNzwvdj48L2M+PC9yb3c+PHJvdyByPSIyMjgiPjxjIHI9IkEyMjgiPjx2PjIyODwvdj48L2M+PC9yb3c+PHJvdyByPSIyMjkiPjxjIHI9IkEyMjkiPjx2PjIyOTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMzAiPjxjIHI9IkEyMzAiPjx2PjIzMDwvdj48L2M+PC9yb3c+PHJvdyByPSIyMzEiPjxjIHI9IkEyMzEiPjx2PjIzMTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMzIiPjxjIHI9IkEyMzIiPjx2PjIzMjwvdj48L2M+PC9yb3c+PHJvdyByPSIyMzMiPjxjIHI9IkEyMzMiPjx2PjIzMzwvdj48L2M+PC9yb3c+PHJvdyByPSIyMzQiPjxjIHI9IkEyMzQiPjx2PjIzNDwvdj48L2M+PC9yb3c+PHJvdyByPSIyMzUiPjxjIHI9IkEyMzUiPjx2PjIzNTwvdj48L2M+PC9yb3c+PHJvdyByPSIyMzYiPjxjIHI9IkEyMzYiPjx2PjIzNjwvdj48L2M+PC9yb3c+PHJvdyByPSIyMzciPjxjIHI9IkEyMzciPjx2PjIzNzwvdj48L2M+PC9yb3c+PHJvdyByPSIyMzgiPjxjIHI9IkEyMzgiPjx2PjIzODwvdj48L2M+PC9yb3c+PHJvdyByPSIyMzkiPjxjIHI9IkEyMzkiPjx2PjIzOTwvdj48L2M+PC9yb3c+PHJvdyByPSIyNDAiPjxjIHI9IkEyNDAiPjx2PjI0MDwvdj48L2M+PC9yb3c+PHJvdyByPSIyNDEiPjxjIHI9IkEyNDEiPjx2PjI0MTwvdj48L2M+PC9yb3c+PHJvdyByPSIyNDIiPjxjIHI9IkEyNDIiPjx2PjI0Mjwvdj48L2M+PC9yb3c+PHJvdyByPSIyNDMiPjxjIHI9IkEyNDMiPjx2PjI0Mzwvdj48L2M+PC9yb3c+PHJvdyByPSIyNDQiPjxjIHI9IkEyNDQiPjx2PjI0NDwvdj48L2M+PC9yb3c+PHJvdyByPSIyNDUiPjxjIHI9IkEyNDUiPjx2PjI0NTwvdj48L2M+PC9yb3c+PHJvdyByPSIyNDYiPjxjIHI9IkEyNDYiPjx2PjI0Njwvdj48L2M+PC9yb3c+PHJvdyByPSIyNDciPjxjIHI9IkEyNDciPjx2PjI0Nzwvdj48L2M+PC9yb3c+PHJvdyByPSIyNDgiPjxjIHI9IkEyNDgiPjx2PjI0ODwvdj48L2M+PC9yb3c+PHJvdyByPSIyNDkiPjxjIHI9IkEyNDkiPjx2PjI0OTwvdj48L2M+PC9yb3c+PHJvdyByPSIyNTAiPjxjIHI9IkEyNTAiPjx2PjI1MDwvdj48L2M+PC9yb3c+PHJvdyByPSIyNTEiPjxjIHI9IkEyNTEiPjx2PjI1MTwvdj48L2M+PC9yb3c+PHJvdyByPSIyNTIiPjxjIHI9IkEyNTIiPjx2PjI1Mjwvdj48L2M+PC9yb3c+PHJvdyByPSIyNTMiPjxjIHI9IkEyNTMiPjx2PjI1Mzwvdj48L2M+PC9yb3c+PHJvdyByPSIyNTQiPjxjIHI9IkEyNTQiPjx2PjI1NDwvdj48L2M+PC9yb3c+PHJvdyByPSIyNTUiPjxjIHI9IkEyNTUiPjx2PjI1NTwvdj48L2M+PC9yb3c+PC9zaGVldERhdGE+PHBhZ2VNYXJnaW5zIGxlZnQ9IjAuNyIgcmlnaHQ9IjAuNyIgdG9wPSIwLjc1IiBib3R0b209IjAuNzUiIGhlYWRlcj0iMC4zIiBmb290ZXI9IjAuMyIvPjxpZ25vcmVkRXJyb3JzPjxpZ25vcmVkRXJyb3IgbnVtYmVyU3RvcmVkQXNUZXh0PSIxIiBzcXJlZj0iQTE6QTI1NSIvPjwvaWdub3JlZEVycm9ycz48L3dvcmtzaGVldD5QSwMEFAAAAAAAAAAAAFvm9kjwAwAA8AMAABgAAAB4bC93b3Jrc2hlZXRzL3NoZWV0My54bWw8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJVVEYtOCIgc3RhbmRhbG9uZT0ieWVzIj8+DQo8d29ya3NoZWV0IHhtbG5zPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvc3ByZWFkc2hlZXRtbC8yMDA2L21haW4iIHhtbG5zOnI9Imh0dHA6Ly9zY2hlbWFzLm9wZW54bWxmb3JtYXRzLm9yZy9vZmZpY2VEb2N1bWVudC8yMDA2L3JlbGF0aW9uc2hpcHMiPjxkaW1lbnNpb24gcmVmPSJBMTpBOSIvPjxzaGVldFZpZXdzPjxzaGVldFZpZXcgd29ya2Jvb2tWaWV3SWQ9IjAiIHJpZ2h0VG9MZWZ0PSIwIi8+PC9zaGVldFZpZXdzPjxzaGVldERhdGE+PHJvdyByPSIxIj48YyByPSJBMSIgdD0ic3RyIj48dj5QYXJlbnRhbCBMZWF2ZTwvdj48L2M+PC9yb3c+PHJvdyByPSIyIj48YyByPSJBMiIgdD0ic3RyIj48dj5TaWNrIERheTwvdj48L2M+PC9yb3c+PHJvdyByPSIzIj48YyByPSJBMyIgdD0ic3RyIj48dj5WYWNhdGlvbjwvdj48L2M+PC9yb3c+PHJvdyByPSI0Ij48YyByPSJBNCIgdD0ic3RyIj48dj5PZmY8L3Y+PC9jPjwvcm93Pjxyb3cgcj0iNSI+PGMgcj0iQTUiIHQ9InN0ciI+PHY+T1QgQ2FuY2VsbGVkIGJ5IFN1cHY8L3Y+PC9jPjwvcm93Pjxyb3cgcj0iNiI+PGMgcj0iQTYiIHQ9InN0ciI+PHY+VW5mdWxmaWxsZWQ8L3Y+PC9jPjwvcm93Pjxyb3cgcj0iNyI+PGMgcj0iQTciIHQ9InN0ciI+PHY+TkNOUzwvdj48L2M+PC9yb3c+PHJvdyByPSI4Ij48YyByPSJBOCIgdD0ic3RyIj48dj5WQTwvdj48L2M+PC9yb3c+PHJvdyByPSI5Ij48YyByPSJBOSIgdD0ic3RyIj48dj5DYWxsZWQgT2ZmPC92PjwvYz48L3Jvdz48L3NoZWV0RGF0YT48cGFnZU1hcmdpbnMgbGVmdD0iMC43IiByaWdodD0iMC43IiB0b3A9IjAuNzUiIGJvdHRvbT0iMC43NSIgaGVhZGVyPSIwLjMiIGZvb3Rlcj0iMC4zIi8+PGlnbm9yZWRFcnJvcnM+PGlnbm9yZWRFcnJvciBudW1iZXJTdG9yZWRBc1RleHQ9IjEiIHNxcmVmPSJBMTpBOSIvPjwvaWdub3JlZEVycm9ycz48L3dvcmtzaGVldD5QSwMEFAAAAAAAAAAAALgZvix8BwAAfAcAABgAAAB4bC93b3Jrc2hlZXRzL3NoZWV0NC54bWw8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJVVEYtOCIgc3RhbmRhbG9uZT0ieWVzIj8+DQo8d29ya3NoZWV0IHhtbG5zPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvc3ByZWFkc2hlZXRtbC8yMDA2L21haW4iIHhtbG5zOnI9Imh0dHA6Ly9zY2hlbWFzLm9wZW54bWxmb3JtYXRzLm9yZy9vZmZpY2VEb2N1bWVudC8yMDA2L3JlbGF0aW9uc2hpcHMiPjxkaW1lbnNpb24gcmVmPSJBMTpBMiIvPjxzaGVldFZpZXdzPjxzaGVldFZpZXcgd29ya2Jvb2tWaWV3SWQ9IjAiIHJpZ2h0VG9MZWZ0PSIwIi8+PC9zaGVldFZpZXdzPjxjb2xzPjxjb2wgbWluPSIxIiBtYXg9IjEiIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iMjAwIi8+PC9jb2xzPjxzaGVldERhdGE+PHJvdyByPSIxIj48YyByPSJBMSIgdD0ic3RyIj48dj5JbnN0cnVjdGlvbnM8L3Y+PC9jPjwvcm93Pjxyb3cgcj0iMiIgaHQ9IjE2NSIgY3VzdG9tSGVpZ2h0PSIxIiB4bWw6c3BhY2U9InByZXNlcnZlIj48YyByPSJBMiIgdD0ic3RyIiB4bWw6c3BhY2U9InByZXNlcnZlIj48diB4bWw6c3BhY2U9InByZXNlcnZlIj5feDAwMGRfCiAgICAgIC0JVXNlIHRoZSBzYW1wbGUgY29sdW1ucyBhbmQgZGF0YSBwcm92aWRlZCBpbiB0aGVzZSB3b3Jrc2hlZXRzIGFzIGEgZ3VpZGUgZm9yIGVudGVyaW5nIHlvdXIgc2NoZWR1bGUgaW5mbyBpbnRvIGFuIGltcG9ydCBmaWxlLl94MDAwZF8KICAgICAgLQlZb3UgY2FuIGVpdGhlciBjcmVhdGUgYSBuZXcgZmlsZSBvciBhZGQgeW91ciBzY2hlZHVsZSBpbmZvIHRvIHRoaXMgb25lIGFuZCBkZWxldGUgdGhlIHNhbXBsZSBkYXRhIGJlZm9yZSB5b3UgdXBsb2FkIGl0Ll94MDAwZF8KICAgICAgLQlFbnRlciBzaGlmdHMgaW4gb25lIG9mIHRoZSBmb2xsb3dpbmcgdGltZSBmb3JtYXRzOiAxODowMCwgb3IgNnBtLl94MDAwZF8KICAgICAgLQlBbGwgY29sdW1ucyBtYXJrZWQgaW4gYm9sZCBhcmUgcmVxdWlyZWQgZmllbGRzIGFuZCBjYW4gbm90IGJlIGxlZnQgZW1wdHkuX3gwMDBkXwogICAgICAtCVRoZSBpbXBvcnQgcHJvY2VzcyB3aWxsIHNraXAgYWRkaW5nIGEgc2NoZWR1bGUgZW50aXR5IChzaGlmdCwgdGltZSBvZmYsIG9wZW4gc2hpZnQpIG9yIG1lbWJlciBpZiB0aGF0IGV4YWN0IHNhbWUgZW50aXR5IG9yIG1lbWJlciBhbHJlYWR5IGV4aXN0cy5feDAwMGRfCiAgICAgIC0JVXNlIHRoZSBEYXkgTm90ZXMgdGFiIHRvIGFkZCBub3RlcyBmb3IgYSBzcGVjaWZpYyBkYXkuIFNoaWZ0IG5vdGVzIGFuZCBEYXkgbm90ZXMgY2Fu4oCZdCBleGNlZWQgNTAwIGNoYXJhY3RlcnMuX3gwMDBkXwogICAgICAtCVRvIGF2b2lkIGltcG9ydCBlcnJvcnMsIHVzZSB0aGUgZXhpc3RpbmcgY29sdW1ucyBhbmQgdGFicy4gRG9uJmFwb3M7dCBhZGQsIHJlbW92ZSwgbW92ZSwgb3IgcmVuYW1lIHRoZW0uX3gwMDBkXwogICAgICAtCVRoZSBtYXhpbXVtIG51bWJlciBvZiBpdGVtcyB0aGF0IGNhbiBiZSBpbXBvcnRlZCBmb3IgZWFjaCBzY2hlZHVsZSBlbnRpdHkgaW4gb25lIGZpbGUgaXMgMTAwMDAuIFlvdSBjYW4gY3JlYXRlIGFub3RoZXIgZmlsZSB0byBpbXBvcnQgbW9yZSBpdGVtcy5feDAwMGRfCiAgICAgIC0JMjQgaG91ciBzaGlmdHMgY2FuIG5vdyBiZSBhc3NpZ25lZC4gVG8gYXZvaWQgaW1wb3J0IGVycm9ycywgZG8gbm90IHNjaGVkdWxlIHNoaWZ0cyB0aGF0IGV4Y2VlZCAyNCBob3Vycy5feDAwMGRfCiAgICA8L3Y+PC9jPjwvcm93Pjwvc2hlZXREYXRhPjxwYWdlTWFyZ2lucyBsZWZ0PSIwLjciIHJpZ2h0PSIwLjciIHRvcD0iMC43NSIgYm90dG9tPSIwLjc1IiBoZWFkZXI9IjAuMyIgZm9vdGVyPSIwLjMiLz48aWdub3JlZEVycm9ycz48aWdub3JlZEVycm9yIG51bWJlclN0b3JlZEFzVGV4dD0iMSIgc3FyZWY9IkExOkEyIi8+PC9pZ25vcmVkRXJyb3JzPjwvd29ya3NoZWV0PlBLAwQUAAAAAAAAAAAAB8IQHpUGAACVBgAAGAAAAHhsL3dvcmtzaGVldHMvc2hlZXQ1LnhtbDw/eG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IlVURi04IiBzdGFuZGFsb25lPSJ5ZXMiPz4NCjx3b3Jrc2hlZXQgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm9wZW54bWxmb3JtYXRzLm9yZy9zcHJlYWRzaGVldG1sLzIwMDYvbWFpbiIgeG1sbnM6cj0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL29mZmljZURvY3VtZW50LzIwMDYvcmVsYXRpb25zaGlwcyI+PGRpbWVuc2lvbiByZWY9IkExOkwxIi8+PHNoZWV0Vmlld3M+PHNoZWV0VmlldyB3b3JrYm9va1ZpZXdJZD0iMCIgcmlnaHRUb0xlZnQ9IjAiLz48L3NoZWV0Vmlld3M+PGNvbHM+PGNvbCBtaW49IjEiIG1heD0iMSIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSI5LjE0MDYyNSIvPjxjb2wgbWluPSIyIiBtYXg9IjIiIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iMTEuNzEwOTM3NSIvPjxjb2wgbWluPSIzIiBtYXg9IjMiIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iOS4xNDA2MjUiLz48Y29sIG1pbj0iNCIgbWF4PSI0IiBjdXN0b21XaWR0aD0iMSIgd2lkdGg9IjEwLjU3MDMxMjUiLz48Y29sIG1pbj0iNSIgbWF4PSI1IiBjdXN0b21XaWR0aD0iMSIgd2lkdGg9IjEwLjcxMDkzNzUiLz48Y29sIG1pbj0iNiIgbWF4PSI2IiBjdXN0b21XaWR0aD0iMSIgd2lkdGg9IjkuNTcwMzEyNSIvPjxjb2wgbWluPSI3IiBtYXg9IjciIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iOS43MTA5Mzc1Ii8+PGNvbCBtaW49IjgiIG1heD0iOCIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSIxMi41NzAzMTI1Ii8+PGNvbCBtaW49IjkiIG1heD0iOSIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSIxMy4yODUxNTYyNSIvPjxjb2wgbWluPSIxMCIgbWF4PSIxMCIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSIyMi4xNDA2MjUiLz48Y29sIG1pbj0iMTEiIG1heD0iMTEiIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iOS4xNDA2MjUiLz48Y29sIG1pbj0iMTIiIG1heD0iMTIiIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iOS4xNDA2MjUiLz48L2NvbHM+PHNoZWV0RGF0YT48cm93IHI9IjEiPjxjIHI9IkExIiB0PSJzdHIiPjx2Pk1lbWJlcjwvdj48L2M+PGMgcj0iQjEiIHQ9InN0ciI+PHY+V29yayBFbWFpbDwvdj48L2M+PGMgcj0iQzEiIHQ9InN0ciI+PHY+R3JvdXA8L3Y+PC9jPjxjIHI9IkQxIiB0PSJzdHIiPjx2PlN0YXJ0IERhdGU8L3Y+PC9jPjxjIHI9IkUxIiB0PSJzdHIiPjx2PlN0YXJ0IFRpbWU8L3Y+PC9jPjxjIHI9IkYxIiB0PSJzdHIiPjx2PkVuZCBEYXRlPC92PjwvYz48YyByPSJHMSIgdD0ic3RyIj48dj5FbmQgVGltZTwvdj48L2M+PGMgcj0iSDEiIHQ9InN0ciI+PHY+VGhlbWUgQ29sb3I8L3Y+PC9jPjxjIHI9IkkxIiB0PSJzdHIiPjx2PkN1c3RvbSBMYWJlbDwvdj48L2M+PGMgcj0iSjEiIHQ9InN0ciI+PHY+VW5wYWlkIEJyZWFrIChtaW51dGVzKTwvdj48L2M+PGMgcj0iSzEiIHQ9InN0ciI+PHY+Tm90ZXM8L3Y+PC9jPjxjIHI9IkwxIiB0PSJzdHIiPjx2PlNoYXJlZDwvdj48L2M+PC9yb3c+PC9zaGVldERhdGE+PHBhZ2VNYXJnaW5zIGxlZnQ9IjAuNyIgcmlnaHQ9IjAuNyIgdG9wPSIwLjc1IiBib3R0b209IjAuNzUiIGhlYWRlcj0iMC4zIiBmb290ZXI9IjAuMyIvPjxpZ25vcmVkRXJyb3JzPjxpZ25vcmVkRXJyb3IgbnVtYmVyU3RvcmVkQXNUZXh0PSIxIiBzcXJlZj0iQTE6TDEiLz48L2lnbm9yZWRFcnJvcnM+PC93b3Jrc2hlZXQ+UEsDBBQAAAAAAAAAAABBDyWazgUAAM4FAAAYAAAAeGwvd29ya3NoZWV0cy9zaGVldDYueG1sPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/Pg0KPHdvcmtzaGVldCB4bWxucz0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL3NwcmVhZHNoZWV0bWwvMjAwNi9tYWluIiB4bWxuczpyPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzIj48ZGltZW5zaW9uIHJlZj0iQTE6SjEiLz48c2hlZXRWaWV3cz48c2hlZXRWaWV3IHdvcmtib29rVmlld0lkPSIwIiByaWdodFRvTGVmdD0iMCIvPjwvc2hlZXRWaWV3cz48Y29scz48Y29sIG1pbj0iMSIgbWF4PSIxIiBjdXN0b21XaWR0aD0iMSIgd2lkdGg9IjkuMTQwNjI1Ii8+PGNvbCBtaW49IjIiIG1heD0iMiIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSIxMS43MTA5Mzc1Ii8+PGNvbCBtaW49IjMiIG1heD0iMyIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSIxMC41NzAzMTI1Ii8+PGNvbCBtaW49IjQiIG1heD0iNCIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSIxMC43MTA5Mzc1Ii8+PGNvbCBtaW49IjUiIG1heD0iNSIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSI5LjU3MDMxMjUiLz48Y29sIG1pbj0iNiIgbWF4PSI2IiBjdXN0b21XaWR0aD0iMSIgd2lkdGg9IjkuNzEwOTM3NSIvPjxjb2wgbWluPSI3IiBtYXg9IjciIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iMTYuMTQwNjI1Ii8+PGNvbCBtaW49IjgiIG1heD0iOCIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSIxMi41NzAzMTI1Ii8+PGNvbCBtaW49IjkiIG1heD0iOSIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSI5LjE0MDYyNSIvPjxjb2wgbWluPSIxMCIgbWF4PSIxMCIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSI5LjE0MDYyNSIvPjwvY29scz48c2hlZXREYXRhPjxyb3cgcj0iMSI+PGMgcj0iQTEiIHQ9InN0ciI+PHY+TWVtYmVyPC92PjwvYz48YyByPSJCMSIgdD0ic3RyIj48dj5Xb3JrIEVtYWlsPC92PjwvYz48YyByPSJDMSIgdD0ic3RyIj48dj5TdGFydCBEYXRlPC92PjwvYz48YyByPSJEMSIgdD0ic3RyIj48dj5TdGFydCBUaW1lPC92PjwvYz48YyByPSJFMSIgdD0ic3RyIj48dj5FbmQgRGF0ZTwvdj48L2M+PGMgcj0iRjEiIHQ9InN0ciI+PHY+RW5kIFRpbWU8L3Y+PC9jPjxjIHI9IkcxIiB0PSJzdHIiPjx2PlRpbWUgT2ZmIFJlYXNvbjwvdj48L2M+PGMgcj0iSDEiIHQ9InN0ciI+PHY+VGhlbWUgQ29sb3I8L3Y+PC9jPjxjIHI9IkkxIiB0PSJzdHIiPjx2Pk5vdGVzPC92PjwvYz48YyByPSJKMSIgdD0ic3RyIj48dj5TaGFyZWQ8L3Y+PC9jPjwvcm93Pjwvc2hlZXREYXRhPjxwYWdlTWFyZ2lucyBsZWZ0PSIwLjciIHJpZ2h0PSIwLjciIHRvcD0iMC43NSIgYm90dG9tPSIwLjc1IiBoZWFkZXI9IjAuMyIgZm9vdGVyPSIwLjMiLz48aWdub3JlZEVycm9ycz48aWdub3JlZEVycm9yIG51bWJlclN0b3JlZEFzVGV4dD0iMSIgc3FyZWY9IkExOkoxIi8+PC9pZ25vcmVkRXJyb3JzPjwvd29ya3NoZWV0PlBLAwQUAAAAAAAAAAAARoHsJTwGAAA8BgAAGAAAAHhsL3dvcmtzaGVldHMvc2hlZXQ3LnhtbDw/eG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IlVURi04IiBzdGFuZGFsb25lPSJ5ZXMiPz4NCjx3b3Jrc2hlZXQgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm9wZW54bWxmb3JtYXRzLm9yZy9zcHJlYWRzaGVldG1sLzIwMDYvbWFpbiIgeG1sbnM6cj0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL29mZmljZURvY3VtZW50LzIwMDYvcmVsYXRpb25zaGlwcyI+PGRpbWVuc2lvbiByZWY9IkExOksxIi8+PHNoZWV0Vmlld3M+PHNoZWV0VmlldyB3b3JrYm9va1ZpZXdJZD0iMCIgcmlnaHRUb0xlZnQ9IjAiLz48L3NoZWV0Vmlld3M+PGNvbHM+PGNvbCBtaW49IjEiIG1heD0iMSIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSI5LjE0MDYyNSIvPjxjb2wgbWluPSIyIiBtYXg9IjIiIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iMTAuNTcwMzEyNSIvPjxjb2wgbWluPSIzIiBtYXg9IjMiIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iMTAuNzEwOTM3NSIvPjxjb2wgbWluPSI0IiBtYXg9IjQiIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iOS41NzAzMTI1Ii8+PGNvbCBtaW49IjUiIG1heD0iNSIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSI5LjcxMDkzNzUiLz48Y29sIG1pbj0iNiIgbWF4PSI2IiBjdXN0b21XaWR0aD0iMSIgd2lkdGg9IjExLjE0MDYyNSIvPjxjb2wgbWluPSI3IiBtYXg9IjciIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iMTIuNTcwMzEyNSIvPjxjb2wgbWluPSI4IiBtYXg9IjgiIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iMTMuMjg1MTU2MjUiLz48Y29sIG1pbj0iOSIgbWF4PSI5IiBjdXN0b21XaWR0aD0iMSIgd2lkdGg9IjIyLjI4NTE1NjI1Ii8+PGNvbCBtaW49IjEwIiBtYXg9IjEwIiBjdXN0b21XaWR0aD0iMSIgd2lkdGg9IjE3LjU3MDMxMjUiLz48Y29sIG1pbj0iMTEiIG1heD0iMTEiIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iOS4xNDA2MjUiLz48L2NvbHM+PHNoZWV0RGF0YT48cm93IHI9IjEiPjxjIHI9IkExIiB0PSJzdHIiPjx2Pkdyb3VwPC92PjwvYz48YyByPSJCMSIgdD0ic3RyIj48dj5TdGFydCBEYXRlPC92PjwvYz48YyByPSJDMSIgdD0ic3RyIj48dj5TdGFydCBUaW1lPC92PjwvYz48YyByPSJEMSIgdD0ic3RyIj48dj5FbmQgRGF0ZTwvdj48L2M+PGMgcj0iRTEiIHQ9InN0ciI+PHY+RW5kIFRpbWU8L3Y+PC9jPjxjIHI9IkYxIiB0PSJzdHIiPjx2Pk9wZW4gU2xvdHM8L3Y+PC9jPjxjIHI9IkcxIiB0PSJzdHIiPjx2PlRoZW1lIENvbG9yPC92PjwvYz48YyByPSJIMSIgdD0ic3RyIj48dj5DdXN0b20gTGFiZWw8L3Y+PC9jPjxjIHI9IkkxIiB0PSJzdHIiPjx2PlVucGFpZCBCcmVhayAobWludXRlcyk8L3Y+PC9jPjxjIHI9IkoxIiB0PSJzdHIiPjx2Pk5vdGVzPC92PjwvYz48YyByPSJLMSIgdD0ic3RyIj48dj5TaGFyZWQ8L3Y+PC9jPjwvcm93Pjwvc2hlZXREYXRhPjxwYWdlTWFyZ2lucyBsZWZ0PSIwLjciIHJpZ2h0PSIwLjciIHRvcD0iMC43NSIgYm90dG9tPSIwLjc1IiBoZWFkZXI9IjAuMyIgZm9vdGVyPSIwLjMiLz48aWdub3JlZEVycm9ycz48aWdub3JlZEVycm9yIG51bWJlclN0b3JlZEFzVGV4dD0iMSIgc3FyZWY9IkExOksxIi8+PC9pZ25vcmVkRXJyb3JzPjwvd29ya3NoZWV0PlBLAwQUAAAAAAAAAAAAU0YQH9UCAADVAgAAGAAAAHhsL3dvcmtzaGVldHMvc2hlZXQ4LnhtbDw/eG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IlVURi04IiBzdGFuZGFsb25lPSJ5ZXMiPz4NCjx3b3Jrc2hlZXQgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm9wZW54bWxmb3JtYXRzLm9yZy9zcHJlYWRzaGVldG1sLzIwMDYvbWFpbiIgeG1sbnM6cj0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL29mZmljZURvY3VtZW50LzIwMDYvcmVsYXRpb25zaGlwcyI+PGRpbWVuc2lvbiByZWY9IkExOkIxIi8+PHNoZWV0Vmlld3M+PHNoZWV0VmlldyB3b3JrYm9va1ZpZXdJZD0iMCIgcmlnaHRUb0xlZnQ9IjAiLz48L3NoZWV0Vmlld3M+PGNvbHM+PGNvbCBtaW49IjEiIG1heD0iMSIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSIxMC43MTA5Mzc1Ii8+PGNvbCBtaW49IjIiIG1heD0iMiIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSIyMy4yODUxNTYyNSIvPjwvY29scz48c2hlZXREYXRhPjxyb3cgcj0iMSI+PGMgcj0iQTEiIHQ9InN0ciI+PHY+RGF0ZTwvdj48L2M+PGMgcj0iQjEiIHQ9InN0ciI+PHY+Tm90ZTwvdj48L2M+PC9yb3c+PC9zaGVldERhdGE+PHBhZ2VNYXJnaW5zIGxlZnQ9IjAuNyIgcmlnaHQ9IjAuNyIgdG9wPSIwLjc1IiBib3R0b209IjAuNzUiIGhlYWRlcj0iMC4zIiBmb290ZXI9IjAuMyIvPjxpZ25vcmVkRXJyb3JzPjxpZ25vcmVkRXJyb3IgbnVtYmVyU3RvcmVkQXNUZXh0PSIxIiBzcXJlZj0iQTE6QjEiLz48L2lnbm9yZWRFcnJvcnM+PC93b3Jrc2hlZXQ+UEsDBBQAAAAAAAAAAABFA/xCOQMAADkDAAAYAAAAeGwvd29ya3NoZWV0cy9zaGVldDkueG1sPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/Pg0KPHdvcmtzaGVldCB4bWxucz0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL3NwcmVhZHNoZWV0bWwvMjAwNi9tYWluIiB4bWxuczpyPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzIj48ZGltZW5zaW9uIHJlZj0iQTE6QzEiLz48c2hlZXRWaWV3cz48c2hlZXRWaWV3IHdvcmtib29rVmlld0lkPSIwIiByaWdodFRvTGVmdD0iMCIvPjwvc2hlZXRWaWV3cz48Y29scz48Y29sIG1pbj0iMSIgbWF4PSIxIiBjdXN0b21XaWR0aD0iMSIgd2lkdGg9IjM3Ljg1NTQ2ODc1Ii8+PGNvbCBtaW49IjIiIG1heD0iMiIgY3VzdG9tV2lkdGg9IjEiIHdpZHRoPSI1My4yODUxNTYyNSIvPjxjb2wgbWluPSIzIiBtYXg9IjMiIGN1c3RvbVdpZHRoPSIxIiB3aWR0aD0iMzAuODU1NDY4NzUiLz48L2NvbHM+PHNoZWV0RGF0YT48cm93IHI9IjEiPjxjIHI9IkExIiB0PSJzdHIiPjx2Pk5hbWU8L3Y+PC9jPjxjIHI9IkIxIiB0PSJzdHIiPjx2PkVtYWlsPC92PjwvYz48YyByPSJDMSIgdD0ic3RyIj48dj5BbGlhcyBFbWFpbDwvdj48L2M+PC9yb3c+PC9zaGVldERhdGE+PHBhZ2VNYXJnaW5zIGxlZnQ9IjAuNyIgcmlnaHQ9IjAuNyIgdG9wPSIwLjc1IiBib3R0b209IjAuNzUiIGhlYWRlcj0iMC4zIiBmb290ZXI9IjAuMyIvPjxpZ25vcmVkRXJyb3JzPjxpZ25vcmVkRXJyb3IgbnVtYmVyU3RvcmVkQXNUZXh0PSIxIiBzcXJlZj0iQTE6QzEiLz48L2lnbm9yZWRFcnJvcnM+PC93b3Jrc2hlZXQ+UEsDBBQAAAAAAAAAAABggACBiAMAAIgDAAAPAAAAeGwvbWV0YWRhdGEueG1sPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/Pg0KPG1ldGFkYXRhIHhtbG5zPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvc3ByZWFkc2hlZXRtbC8yMDA2L21haW4iIHhtbG5zOnhscmQ9Imh0dHA6Ly9zY2hlbWFzLm1pY3Jvc29mdC5jb20vb2ZmaWNlL3NwcmVhZHNoZWV0bWwvMjAxNy9yaWNoZGF0YSIgeG1sbnM6eGRhPSJodHRwOi8vc2NoZW1hcy5taWNyb3NvZnQuY29tL29mZmljZS9zcHJlYWRzaGVldG1sLzIwMTcvZHluYW1pY2FycmF5Ij4KICA8bWV0YWRhdGFUeXBlcyBjb3VudD0iMSI+CiAgICA8bWV0YWRhdGFUeXBlIG5hbWU9IlhMREFQUiIgbWluU3VwcG9ydGVkVmVyc2lvbj0iMTIwMDAwIiBjb3B5PSIxIiBwYXN0ZUFsbD0iMSIgcGFzdGVWYWx1ZXM9IjEiIG1lcmdlPSIxIiBzcGxpdEZpcnN0PSIxIiByb3dDb2xTaGlmdD0iMSIgY2xlYXJGb3JtYXRzPSIxIiBjbGVhckNvbW1lbnRzPSIxIiBhc3NpZ249IjEiIGNvZXJjZT0iMSIgY2VsbE1ldGE9IjEiLz4KICA8L21ldGFkYXRhVHlwZXM+CiAgPGZ1dHVyZU1ldGFkYXRhIG5hbWU9IlhMREFQUiIgY291bnQ9IjEiPgogICAgPGJrPgogICAgICA8ZXh0THN0PgogICAgICAgIDxleHQgdXJpPSJ7YmRiYjhjZGMtZmExZS00OTZlLWE4NTctM2MzZjMwYzAyOWMzfSI+CiAgICAgICAgICA8eGRhOmR5bmFtaWNBcnJheVByb3BlcnRpZXMgZkR5bmFtaWM9IjEiIGZDb2xsYXBzZWQ9IjAiLz4KICAgICAgICA8L2V4dD4KICAgICAgPC9leHRMc3Q+CiAgICA8L2JrPgogIDwvZnV0dXJlTWV0YWRhdGE+CiAgPGNlbGxNZXRhZGF0YSBjb3VudD0iMSI+CiAgICA8Yms+CiAgICAgIDxyYyB0PSIxIiB2PSIwIi8+CiAgICA8L2JrPgogIDwvY2VsbE1ldGFkYXRhPgo8L21ldGFkYXRhPlBLAwQUAAAAAAAAAAAA0x5+DWUDAABlAwAADwAAAHhsL3dvcmtib29rLnhtbDw/eG1sIHZlcnNpb249IjEuMCIgZW5jb2Rpbmc9IlVURi04IiBzdGFuZGFsb25lPSJ5ZXMiPz4NCjx3b3JrYm9vayB4bWxucz0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL3NwcmVhZHNoZWV0bWwvMjAwNi9tYWluIiB4bWxuczpyPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzIj48d29ya2Jvb2tQciBjb2RlTmFtZT0iVGhpc1dvcmtib29rIiBkZWZhdWx0VGhlbWVWZXJzaW9uPSIxMjQyMjYiLz48Ym9va1ZpZXdzPjx3b3JrYm9va1ZpZXcgZmlyc3RTaGVldD0iMyIgYWN0aXZlVGFiPSIzIi8+PC9ib29rVmlld3M+PHNoZWV0cz48c2hlZXQgbmFtZT0iRW1haWwiIHNoZWV0SWQ9IjEiIHI6aWQ9InJJZDEiIHN0YXRlPSJ2ZXJ5SGlkZGVuIi8+PHNoZWV0IG5hbWU9Ik9wZW5TbG90cyIgc2hlZXRJZD0iMiIgcjppZD0icklkMiIgc3RhdGU9InZlcnlIaWRkZW4iLz48c2hlZXQgbmFtZT0iVGltZU9mZlJlYXNvbiIgc2hlZXRJZD0iMyIgcjppZD0icklkMyIgc3RhdGU9InZlcnlIaWRkZW4iLz48c2hlZXQgbmFtZT0iSW5zdHJ1Y3Rpb25zIiBzaGVldElkPSI0IiByOmlkPSJySWQ0Ii8+PHNoZWV0IG5hbWU9IlNoaWZ0cyIgc2hlZXRJZD0iNSIgcjppZD0icklkNSIvPjxzaGVldCBuYW1lPSJUaW1lIE9mZiIgc2hlZXRJZD0iNiIgcjppZD0icklkNiIvPjxzaGVldCBuYW1lPSJPcGVuIFNoaWZ0cyIgc2hlZXRJZD0iNyIgcjppZD0icklkNyIvPjxzaGVldCBuYW1lPSJEYXkgTm90ZXMiIHNoZWV0SWQ9IjgiIHI6aWQ9InJJZDgiLz48c2hlZXQgbmFtZT0iTWVtYmVycyIgc2hlZXRJZD0iOSIgcjppZD0icklkOSIvPjwvc2hlZXRzPjwvd29ya2Jvb2s+UEsDBBQAAAAAAAAAAABKahH5TAIAAEwCAAALAAAAX3JlbHMvLnJlbHM8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJVVEYtOCIgc3RhbmRhbG9uZT0ieWVzIj8+DQo8UmVsYXRpb25zaGlwcyB4bWxucz0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL3BhY2thZ2UvMjAwNi9yZWxhdGlvbnNoaXBzIj48UmVsYXRpb25zaGlwIElkPSJySWQyIiBUeXBlPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvcGFja2FnZS8yMDA2L3JlbGF0aW9uc2hpcHMvbWV0YWRhdGEvY29yZS1wcm9wZXJ0aWVzIiBUYXJnZXQ9ImRvY1Byb3BzL2NvcmUueG1sIi8+PFJlbGF0aW9uc2hpcCBJZD0icklkMyIgVHlwZT0iaHR0cDovL3NjaGVtYXMub3BlbnhtbGZvcm1hdHMub3JnL29mZmljZURvY3VtZW50LzIwMDYvcmVsYXRpb25zaGlwcy9leHRlbmRlZC1wcm9wZXJ0aWVzIiBUYXJnZXQ9ImRvY1Byb3BzL2FwcC54bWwiLz48UmVsYXRpb25zaGlwIElkPSJySWQxIiBUeXBlPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9yZWxhdGlvbnNoaXBzL29mZmljZURvY3VtZW50IiBUYXJnZXQ9InhsL3dvcmtib29rLnhtbCIvPjwvUmVsYXRpb25zaGlwcz5QSwMEFAAAAAAAAAAAAIkuYgboAwAA6AMAABAAAABkb2NQcm9wcy9hcHAueG1sPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/Pg0KPFByb3BlcnRpZXMgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm9wZW54bWxmb3JtYXRzLm9yZy9vZmZpY2VEb2N1bWVudC8yMDA2L2V4dGVuZGVkLXByb3BlcnRpZXMiIHhtbG5zOnZ0PSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvb2ZmaWNlRG9jdW1lbnQvMjAwNi9kb2NQcm9wc1ZUeXBlcyI+PEFwcGxpY2F0aW9uPlNoZWV0SlM8L0FwcGxpY2F0aW9uPjxBcHBWZXJzaW9uPjEyLjAwMDA8L0FwcFZlcnNpb24+PERvY1NlY3VyaXR5PjA8L0RvY1NlY3VyaXR5PjxIeXBlcmxpbmtzQ2hhbmdlZD5mYWxzZTwvSHlwZXJsaW5rc0NoYW5nZWQ+PFNoYXJlZERvYz5mYWxzZTwvU2hhcmVkRG9jPjxMaW5rc1VwVG9EYXRlPmZhbHNlPC9MaW5rc1VwVG9EYXRlPjxTY2FsZUNyb3A+ZmFsc2U8L1NjYWxlQ3JvcD48SGVhZGluZ1BhaXJzPjx2dDp2ZWN0b3Igc2l6ZT0iMiIgYmFzZVR5cGU9InZhcmlhbnQiPjx2dDp2YXJpYW50Pjx2dDpscHN0cj5Xb3Jrc2hlZXRzPC92dDpscHN0cj48L3Z0OnZhcmlhbnQ+PHZ0OnZhcmlhbnQ+PHZ0Omk0Pjk8L3Z0Omk0PjwvdnQ6dmFyaWFudD48L3Z0OnZlY3Rvcj48L0hlYWRpbmdQYWlycz48VGl0bGVzT2ZQYXJ0cz48dnQ6dmVjdG9yIHNpemU9IjkiIGJhc2VUeXBlPSJscHN0ciI+PHZ0Omxwc3RyPkVtYWlsPC92dDpscHN0cj48dnQ6bHBzdHI+T3BlblNsb3RzPC92dDpscHN0cj48dnQ6bHBzdHI+VGltZU9mZlJlYXNvbjwvdnQ6bHBzdHI+PHZ0Omxwc3RyPkluc3RydWN0aW9uczwvdnQ6bHBzdHI+PHZ0Omxwc3RyPlNoaWZ0czwvdnQ6bHBzdHI+PHZ0Omxwc3RyPlRpbWUgT2ZmPC92dDpscHN0cj48dnQ6bHBzdHI+T3BlbiBTaGlmdHM8L3Z0Omxwc3RyPjx2dDpscHN0cj5EYXkgTm90ZXM8L3Z0Omxwc3RyPjx2dDpscHN0cj5NZW1iZXJzPC92dDpscHN0cj48L3Z0OnZlY3Rvcj48L1RpdGxlc09mUGFydHM+PC9Qcm9wZXJ0aWVzPlBLAwQUAAAAAAAAAAAAd/aK/2UCAABlAgAAEQAAAGRvY1Byb3BzL2NvcmUueG1sPD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9InllcyI/Pg0KPGNwOmNvcmVQcm9wZXJ0aWVzIHhtbG5zOmNwPSJodHRwOi8vc2NoZW1hcy5vcGVueG1sZm9ybWF0cy5vcmcvcGFja2FnZS8yMDA2L21ldGFkYXRhL2NvcmUtcHJvcGVydGllcyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB4bWxuczpkY3Rlcm1zPSJodHRwOi8vcHVybC5vcmcvZGMvdGVybXMvIiB4bWxuczpkY21pdHlwZT0iaHR0cDovL3B1cmwub3JnL2RjL2RjbWl0eXBlLyIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSI+PGRjdGVybXM6Y3JlYXRlZCB4c2k6dHlwZT0iZGN0ZXJtczpXM0NEVEYiPjIwMjYtMDItMTJUMjM6MDE6NThaPC9kY3Rlcm1zOmNyZWF0ZWQ+PGRjdGVybXM6bW9kaWZpZWQgeHNpOnR5cGU9ImRjdGVybXM6VzNDRFRGIj4yMDI2LTAyLTEyVDIzOjAxOjU5WjwvZGN0ZXJtczptb2RpZmllZD48Y3A6bGFzdE1vZGlmaWVkQnk+UVVBUkFOVElORTwvY3A6bGFzdE1vZGlmaWVkQnk+PGRjOmNyZWF0b3I+UVVBUkFOVElORTwvZGM6Y3JlYXRvcj48L2NwOmNvcmVQcm9wZXJ0aWVzPlBLAwQUAAAAAAAAAAAAVAR/0lUMAABVDAAAEwAAAFtDb250ZW50X1R5cGVzXS54bWw8P3htbCB2ZXJzaW9uPSIxLjAiIGVuY29kaW5nPSJVVEYtOCIgc3RhbmRhbG9uZT0ieWVzIj8+DQo8VHlwZXMgeG1sbnM9Imh0dHA6Ly9zY2hlbWFzLm9wZW54bWxmb3JtYXRzLm9yZy9wYWNrYWdlLzIwMDYvY29udGVudC10eXBlcyIgeG1sbnM6eHNkPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYSIgeG1sbnM6eHNpPSJodHRwOi8vd3d3LnczLm9yZy8yMDAxL1hNTFNjaGVtYS1pbnN0YW5jZSI+PERlZmF1bHQgRXh0ZW5zaW9uPSJ4bWwiIENvbnRlbnRUeXBlPSJhcHBsaWNhdGlvbi94bWwiLz48RGVmYXVsdCBFeHRlbnNpb249ImJpbiIgQ29udGVudFR5cGU9ImFwcGxpY2F0aW9uL3ZuZC5tcy1leGNlbC5zaGVldC5iaW5hcnkubWFjcm9FbmFibGVkLm1haW4iLz48RGVmYXVsdCBFeHRlbnNpb249InZtbCIgQ29udGVudFR5cGU9ImFwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC52bWxEcmF3aW5nIi8+PERlZmF1bHQgRXh0ZW5zaW9uPSJkYXRhIiBDb250ZW50VHlwZT0iYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50Lm1vZGVsK2RhdGEiLz48RGVmYXVsdCBFeHRlbnNpb249ImJtcCIgQ29udGVudFR5cGU9ImltYWdlL2JtcCIvPjxEZWZhdWx0IEV4dGVuc2lvbj0icG5nIiBDb250ZW50VHlwZT0iaW1hZ2UvcG5nIi8+PERlZmF1bHQgRXh0ZW5zaW9uPSJnaWYiIENvbnRlbnRUeXBlPSJpbWFnZS9naWYiLz48RGVmYXVsdCBFeHRlbnNpb249ImVtZiIgQ29udGVudFR5cGU9ImltYWdlL3gtZW1mIi8+PERlZmF1bHQgRXh0ZW5zaW9uPSJ3bWYiIENvbnRlbnRUeXBlPSJpbWFnZS94LXdtZiIvPjxEZWZhdWx0IEV4dGVuc2lvbj0ianBnIiBDb250ZW50VHlwZT0iaW1hZ2UvanBlZyIvPjxEZWZhdWx0IEV4dGVuc2lvbj0ianBlZyIgQ29udGVudFR5cGU9ImltYWdlL2pwZWciLz48RGVmYXVsdCBFeHRlbnNpb249InRpZiIgQ29udGVudFR5cGU9ImltYWdlL3RpZmYiLz48RGVmYXVsdCBFeHRlbnNpb249InRpZmYiIENvbnRlbnRUeXBlPSJpbWFnZS90aWZmIi8+PERlZmF1bHQgRXh0ZW5zaW9uPSJwZGYiIENvbnRlbnRUeXBlPSJhcHBsaWNhdGlvbi9wZGYiLz48RGVmYXVsdCBFeHRlbnNpb249InJlbHMiIENvbnRlbnRUeXBlPSJhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtcGFja2FnZS5yZWxhdGlvbnNoaXBzK3htbCIvPjxPdmVycmlkZSBQYXJ0TmFtZT0iL3hsL3dvcmtib29rLnhtbCIgQ29udGVudFR5cGU9ImFwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLnNoZWV0Lm1haW4reG1sIi8+PE92ZXJyaWRlIFBhcnROYW1lPSIveGwvd29ya3NoZWV0cy9zaGVldDEueG1sIiBDb250ZW50VHlwZT0iYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnNwcmVhZHNoZWV0bWwud29ya3NoZWV0K3htbCIvPjxPdmVycmlkZSBQYXJ0TmFtZT0iL3hsL3dvcmtzaGVldHMvc2hlZXQyLnhtbCIgQ29udGVudFR5cGU9ImFwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLndvcmtzaGVldCt4bWwiLz48T3ZlcnJpZGUgUGFydE5hbWU9Ii94bC93b3Jrc2hlZXRzL3NoZWV0My54bWwiIENvbnRlbnRUeXBlPSJhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuc3ByZWFkc2hlZXRtbC53b3Jrc2hlZXQreG1sIi8+PE92ZXJyaWRlIFBhcnROYW1lPSIveGwvd29ya3NoZWV0cy9zaGVldDQueG1sIiBDb250ZW50VHlwZT0iYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnNwcmVhZHNoZWV0bWwud29ya3NoZWV0K3htbCIvPjxPdmVycmlkZSBQYXJ0TmFtZT0iL3hsL3dvcmtzaGVldHMvc2hlZXQ1LnhtbCIgQ29udGVudFR5cGU9ImFwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLndvcmtzaGVldCt4bWwiLz48T3ZlcnJpZGUgUGFydE5hbWU9Ii94bC93b3Jrc2hlZXRzL3NoZWV0Ni54bWwiIENvbnRlbnRUeXBlPSJhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuc3ByZWFkc2hlZXRtbC53b3Jrc2hlZXQreG1sIi8+PE92ZXJyaWRlIFBhcnROYW1lPSIveGwvd29ya3NoZWV0cy9zaGVldDcueG1sIiBDb250ZW50VHlwZT0iYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnNwcmVhZHNoZWV0bWwud29ya3NoZWV0K3htbCIvPjxPdmVycmlkZSBQYXJ0TmFtZT0iL3hsL3dvcmtzaGVldHMvc2hlZXQ4LnhtbCIgQ29udGVudFR5cGU9ImFwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC5zcHJlYWRzaGVldG1sLndvcmtzaGVldCt4bWwiLz48T3ZlcnJpZGUgUGFydE5hbWU9Ii94bC93b3Jrc2hlZXRzL3NoZWV0OS54bWwiIENvbnRlbnRUeXBlPSJhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuc3ByZWFkc2hlZXRtbC53b3Jrc2hlZXQreG1sIi8+PE92ZXJyaWRlIFBhcnROYW1lPSIveGwvdGhlbWUvdGhlbWUxLnhtbCIgQ29udGVudFR5cGU9ImFwcGxpY2F0aW9uL3ZuZC5vcGVueG1sZm9ybWF0cy1vZmZpY2Vkb2N1bWVudC50aGVtZSt4bWwiLz48T3ZlcnJpZGUgUGFydE5hbWU9Ii94bC9zdHlsZXMueG1sIiBDb250ZW50VHlwZT0iYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLW9mZmljZWRvY3VtZW50LnNwcmVhZHNoZWV0bWwuc3R5bGVzK3htbCIvPjxPdmVycmlkZSBQYXJ0TmFtZT0iL2RvY1Byb3BzL2NvcmUueG1sIiBDb250ZW50VHlwZT0iYXBwbGljYXRpb24vdm5kLm9wZW54bWxmb3JtYXRzLXBhY2thZ2UuY29yZS1wcm9wZXJ0aWVzK3htbCIvPjxPdmVycmlkZSBQYXJ0TmFtZT0iL2RvY1Byb3BzL2FwcC54bWwiIENvbnRlbnRUeXBlPSJhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuZXh0ZW5kZWQtcHJvcGVydGllcyt4bWwiLz48T3ZlcnJpZGUgUGFydE5hbWU9Ii94bC9tZXRhZGF0YS54bWwiIENvbnRlbnRUeXBlPSJhcHBsaWNhdGlvbi92bmQub3BlbnhtbGZvcm1hdHMtb2ZmaWNlZG9jdW1lbnQuc3ByZWFkc2hlZXRtbC5zaGVldE1ldGFkYXRhK3htbCIvPjwvVHlwZXM+UEsBAgAAFAAAAAAAAAAAAD4cAKIgBwAAIAcAABoAAAAAAAAAAAAAAAAAAAAAAHhsL19yZWxzL3dvcmtib29rLnhtbC5yZWxzUEsBAgAAFAAAAAAAAAAAAOyRzqO5GwAAuRsAABMAAAAAAAAAAAAAAAAAWAcAAHhsL3RoZW1lL3RoZW1lMS54bWxQSwECAAAUAAAAAAAAAAAAVfQElFoEAABaBAAADQAAAAAAAAAAAAAAAABCIwAAeGwvc3R5bGVzLnhtbFBLAQIAABQAAAAAAAAAAACnS4zK8QEAAPEBAAAYAAAAAAAAAAAAAAAAAMcnAAB4bC93b3Jrc2hlZXRzL3NoZWV0MS54bWxQSwECAAAUAAAAAAAAAAAAXoibu5UtAACVLQAAGAAAAAAAAAAAAAAAAADuKQAAeGwvd29ya3NoZWV0cy9zaGVldDIueG1sUEsBAgAAFAAAAAAAAAAAAFvm9kjwAwAA8AMAABgAAAAAAAAAAAAAAAAAuVcAAHhsL3dvcmtzaGVldHMvc2hlZXQzLnhtbFBLAQIAABQAAAAAAAAAAAC4Gb4sfAcAAHwHAAAYAAAAAAAAAAAAAAAAAN9bAAB4bC93b3Jrc2hlZXRzL3NoZWV0NC54bWxQSwECAAAUAAAAAAAAAAAAB8IQHpUGAACVBgAAGAAAAAAAAAAAAAAAAACRYwAAeGwvd29ya3NoZWV0cy9zaGVldDUueG1sUEsBAgAAFAAAAAAAAAAAAEEPJZrOBQAAzgUAABgAAAAAAAAAAAAAAAAAXGoAAHhsL3dvcmtzaGVldHMvc2hlZXQ2LnhtbFBLAQIAABQAAAAAAAAAAABGgewlPAYAADwGAAAYAAAAAAAAAAAAAAAAAGBwAAB4bC93b3Jrc2hlZXRzL3NoZWV0Ny54bWxQSwECAAAUAAAAAAAAAAAAU0YQH9UCAADVAgAAGAAAAAAAAAAAAAAAAADSdgAAeGwvd29ya3NoZWV0cy9zaGVldDgueG1sUEsBAgAAFAAAAAAAAAAAAEUD/EI5AwAAOQMAABgAAAAAAAAAAAAAAAAA3XkAAHhsL3dvcmtzaGVldHMvc2hlZXQ5LnhtbFBLAQIAABQAAAAAAAAAAABggACBiAMAAIgDAAAPAAAAAAAAAAAAAAAAAEx9AAB4bC9tZXRhZGF0YS54bWxQSwECAAAUAAAAAAAAAAAA0x5+DWUDAABlAwAADwAAAAAAAAAAAAAAAAABgQAAeGwvd29ya2Jvb2sueG1sUEsBAgAAFAAAAAAAAAAAAEpqEflMAgAATAIAAAsAAAAAAAAAAAAAAAAAk4QAAF9yZWxzLy5yZWxzUEsBAgAAFAAAAAAAAAAAAIkuYgboAwAA6AMAABAAAAAAAAAAAAAAAAAACIcAAGRvY1Byb3BzL2FwcC54bWxQSwECAAAUAAAAAAAAAAAAd/aK/2UCAABlAgAAEQAAAAAAAAAAAAAAAAAeiwAAZG9jUHJvcHMvY29yZS54bWxQSwECAAAUAAAAAAAAAAAAVAR/0lUMAABVDAAAEwAAAAAAAAAAAAAAAACyjQAAW0NvbnRlbnRfVHlwZXNdLnhtbFBLBQYAAAAAEgASAKsEAAA4mgAAAAA=";

function _fmtDateSlash(d) { return (d.getMonth()+1) + "/" + d.getDate() + "/" + d.getFullYear(); }

function _buildOTRows() {
  const needs = computeOTNeeds();
  const rows = [];
  const [yr, mo] = currentMonth.split('-').map(Number);
  const roleSuffix = currentRole === 'CALLTAKER' ? 'CT' : currentRole === 'PIC' ? 'PIC' : 'DP';
  for (const d of needs) {
    const dateObj = new Date(yr, mo - 1, d.date);
    for (const b of d.blocks) {
      const bt = _OT_BLOCK_TIME_MAP[b.label];
      if (!bt) continue;
      let startDate = new Date(dateObj.getFullYear(), dateObj.getMonth(), dateObj.getDate());
      if (bt.startNextDay) startDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + 1);
      let endDate = new Date(startDate);
      if (bt.nextDay) endDate = new Date(startDate.getFullYear(), startDate.getMonth(), startDate.getDate() + 1);
      rows.push({
        'Group': 'ECC OT',
        'Start Date': _fmtDateSlash(startDate),
        'Start Time': bt.startTime,
        'End Date': _fmtDateSlash(endDate),
        'End Time': bt.endTime,
        'Open Slots': b.need,
        'Theme Color': '8. DarkBlue',
        'Custom Label': '',
        'Unpaid Break (minutes)': '',
        'Notes': bt.key + ' ' + roleSuffix,
        'Shared': '1. Shared'
      });
    }
  }
  return rows;
}

function exportOTNeedsXlsx() {
  const rows = _buildOTRows();
  if (!rows.length) { showToast('No OT needs to export — adequate staffing.'); return; }
  const templateBytes = Uint8Array.from(atob(_TEMPLATE_B64), c => c.charCodeAt(0));
  const wb = XLSX.read(templateBytes, { type: 'array' });
  const header = ['Group','Start Date','Start Time','End Date','End Time','Open Slots','Theme Color','Custom Label','Unpaid Break (minutes)','Notes','Shared'];
  const dataOnly = rows.map(r => header.map(h => r[h] !== undefined ? r[h] : ''));
  XLSX.utils.sheet_add_aoa(wb.Sheets['Open Shifts'], dataOnly, { origin: 'A2' });
  XLSX.writeFile(wb, 'Open_Shifts_' + currentMonth + '_' + currentRole + '.xlsx');
  showToast('Exported ' + rows.length + ' OT shift(s) to XLSX');
}

// ========== STAFFING CALCULATION ==========
function shiftCoversBlock(shiftCode, block) {
  const code = String(shiftCode || "").trim().toUpperCase();
  const range = SHIFT_CODES[code];
  if (!range) return false;
  if (block.start >= range[0] && block.end <= range[1]) return true;
  // Wrap-around for shifts starting before 6AM (e.g. 2A-2P covers both overnight 2A-5A AND daytime 6A-1P)
  if (range[0] < 6 && block.start >= range[0] + 24 && block.end <= range[1] + 24) return true;
  return false;
}

function adeqLookup(node, hk) {
  if (!node) return undefined;
  const candidates = [hk];
  const n = parseInt(hk, 10);
  if (Number.isFinite(n)) candidates.push(String(n));
  if (hk && hk.length === 4) candidates.push(hk.replace(/^0+/, '') || "0");
  for (const k of candidates) {
    if (k == null) continue;
    const kk = String(k);
    if (Object.prototype.hasOwnProperty.call(node, kk) && node[kk] !== undefined && node[kk] !== null && node[kk] !== "") {
      return Number(node[kk]);
    }
  }
  return undefined;
}

function getNeededForBlock(day, block) {
  const node = ADEQ[day];
  if (!node) return 10;
  const realHour = block.start % 24;
  const hk = String(realHour).padStart(2, "0") + "00";
  const val = adeqLookup(node, hk);
  return (val !== undefined && val > 0) ? val : 10;
}

function computeStaffing(skipHypos, hyposOverride) {
  const grid = []; // grid[dayIdx][blockIdx]
  const summary = [];
  const peopleLists = []; // peopleLists[dayIdx][blockIdx] = [names]

  // Determine which hypos to use
  const hypos = skipHypos ? [] : (hyposOverride !== undefined ? hyposOverride : getAppliedHypos());
  const hypoActive = !skipHypos && hypos.length > 0 && (hyposOverride !== undefined || _hypoApplied);

  // Build set of dispatcher indices replaced by applied hypotheticals
  const hypoReplacedIdx = new Set();
  if (hypoActive) {
    for (const h of hypos) {
      if (h._enabled === false) continue;
      if (h.sourceIdx !== undefined && h.sourceIdx !== null) hypoReplacedIdx.add(h.sourceIdx);
    }
  }

  for (let di = 0; di < 7; di++) {
    const day = DAYS[di];
    const dayRow = [];
    const dayPeople = [];
    let dayShortfall = 0;

    for (let bi = 0; bi < BLOCKS.length; bi++) {
      const block = BLOCKS[bi];
      let current = 0;
      const names = [];

      for (let i = 0; i < dispatchers.length; i++) {
        if (excluded.has(i)) continue;
        if (hypoReplacedIdx.has(i)) continue; // replaced by hypothetical
        if (shiftCoversBlock(dispatchers[i].schedule[day], block)) {
          current++;
          names.push(dispatchers[i].name);
        }
      }
      if (hypoActive) {
        for (const h of hypos) {
          if (h._enabled === false) continue;
          const hCode = String(h.schedule[day] || '').trim().toUpperCase();
          if (!hCode || hCode === 'OFF') continue;
          // Resolve range — self-repair if SHIFT_CODES missing
          let rng = SHIFT_CODES[hCode];
          if (!rng) {
            const p = parseCustomShift(hCode);
            if (p) { rng = [p.start, p.end]; SHIFT_CODES[p.code] = rng; SHIFT_HOURS[p.code] = p.hours; }
          }
          if (rng && ((block.start >= rng[0] && block.end <= rng[1]) || (rng[0] < 6 && block.start >= rng[0] + 24 && block.end <= rng[1] + 24))) {
            current++;
            names.push(h.name + (h.sourceIdx !== undefined && h.sourceIdx !== null ? ' (mod)' : ' *'));
          }
        }
      }

      const needed = getNeededForBlock(day, block);
      const delta = current - needed;
      const status = delta < 0 ? "short" : delta === 0 ? "adequate" : "over";
      if (delta < 0) dayShortfall += Math.abs(delta);

      dayRow.push({ current, needed, delta, status });
      dayPeople.push(names);
    }

    grid.push(dayRow);
    summary.push(dayShortfall);
    peopleLists.push(dayPeople);
  }

  return { grid, summary, peopleLists };
}

function weeklyHours(schedule) {
  let total = 0;
  for (const day of DAYS) {
    const code = String(schedule[day] || "").toUpperCase();
    if (SHIFT_HOURS[code] !== undefined) { total += SHIFT_HOURS[code]; continue; }
    // Fallback for custom shifts not yet in SHIFT_HOURS
    const rng = SHIFT_CODES[code];
    if (rng) { total += rng[1] - rng[0]; continue; }
    const p = parseCustomShift(code);
    if (p) { total += p.hours; SHIFT_HOURS[p.code] = p.hours; SHIFT_CODES[p.code] = [p.start, p.end]; }
  }
  return total;
}

// ========== HIRE NEEDS CALCULATOR ==========
// All new hires work 40h/week = 8h shifts × 5 days on, 2 days off
// 6A-2P (day): covers blocks 0-7 (6A through 1P)
// 2P-10P (swing): covers blocks 8-15 (2P through 9P)
// 10P-6A (night): covers blocks 16-23 (10P through 5A)
// No overlap — each shift covers its own 8-hour window exclusively
function computeHireNeeds() {
  const { grid } = computeStaffing();
  const morningNeed = [], swingNeed = [], nightNeed = [];

  for (let d = 0; d < 7; d++) {
    // Morning (6A-2P): max shortfall in blocks 1-7 (7A-1P)
    // Block 0 (6A) is typically overstaffed so the binding gap is 7A+
    let morn = 0;
    for (let b = 1; b <= 7; b++) {
      if (grid[d][b].delta < 0) morn = Math.max(morn, Math.abs(grid[d][b].delta));
    }
    morningNeed.push(morn);

    // Swing (2P-10P): max shortfall in blocks 8-15 (2P-9P)
    let swing = 0;
    for (let b = 8; b <= 15; b++) {
      if (grid[d][b].delta < 0) swing = Math.max(swing, Math.abs(grid[d][b].delta));
    }
    swingNeed.push(swing);

    // Night (10P-6A): max shortfall in blocks 16-23 (10P-5A)
    let night = 0;
    for (let b = 16; b <= 23; b++) {
      if (grid[d][b].delta < 0) night = Math.max(night, Math.abs(grid[d][b].delta));
    }
    nightNeed.push(night);
  }

  // Min hires = max(ceil(totalBodyDays / 5), peakSingleDay)
  function calcHires(daily) {
    const total = daily.reduce((a, b) => a + b, 0);
    if (total === 0) return 0;
    return Math.max(Math.ceil(total / 5), Math.max(...daily));
  }

  const mHires = calcHires(morningNeed);
  const sHires = calcHires(swingNeed);
  const nHires = calcHires(nightNeed);

  let shortfalls = 0;
  for (let d = 0; d < 7; d++) for (let b = 0; b < BLOCKS.length; b++) {
    if (grid[d][b].delta < 0) shortfalls++;
  }

  return { morning: mHires, swing: sHires, night: nHires, total: mHires + sHires + nHires, shortfalls };
}

function renderHirePanel() {}

// ========== OT ASSIGNMENT ==========
function saveOTAssignments() {
  _saveTs = Date.now();
  SETTINGS_REF.set({ otAssignments: _otAssignments }, { merge: true });
}

function getOTAvailable(dayOfMonth, blockIdx) {
  const key = dayOfMonth + '-' + blockIdx;
  const [yr, mo] = currentMonth.split('-').map(Number);
  const dateObj = new Date(yr, mo - 1, dayOfMonth);
  const jsDay2idx = { 0:6, 1:0, 2:1, 3:2, 4:3, 5:4, 6:5 };
  const dayIdx = jsDay2idx[dateObj.getDay()];
  const day = DAYS[dayIdx];
  // Build set of everyone already working this block (across ALL positions)
  const workingSet = new Set();
  for (const emp of _ALL_EMPLOYEES) {
    if (isOnVacationDate(emp.name, dateObj)) continue;
    const ob = OT_BLOCKS[blockIdx];
    for (const bi of ob.blockIdxs) {
      if (shiftCoversBlock(emp.schedule[day], BLOCKS[bi])) { workingSet.add(emp.name.toUpperCase()); break; }
    }
  }
  const ctNames = _ctAssignments[key] || [];
  for (const n of ctNames) workingSet.add(n.toUpperCase());
  const assigned = (_otAssignments[key] || []).map(n => n.toUpperCase());
  // Group available by position
  const groups = {};
  for (const emp of _ALL_EMPLOYEES) {
    const nm = emp.name.toUpperCase();
    if (workingSet.has(nm)) continue;
    if (isOnVacationDate(emp.name, dateObj)) continue;
    if (assigned.includes(nm)) continue;
    const pos = emp.position || 'OTHER';
    if (!groups[pos]) groups[pos] = [];
    groups[pos].push(emp.name);
  }
  return groups;
}

let _otAssignCtx = null; // { dayOfMonth, blockIdx }

function openOTAssignBox(dayOfMonth, blockIdx) {
  _otAssignCtx = { dayOfMonth, blockIdx };
  const [yr, mo] = currentMonth.split('-').map(Number);
  const dateObj = new Date(yr, mo - 1, dayOfMonth);
  const DOW = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  document.getElementById('otAssignTitle').textContent = 'ASSIGN OT SLOT';
  document.getElementById('otAssignInfo').textContent = DOW[dateObj.getDay()] + ' ' + mo + '/' + dayOfMonth + ' — ' + OT_BLOCKS[blockIdx].label;
  const sel = document.getElementById('otAssignSelect');
  sel.innerHTML = '<option value="">Select person...</option>';
  const groups = getOTAvailable(dayOfMonth, blockIdx);
  // Show current role first, then others
  const posOrder = ['CALLTAKER','DISPATCHER','PIC','SUPERVISOR'];
  const roleLabel = ROLE_CONFIG[currentRole]?.label || currentRole;
  // Put matching positions first
  const sorted = Object.keys(groups).sort((a, b) => {
    const ai = posOrder.indexOf(a), bi2 = posOrder.indexOf(b);
    return (ai === -1 ? 99 : ai) - (bi2 === -1 ? 99 : bi2);
  });
  for (const pos of sorted) {
    const names = groups[pos];
    if (!names.length) continue;
    const grp = document.createElement('optgroup');
    grp.label = pos + 'S';
    for (const nm of names) {
      const opt = document.createElement('option');
      opt.value = nm;
      opt.textContent = nm;
      grp.appendChild(opt);
    }
    sel.appendChild(grp);
  }
  document.getElementById('otAssignBackdrop').classList.add('show');
  document.getElementById('otAssignBox').classList.add('show');
}

function closeOTAssignBox() {
  document.getElementById('otAssignBackdrop').classList.remove('show');
  document.getElementById('otAssignBox').classList.remove('show');
  _otAssignCtx = null;
}

document.getElementById('btnOtAssign').addEventListener('click', () => {
  if (!_otAssignCtx) return;
  const name = document.getElementById('otAssignSelect').value;
  if (!name) return;
  const { dayOfMonth, blockIdx } = _otAssignCtx;
  const key = dayOfMonth + '-' + blockIdx;
  if (!_otAssignments[key]) _otAssignments[key] = [];
  if (!_otAssignments[key].includes(name)) {
    _otAssignments[key].push(name);
    saveOTAssignments();
    renderMonthlyOTView();
  }
  closeOTAssignBox();
});

document.getElementById('btnOtAssignCancel').addEventListener('click', closeOTAssignBox);
document.getElementById('otAssignBackdrop').addEventListener('click', closeOTAssignBox);

function removeOTAssign(name, dayOfMonth, blockIdx) {
  const key = dayOfMonth + '-' + blockIdx;
  if (!_otAssignments[key]) return;
  _otAssignments[key] = _otAssignments[key].filter(n => n !== name);
  if (_otAssignments[key].length === 0) delete _otAssignments[key];
  saveOTAssignments();
  renderMonthlyOTView();
}

// ========== RENDERING ==========
function renderAll() {
  const mode = document.getElementById('viewMode')?.value || 'ot';
  const staffingView = document.getElementById('staffingView');
  const otMonthView = document.getElementById('otMonthView');
  const hypoBtn = document.getElementById('btnHypoDrawer');
  const printBtn = document.getElementById('btnPrintChanges');
  const exportBtn = document.getElementById('btnExport');
  const resetBtn = document.getElementById('btnReset');
  const rosterBtn = document.getElementById('btnCollapseRoster');
  const gridPanel = document.getElementById('gridPanel');
  const mainLayout = gridPanel.parentElement;
  if (mode === 'staffing') {
    staffingView.style.display = '';
    otMonthView.style.display = 'none';
    otMonthView.style.flex = '';
    if (hypoBtn) hypoBtn.style.display = '';
    if (printBtn) printBtn.style.display = '';
    if (exportBtn) exportBtn.style.display = '';
    if (resetBtn) resetBtn.style.display = '';
    gridPanel.style.overflowX = '';
    gridPanel.style.overflowY = '';
    gridPanel.style.overflow = 'auto';
    mainLayout.style.height = 'calc(100vh - 52px)';
    mainLayout.style.overflow = 'hidden';
    renderGrid();
    renderStatusBar();
  } else {
    staffingView.style.display = 'none';
    otMonthView.style.display = 'flex';
    otMonthView.style.flexDirection = 'column';
    otMonthView.style.flex = '1';
    otMonthView.style.overflow = 'hidden';
    if (hypoBtn) hypoBtn.style.display = 'none';
    if (printBtn) printBtn.style.display = 'none';
    if (exportBtn) exportBtn.style.display = 'none';
    if (resetBtn) resetBtn.style.display = 'none';
    gridPanel.style.overflow = 'hidden';
    gridPanel.style.overflowX = 'hidden';
    gridPanel.style.overflowY = 'hidden';
    mainLayout.style.height = 'calc(100vh - 52px)';
    mainLayout.style.overflow = 'hidden';
    toggleHypoDrawer(false);
    renderMonthlyOTView();
  }
  renderRoster();
  renderHypoSection();
  renderVacSection();
  renderImpact();
  renderHeader();
  renderHirePanel();
  updateMonthLabel();
}
function updateMonthLabel() {
  const MONTHS = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
  const parts = currentMonth.split('-');
  const label = MONTHS[parseInt(parts[1]) - 1] + ' ' + parts[0];
  document.getElementById('gridMonthLabel').textContent = label;
}

function renderStatusBar() {
  const { grid } = computeStaffing();
  // Count number of hour blocks that are short
  let shortSlots = 0;
  for (let d = 0; d < 7; d++) for (let b = 0; b < BLOCKS.length; b++) {
    if (grid[d][b].delta < 0) shortSlots++;
  }
  const bar = document.getElementById('statusBar');
  let html = '';

  html += '<div class="sb-item"><span class="sb-label">SHORTFALLS:</span><span class="sb-val ' + (shortSlots > 0 ? 'short' : 'ok') + '">' + shortSlots + (shortSlots !== 1 ? ' SLOTS' : ' SLOT') + '</span></div>';

  const hasChanges = modifications.size > 0 || excluded.size > 0 || (_hypoApplied && getAppliedHypos().filter(h => h._enabled !== false).length > 0);
  if (hasChanges) {
    const delta = shortSlots - BASELINE_SHORTFALL;
    let deltaText, deltaCls;
    if (delta < 0) { deltaText = 'Improved by ' + Math.abs(delta); deltaCls = 'improved'; }
    else if (delta > 0) { deltaText = 'Worsened by ' + delta; deltaCls = 'worsened'; }
    else { deltaText = 'No change'; deltaCls = 'neutral'; }
    html += '<div class="sb-sep"></div>';
    html += '<div class="sb-item"><span class="sb-label">BASELINE:</span><span class="sb-val">' + BASELINE_SHORTFALL + (BASELINE_SHORTFALL !== 1 ? ' SLOTS' : ' SLOT') + '</span></div>';
    html += '<div class="sb-sep"></div>';
    html += '<span class="sb-delta ' + deltaCls + '">' + deltaText + '</span>';
  }

  bar.innerHTML = html;
}

function renderGrid() {
  const { grid, summary, peopleLists } = computeStaffing();
  const appliedH = getAppliedHypos();
  const noHypoGrid = (_hypoApplied && appliedH.length > 0) ? computeStaffing(true).grid : null;

  // Debug: log hypothetical impact per cell
  if (_hypoApplied && appliedH.length > 0 && noHypoGrid) {
    console.group('%c[StaffingOps] Hypothetical Debug', 'color:#38bdf8;font-weight:bold');
    for (const h of appliedH) {
      if (h._enabled === false) continue;
      const info = {};
      for (const d of DAYS) {
        const code = h.schedule[d];
        const rng = SHIFT_CODES[code];
        if (code !== 'OFF') info[d.slice(0,3)] = code + ' → ' + (rng ? '['+rng[0]+','+rng[1]+']' : 'NO RANGE');
      }
      console.log(h.name + (h.sourceIdx != null ? ' (replaces idx '+h.sourceIdx+')' : ' (new)'), info);
    }
    const debugRows = [];
    for (let d = 0; d < 7; d++) {
      for (let b = 0; b < BLOCKS.length; b++) {
        const before = noHypoGrid[d][b].current;
        const after = grid[d][b].current;
        const needed = grid[d][b].needed;
        if (before !== after) {
          debugRows.push({ Day: DAY_LABELS[d], Block: BLOCKS[b].label, Before: before, After: after, Diff: after - before, Needed: needed });
        }
      }
    }
    if (debugRows.length > 0) console.table(debugRows);
    else console.log('No cells changed by hypotheticals');
    console.groupEnd();
  }

  // Day shift: blocks 0-11 (6A through 5P), Night shift: blocks 12-23 (6P through 5A)
  const dayBlocks = [];
  const nightBlocks = [];
  for (let b = 0; b < BLOCKS.length; b++) {
    if (b < 12) dayBlocks.push(b); else nightBlocks.push(b);
  }

  function buildGridHtml(blockIndices) {
    let html = '';
    // Top-left empty cell
    html += '<div class="grid-header" style="background:transparent;border:none"></div>';
    // Day headers
    for (let d = 0; d < 7; d++) {
      // Find the worst single-block shortfall for this day
      let worstShort = 0;
      for (const b of blockIndices) {
        if (grid[d][b].delta < 0 && Math.abs(grid[d][b].delta) > worstShort) worstShort = Math.abs(grid[d][b].delta);
      }
      const cls = worstShort > 0 ? 'day-short' : 'day-ok';
      const sumText = worstShort > 0 ? '-' + worstShort + (worstShort !== 1 ? ' BODIES' : ' BODY') : 'OK';
      html += `<div class="grid-header ${cls}">${DAY_LABELS[d]}<span class="day-summary">${sumText}</span></div>`;
    }
    // Block rows
    for (const b of blockIndices) {
      html += `<div class="block-label">${BLOCKS[b].label}</div>`;
      for (let d = 0; d < 7; d++) {
        const cell = grid[d][b];
        const people = peopleLists[d][b];
        const shortLabel = cell.delta < 0 ? `-${Math.abs(cell.delta)}` : cell.delta > 0 ? `+${cell.delta}` : '';

        let changeBadge = '';
        if (noHypoGrid && _hypoApplied && appliedH.length > 0) {
          const baseCurrent = noHypoGrid[d][b].current;
          const diff = cell.current - baseCurrent;
          if (diff > 0) changeBadge = '<div class="cell-change cell-change-up">+' + diff + '</div>';
          else if (diff < 0) changeBadge = '<div class="cell-change cell-change-down">' + diff + '</div>';
        }

        let peopleHtml = '';
        if (people.length > 0) {
          peopleHtml = '<div class="cell-people">';
          for (const n of people) peopleHtml += `<div>${esc(n)}</div>`;
          peopleHtml += '</div>';
        }

        html += `<div class="grid-cell ${cell.status}" data-day="${d}" data-block="${b}">
          ${changeBadge}
          <span class="cell-ratio">${cell.current}/${cell.needed}</span>
          ${shortLabel && !changeBadge ? '<span class="cell-delta">' + shortLabel + '</span>' : ''}
          ${peopleHtml}
        </div>`;
      }
    }
    return html;
  }

  document.getElementById('staffingGridDay').innerHTML = buildGridHtml(dayBlocks);
  try {
    document.getElementById('staffingGridNight').innerHTML = buildGridHtml(nightBlocks);
  } catch (e) {
    console.error('[StaffingOps] Night grid render FAILED:', e);
    document.getElementById('staffingGridNight').innerHTML = '<div style="color:#ef4444;padding:10px;font-size:12px">RENDER ERROR: ' + e.message + '</div>';
  }
}

function toggleRosterSort() {
  rosterSort = rosterSort === 'name' ? 'seniority' : 'name';
  renderRoster();
}

function renderRoster() {
  const search = document.getElementById('rosterSearch').value.toUpperCase();
  const arrow = rosterSort === 'name' ? ' A\u2193Z' : ' #';
  let html = '<table class="roster-tbl"><thead><tr>';
  html += '<th></th><th style="cursor:pointer;user-select:none" onclick="toggleRosterSort()">Name<span style="font-size:8px;color:#4aa3ff;margin-left:3px">' + arrow + '</span></th>';
  for (const lbl of DAY_LABELS) html += `<th>${lbl}</th>`;
  html += '<th>Hrs</th></tr></thead><tbody>';

  // Build index list and sort
  const indices = [];
  for (let i = 0; i < dispatchers.length; i++) indices.push(i);
  if (rosterSort === 'name') indices.sort((a, b) => {
    const aLead = dispatchers[a].isLead ? 0 : 1;
    const bLead = dispatchers[b].isLead ? 0 : 1;
    if (aLead !== bLead) return aLead - bLead;
    return dispatchers[a].name.localeCompare(dispatchers[b].name);
  });

  for (const i of indices) {
    const d = dispatchers[i];
    if (search && !d.name.includes(search)) continue;
    const isExcl = excluded.has(i);
    const isMod = modifications.has(i);
    const rowCls = isExcl ? 'excluded' : (isMod ? 'modified' : '');

    html += `<tr class="${rowCls}" data-idx="${i}" onmouseenter="highlightPerson(${i})" onmouseleave="clearHighlights()">`;
    html += `<td><input type="checkbox" class="toggle-cb" ${isExcl ? '' : 'checked'} onchange="toggleExclude(${i})"/></td>`;
    html += `<td class="name-col">${esc(d.name)}${d.isLead ? '<span class="lead-badge">LEAD</span>' : ''}</td>`;

    for (const day of DAYS) {
      const val = d.schedule[day] || "OFF";
      html += `<td class="${val === 'OFF' ? 'off-val' : ''}" style="text-align:center;font-size:10px;font-weight:700">${val}</td>`;
    }

    html += `<td class="hrs-col">${weeklyHours(d.schedule)}h</td>`;
    html += '</tr>';
  }

  html += '</tbody></table>';
  document.getElementById('rosterWrap').innerHTML = html;
}

function renderHypoTabs() {
  const tabsEl = document.getElementById('hypoTabs');
  let html = '';
  for (const key of ['A', 'B']) {
    const isActive = _activeHypoTab === key;
    const count = hypoSets[key].filter(h => h._enabled !== false).length;
    const isApplied = _appliedHypoSet === key && _hypoApplied;
    html += '<div class="hypo-tab' + (isActive ? ' active' : '') + '" data-tab="' + key + '" onclick="switchHypoTab(\'' + key + '\')">';
    html += '<span class="hypo-tab-name" id="tabName' + key + '" ondblclick="editTabName(\'' + key + '\',event)">' + esc(hypoSetNames[key]) + '</span>';
    html += '<span class="hypo-tab-edit-icon" onclick="editTabName(\'' + key + '\',event)" title="Rename">&#9998;</span>';
    if (count > 0) html += '<span class="tab-count">' + count + '</span>';
    if (isApplied) html += '<span class="tab-applied">APPLIED</span>';
    html += '</div>';
  }
  tabsEl.innerHTML = html;
}

function switchHypoTab(key) {
  if (_activeHypoTab === key) return;
  _activeHypoTab = key;
  renderHypoTabs();
  renderHypoSection();
}

function editTabName(key, event) {
  event.stopPropagation();
  const nameEl = document.getElementById('tabName' + key);
  const current = hypoSetNames[key];
  nameEl.innerHTML = '<input class="hypo-tab-name-input" type="text" value="' + esc(current) + '" maxlength="20" />';
  const inp = nameEl.querySelector('input');
  inp.focus();
  inp.select();
  inp.addEventListener('blur', () => {
    const val = inp.value.trim().toUpperCase() || ('SET ' + key);
    hypoSetNames[key] = val;
    saveHypoState();
    renderHypoTabs();
    updateApplyBar();
  });
  inp.addEventListener('keydown', e => {
    if (e.key === 'Enter') inp.blur();
    if (e.key === 'Escape') { inp.value = current; inp.blur(); }
  });
  inp.addEventListener('click', e => e.stopPropagation());
}

function renderHypoSection() {
  const list = document.getElementById('hypoList');
  populateDispatcherPicker();
  updateHypoDrawerBadge();
  renderHypoTabs();

  if (hypotheticals.length === 0) {
    list.innerHTML = '<div class="hypo-empty">Load a dispatcher or click + NEW to model schedule changes.</div>';
  }
  // Always show apply bar so both sets can be applied/unapplied
  const anyData = hypoSets.A.length > 0 || hypoSets.B.length > 0;
  document.getElementById('hypoApplyBar').style.display = anyData ? 'flex' : 'none';
  if (hypotheticals.length === 0) return;

  let html = '<table class="hypo-tbl"><thead>';
  // Row 1: section headers
  html += '<tr><th></th><th></th><th></th>';
  html += '<th colspan="7" class="split-hdr orig">SCHEDULE THEY HAVE NOW</th>';
  html += '<th colspan="7" class="split-hdr new">NEW SCHEDULE</th>';
  html += '<th></th></tr>';
  // Row 2: day labels
  html += '<tr><th></th><th></th><th>Name</th>';
  for (const lbl of DAY_LABELS) html += `<th class="orig-day">${lbl}</th>`;
  for (let i = 0; i < DAY_LABELS.length; i++) html += `<th${i === 0 ? ' class="new-divider"' : ''}>${DAY_LABELS[i]}</th>`;
  html += '<th>Hrs</th></tr>';
  html += '</thead><tbody>';

  for (let h = 0; h < hypotheticals.length; h++) {
    const hypo = hypotheticals[h];
    const isOn = hypo._enabled !== false;
    const hasSource = hypo.sourceIdx !== undefined && hypo.sourceIdx !== null;
    const origSched = hasSource ? ORIG_DISPATCHERS[hypo.sourceIdx]?.schedule : null;

    html += `<tr class="${!isOn ? 'hypo-disabled' : ''}">`;
    html += `<td><button class="remove-hypo" onclick="removeHypothetical(${h})">&times;</button></td>`;
    html += `<td><input type="checkbox" class="toggle-cb" ${isOn ? 'checked' : ''} onchange="toggleHypo(${h})"></td>`;
    html += `<td class="name-col">${esc(hypo.name)}`;
    html += hasSource ? '<span class="hypo-orig-badge">MOD</span>' : '<span class="hypo-new-badge">NEW</span>';
    html += '</td>';

    // Left side: original schedule (read-only) — hover highlights original blocks
    for (let di = 0; di < 7; di++) {
      const day = DAYS[di];
      if (origSched) {
        const origVal = origSched[day] || 'OFF';
        const newVal = hypo.schedule[day] || 'OFF';
        const isOff = origVal === 'OFF';
        const changed = origVal !== newVal;
        html += `<td class="orig-cell${isOff ? ' off' : ''}${changed ? ' was-changed' : ''}" onmouseenter="highlightHypoOrig(${h})" onmouseleave="clearHighlights()">${isOff ? 'OFF' : esc(origVal)}</td>`;
      } else {
        html += '<td class="orig-cell off">&mdash;</td>';
      }
    }

    // Right side: new schedule (editable pills) — hover highlights new blocks
    for (let di = 0; di < 7; di++) {
      const day = DAYS[di];
      const val = hypo.schedule[day] || 'OFF';
      const origVal = origSched ? (origSched[day] || 'OFF') : 'OFF';
      const changed = hasSource && val !== origVal;
      const isOff = val === 'OFF';
      const pillCls = isOff ? 'hypo-pill off' : (changed ? 'hypo-pill changed' : 'hypo-pill');
      html += `<td class="new-cell${di === 0 ? ' new-divider' : ''}" onmouseenter="highlightHypo(${h})" onmouseleave="clearHighlights()"><span class="${pillCls}" data-hypo="${h}" data-day="${di}" onclick="openHypoEdit(${h},${di},this,event)">${isOff ? 'OFF' : esc(val)}</span></td>`;
    }

    html += `<td class="hrs-col" id="hypoHrs_${h}">${weeklyHours(hypo.schedule)}h</td>`;
    html += '</tr>';
  }

  html += '</tbody></table>';
  list.innerHTML = html;
}

function populateDispatcherPicker() {
  const sel = document.getElementById('hypoPickDispatcher');
  const currentVal = sel.value;
  // Build set of already-loaded dispatcher indices
  const loadedIdx = new Set(hypotheticals.filter(h => h.sourceIdx !== undefined && h.sourceIdx !== null).map(h => h.sourceIdx));
  sel.innerHTML = '<option value="">Load ' + currentRole.toLowerCase() + '...</option>';
  for (let i = 0; i < dispatchers.length; i++) {
    if (loadedIdx.has(i)) continue; // already loaded
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = dispatchers[i].name;
    sel.appendChild(opt);
  }
  sel.value = currentVal || '';
}

function renderImpact() {
  const mode = document.getElementById('viewMode')?.value || 'ot';
  if (mode === 'ot') {
    document.getElementById('impactBar').style.display = 'none';
    document.getElementById('btnReset').style.display = 'none';
    return;
  }
  const { grid } = computeStaffing();
  let shortSlots = 0;
  for (let d = 0; d < 7; d++) for (let b = 0; b < BLOCKS.length; b++) {
    if (grid[d][b].delta < 0) shortSlots++;
  }
  const appliedH = getAppliedHypos();
  const appliedHypos = _hypoApplied ? appliedH.filter(h => h._enabled !== false).length : 0;
  const hasChanges = modifications.size > 0 || excluded.size > 0 || appliedHypos > 0;
  const bar = document.getElementById('impactBar');

  if (!hasChanges) {
    bar.style.display = 'none';
    document.getElementById('btnReset').style.display = 'none';
    return;
  }

  document.getElementById('btnReset').style.display = '';
  const delta = shortSlots - BASELINE_SHORTFALL;
  let deltaText, deltaCls;
  if (delta < 0) { deltaText = `Improved by ${Math.abs(delta)} slots`; deltaCls = 'improved'; }
  else if (delta > 0) { deltaText = `Worsened by ${delta} slots`; deltaCls = 'worsened'; }
  else { deltaText = 'No change'; deltaCls = ''; }

  const verifyBtn = (_hypoApplied && appliedH.length > 0) ? ' <button onclick="showVerify()" style="margin-left:auto;padding:3px 10px;font-size:10px;font-weight:700;border-radius:4px;border:1px solid rgba(56,189,248,.3);background:rgba(56,189,248,.12);color:#38bdf8;cursor:pointer">VERIFY</button>' : '';
  bar.innerHTML = `<span class="impact-label">SHORT: <b>${shortSlots}</b> slots (was ${BASELINE_SHORTFALL})</span> <span class="impact-delta ${deltaCls}">${deltaText}</span>${verifyBtn}`;
  bar.style.display = 'flex';
}

function showVerify() {
  const { grid } = computeStaffing();
  const noHypo = computeStaffing(true).grid;
  const panel = document.getElementById('verifyPanel');
  const tbl = document.getElementById('verifyTable');

  let html = '<thead><tr style="border-bottom:2px solid var(--line)">';
  html += '<th style="text-align:left;padding:4px 8px;color:var(--muted)">DAY</th>';
  html += '<th style="text-align:left;padding:4px 8px;color:var(--muted)">BLOCK</th>';
  html += '<th style="text-align:center;padding:4px 8px;color:var(--muted)">BEFORE</th>';
  html += '<th style="text-align:center;padding:4px 8px;color:var(--muted)">AFTER</th>';
  html += '<th style="text-align:center;padding:4px 8px;color:var(--muted)">DIFF</th>';
  html += '<th style="text-align:center;padding:4px 8px;color:var(--muted)">NEEDED</th>';
  html += '</tr></thead><tbody>';

  let anyChange = false;
  for (let d = 0; d < 7; d++) {
    for (let b = 0; b < BLOCKS.length; b++) {
      const before = noHypo[d][b].current;
      const after = grid[d][b].current;
      const needed = grid[d][b].needed;
      if (before === after) continue;
      anyChange = true;
      const diff = after - before;
      const diffColor = diff > 0 ? '#22c55e' : '#ef4444';
      html += '<tr style="border-bottom:1px solid var(--line)">';
      html += `<td style="padding:4px 8px;font-weight:700">${DAY_LABELS[d]}</td>`;
      html += `<td style="padding:4px 8px">${BLOCKS[b].label}</td>`;
      html += `<td style="text-align:center;padding:4px 8px">${before}</td>`;
      html += `<td style="text-align:center;padding:4px 8px;font-weight:700">${after}</td>`;
      html += `<td style="text-align:center;padding:4px 8px;font-weight:800;color:${diffColor}">${diff > 0 ? '+' : ''}${diff}</td>`;
      html += `<td style="text-align:center;padding:4px 8px;color:var(--muted)">${needed}</td>`;
      html += '</tr>';
    }
  }
  if (!anyChange) html += '<tr><td colspan="6" style="padding:12px;text-align:center;color:var(--muted)">No cells changed by hypotheticals</td></tr>';
  html += '</tbody>';
  tbl.innerHTML = html;
  panel.style.display = 'block';
}

function renderHeader() {
  // Excluded pill
  const exclNames = [...excluded].map(i => ORIG_DISPATCHERS[i]?.name).filter(Boolean).sort();
  const exclPill = document.getElementById('pillExcluded');
  const exclDrop = document.getElementById('exclDropdown');
  if (exclNames.length > 0) {
    exclPill.textContent = exclNames.length + ' EXCLUDED';
    exclPill.className = 'pill excl-pill';
    exclDrop.className = 'excl-dropdown has-items';
    exclDrop.innerHTML = exclNames.map(n => {
      const origIdx = ORIG_DISPATCHERS.findIndex(d => d.name === n);
      return `<div class="excl-dropdown-item" onclick="toggleExclude(${origIdx})">${n}<span class="excl-x">&times;</span></div>`;
    }).join('');
  } else {
    exclPill.textContent = '0 EXCLUDED';
    exclPill.className = 'pill excl-pill none';
    exclDrop.className = 'excl-dropdown';
    exclDrop.innerHTML = '';
  }

  // Dispatcher count
  const newHypos = _hypoApplied ? getAppliedHypos().filter(h => h._enabled !== false && (h.sourceIdx === null || h.sourceIdx === undefined)).length : 0;
  const activeCount = dispatchers.length - excluded.size + newHypos;
  document.getElementById('pillDispatchers').textContent = activeCount + ' ' + ROLE_CONFIG[currentRole].label;
}

// ========== INTERACTIVITY ==========
function onShiftChange(idx, day, newVal) {
  dispatchers[idx].schedule[day] = newVal;
  // Check if any day differs from original
  const orig = ORIG_DISPATCHERS[idx];
  let changed = false;
  for (const d of DAYS) {
    if (dispatchers[idx].schedule[d] !== orig.schedule[d]) { changed = true; break; }
  }
  if (changed) modifications.add(idx); else modifications.delete(idx);
  renderAll();
}

// Convert shift code → {inTime, outTime} as 4-digit military strings
function shiftToTimes(code) {
  if (!code || code === 'OFF') return { inTime: '', outTime: '' };
  let range = SHIFT_CODES[code];
  if (!range) {
    const p = parseCustomShift(code);
    if (p) { range = [p.start, p.end]; SHIFT_CODES[p.code] = range; SHIFT_HOURS[p.code] = p.hours; }
  }
  if (!range) return { inTime: '', outTime: '' };
  return {
    inTime: String(range[0] % 24).padStart(2, '0') + '00',
    outTime: String(range[1] % 24).padStart(2, '0') + '00'
  };
}

// Parse military time string → hour (0-23) or null
// Accepts: 0600, 600, 06, 6, 14, 1400, 6A, 6AM, 6P, 6PM, 10A, 10P, 22, 18:00 etc.
function parseMilTime(str) {
  if (!str) return null;
  const s = str.trim().toUpperCase();
  if (!s) return null;

  // AM/PM shorthand: 6A, 6AM, 10P, 10PM, 12A, 12P
  const ampm = s.match(/^(\d{1,2})\s*(A|AM|P|PM)$/);
  if (ampm) {
    let h = parseInt(ampm[1]);
    const ap = ampm[2].charAt(0);
    if (ap === 'A') { if (h === 12) h = 0; }
    else { if (h !== 12) h += 12; }
    return (h >= 0 && h <= 23) ? h : null;
  }

  // HH:MM format
  const hhmm = s.match(/^(\d{1,2}):(\d{2})$/);
  if (hhmm) {
    const h = parseInt(hhmm[1]);
    return (h >= 0 && h <= 23) ? h : null;
  }

  // Pure number
  const n = parseInt(s);
  if (isNaN(n)) return null;
  // 3-4 digit military: 600→6, 0600→6, 1400→14, 2200→22
  if (s.length >= 3) {
    const h = Math.floor(n / 100);
    return (h >= 0 && h <= 23) ? h : null;
  }
  // 1-2 digit: treat as hour (0-23)
  return (n >= 0 && n <= 23) ? n : null;
}

// Format hour as 4-digit military string
function fmtMil(h) {
  return String(h % 24).padStart(2, '0') + '00';
}

// ========== HYPO PILL POPUP ==========
let _hypoEditEl = null;
let _hypoEditIdx = -1;
let _hypoEditDay = -1;

function openHypoEdit(idx, dayIdx, pillEl, event) {
  event.stopPropagation();
  // Close if clicking the same pill
  if (_hypoEditEl && _hypoEditEl.classList.contains('open') && _hypoEditIdx === idx && _hypoEditDay === dayIdx) {
    closeHypoEdit();
    return;
  }
  closeHypoEdit();
  _hypoEditIdx = idx;
  _hypoEditDay = dayIdx;

  const day = DAYS[dayIdx];
  const val = hypotheticals[idx].schedule[day] || 'OFF';
  const times = shiftToTimes(val);

  // Create singleton popup on first use
  if (!_hypoEditEl) {
    _hypoEditEl = document.createElement('div');
    _hypoEditEl.className = 'hypo-edit';
    _hypoEditEl.innerHTML =
      '<span class="hypo-edit-lbl">IN</span>' +
      '<input type="text" id="hypoEditIn" placeholder="0600" maxlength="5" autocomplete="off">' +
      '<span style="color:var(--muted);font-size:13px;font-weight:700">\u2192</span>' +
      '<span class="hypo-edit-lbl">OUT</span>' +
      '<input type="text" id="hypoEditOut" placeholder="1400" maxlength="5" autocomplete="off">' +
      '<button class="hypo-edit-clr" id="hypoEditClr">CLR</button>';
    _hypoEditEl.addEventListener('click', e => e.stopPropagation());
    document.body.appendChild(_hypoEditEl);

    // Apply on blur (tab/click away from input)
    document.getElementById('hypoEditIn').addEventListener('blur', normalizeAndApply);
    document.getElementById('hypoEditOut').addEventListener('blur', normalizeAndApply);
    // Apply on Enter key
    document.getElementById('hypoEditIn').addEventListener('keydown', e => { if (e.key === 'Enter') { e.target.blur(); document.getElementById('hypoEditOut').focus(); } });
    document.getElementById('hypoEditOut').addEventListener('keydown', e => { if (e.key === 'Enter') { e.target.blur(); closeHypoEdit(); } });
    document.getElementById('hypoEditClr').addEventListener('click', () => {
      document.getElementById('hypoEditIn').value = '';
      document.getElementById('hypoEditOut').value = '';
      applyHypoEdit();
      closeHypoEdit();
    });
  }

  // Populate with military time
  document.getElementById('hypoEditIn').value = times.inTime;
  document.getElementById('hypoEditOut').value = times.outTime;

  // Position near the pill
  const rect = pillEl.getBoundingClientRect();
  const popupW = 340;
  let left = rect.left + rect.width / 2 - popupW / 2;
  if (left < 4) left = 4;
  if (left + popupW > window.innerWidth - 4) left = window.innerWidth - popupW - 4;
  let top = rect.bottom + 6;
  // If near bottom of screen, show above
  if (top + 50 > window.innerHeight) top = rect.top - 50;
  _hypoEditEl.style.left = left + 'px';
  _hypoEditEl.style.top = top + 'px';

  _hypoEditEl.classList.add('open');
  // Auto-focus the IN field and select its text
  const inField = document.getElementById('hypoEditIn');
  setTimeout(() => { inField.focus(); inField.select(); }, 10);
}

function normalizeAndApply() {
  // Normalize input display to 4-digit military, then apply
  const inEl = document.getElementById('hypoEditIn');
  const outEl = document.getElementById('hypoEditOut');
  const inH = parseMilTime(inEl.value);
  const outH = parseMilTime(outEl.value);
  if (inH !== null) inEl.value = fmtMil(inH);
  if (outH !== null) outEl.value = fmtMil(outH);
  applyHypoEdit();
}

function applyHypoEdit() {
  if (_hypoEditIdx < 0 || _hypoEditDay < 0) return;
  const inH = parseMilTime(document.getElementById('hypoEditIn').value);
  const outH = parseMilTime(document.getElementById('hypoEditOut').value);

  let code = 'OFF';
  if (inH !== null && outH !== null && inH !== outH) {
    let end24 = outH;
    if (end24 <= inH) end24 += 24; // overnight
    code = formatShiftCode(inH, end24);
    SHIFT_CODES[code] = [inH, end24];
    SHIFT_HOURS[code] = end24 - inH;
  }

  const day = DAYS[_hypoEditDay];
  hypotheticals[_hypoEditIdx].schedule[day] = code;

  // Update the pill in place
  const pill = document.querySelector('[data-hypo="' + _hypoEditIdx + '"][data-day="' + _hypoEditDay + '"]');
  if (pill) {
    const isOff = code === 'OFF';
    pill.textContent = isOff ? 'OFF' : code;
    pill.className = isOff ? 'hypo-pill off' : 'hypo-pill';
    const h = hypotheticals[_hypoEditIdx];
    if (h.sourceIdx !== undefined && h.sourceIdx !== null) {
      const origSched = ORIG_DISPATCHERS[h.sourceIdx]?.schedule;
      const origVal = origSched ? (origSched[day] || 'OFF') : 'OFF';
      if (!isOff && code !== origVal) pill.className = 'hypo-pill changed';
    }
  }

  // Update hours
  const hrsEl = document.getElementById('hypoHrs_' + _hypoEditIdx);
  if (hrsEl) hrsEl.textContent = weeklyHours(hypotheticals[_hypoEditIdx].schedule) + 'h';

  saveHypoState();
  if (_hypoApplied) { renderGrid(); renderStatusBar(); renderImpact(); renderHeader(); }
}

function closeHypoEdit() {
  if (_hypoEditEl) _hypoEditEl.classList.remove('open');
  _hypoEditIdx = -1;
  _hypoEditDay = -1;
}

// Close popup on click outside
document.addEventListener('click', closeHypoEdit);

function parseCustomShift(raw) {
  const input = raw.trim().toUpperCase();

  // Try military format: 0800-1600, 1800-0200
  const mil = input.match(/^(\d{3,4})\s*[-–]\s*(\d{3,4})$/);
  if (mil) {
    let s = parseInt(mil[1]); let e = parseInt(mil[2]);
    const sH = Math.floor(s / 100); const eH = Math.floor(e / 100);
    let end24 = eH; if (end24 <= sH) end24 += 24;
    const code = formatShiftCode(sH, end24);
    return { code, start: sH, end: end24, hours: end24 - sH };
  }

  // Try AM/PM formats: 8A-4P, 8AM-4PM, 8 AM - 4 PM, 8a-4p
  const ampm = input.match(/^(\d{1,2})\s*(AM?|PM?)\s*[-–]\s*(\d{1,2})\s*(AM?|PM?)$/i);
  if (ampm) {
    let sH = parseInt(ampm[1]);
    const sAP = ampm[2].charAt(0).toUpperCase();
    let eH = parseInt(ampm[3]);
    const eAP = ampm[4].charAt(0).toUpperCase();

    if (sAP === 'P' && sH !== 12) sH += 12;
    if (sAP === 'A' && sH === 12) sH = 0;
    if (eAP === 'P' && eH !== 12) eH += 12;
    if (eAP === 'A' && eH === 12) eH = 0;

    let end24 = eH;
    if (end24 <= sH) end24 += 24;

    const code = formatShiftCode(sH, end24);
    return { code, start: sH, end: end24, hours: end24 - sH };
  }

  // Try if it already matches a known shift
  const up = input.replace(/\s/g, '');
  if (SHIFT_CODES[up]) {
    const r = SHIFT_CODES[up];
    return { code: up, start: r[0], end: r[1], hours: r[1] - r[0] };
  }

  return null;
}

function formatShiftCode(startH, end24) {
  // Check if it matches an existing SHIFT_CODES key first
  for (const [key, range] of Object.entries(SHIFT_CODES)) {
    if (range[0] === startH && range[1] === end24) return key;
  }
  // Build a readable code like "8A-4P"
  function hourLabel(h) {
    const real = h % 24;
    if (real === 0) return '12A';
    if (real === 12) return '12P';
    if (real < 12) return real + 'A';
    return (real - 12) + 'P';
  }
  return hourLabel(startH) + '-' + hourLabel(end24);
}

let _hypoApplied = false;

function updateApplyBar() {
  const bar = document.getElementById('hypoApplyBar');
  const anyData = hypoSets.A.length > 0 || hypoSets.B.length > 0;
  bar.style.display = anyData ? 'flex' : 'none';

  const btnA = document.getElementById('btnApplyA');
  const btnB = document.getElementById('btnApplyB');
  if (btnA) {
    const nameA = hypoSetNames.A || 'SET A';
    const nameB = hypoSetNames.B || 'SET B';
    const isAppliedA = _hypoApplied && _appliedHypoSet === 'A';
    const isAppliedB = _hypoApplied && _appliedHypoSet === 'B';
    btnA.textContent = isAppliedA ? (nameA + ' APPLIED') : ('APPLY ' + nameA);
    btnA.classList.toggle('active', isAppliedA);
    btnA.style.display = hypoSets.A.length > 0 ? '' : 'none';
    btnB.textContent = isAppliedB ? (nameB + ' APPLIED') : ('APPLY ' + nameB);
    btnB.classList.toggle('active', isAppliedB);
    btnB.style.display = hypoSets.B.length > 0 ? '' : 'none';
  }

  // Show PRINT REPORT only when a set is applied
  const printBtn = document.getElementById('btnPrintReport');
  if (printBtn) printBtn.style.display = (_hypoApplied && _appliedHypoSet) ? '' : 'none';
}

// ========== PERSIST SETTINGS (Realtime Database) ==========
let _saveTs = 0;
let _settingsUnsub = null;

function saveExcluded() {
  const names = [...excluded].map(i => ORIG_DISPATCHERS[i]?.name).filter(Boolean);
  _saveTs = Date.now();
  SETTINGS_REF.set({ excluded: names }, { merge: true })
    .then(() => console.log('[StaffingOps] Excluded saved:', names))
    .catch(e => { console.warn('Save excluded failed:', e); showToast('Save failed: ' + (e.code || e.message)); });
}

function _serializeHypoSet(arr) {
  return arr.map(h => ({
    name: h.name,
    sourceName: (h.sourceIdx !== undefined && h.sourceIdx !== null) ? (ORIG_DISPATCHERS[h.sourceIdx]?.name || null) : null,
    schedule: { ...h.schedule },
    _enabled: h._enabled !== false
  }));
}

function saveHypoState() {
  _saveTs = Date.now();
  SETTINGS_REF.set({
    hypoSetA: _serializeHypoSet(hypoSets.A),
    hypoSetB: _serializeHypoSet(hypoSets.B),
    hypoSetNames: { ...hypoSetNames },
    appliedSet: _appliedHypoSet,
    activeTab: _activeHypoTab,
    hypoApplied: _hypoApplied
  }, { merge: true })
    .then(() => console.log('[StaffingOps] Hypotheticals saved (dual sets)'))
    .catch(e => { console.warn('Save hypo failed:', e); showToast('Hypo save failed: ' + (e.code || e.message)); });
}

function loadExcluded() {
  return SETTINGS_REF.get().then(doc => {
    if (doc.exists && Array.isArray(doc.data().excluded)) {
      excluded.clear();
      for (const name of doc.data().excluded) {
        const idx = ORIG_DISPATCHERS.findIndex(d => d.name === name);
        if (idx >= 0) excluded.add(idx);
      }
    }
  }).catch(e => console.warn('Failed to load excluded:', e));
}

function _deserializeHypoSet(data) {
  const result = [];
  if (!Array.isArray(data)) return result;
  for (const h of data) {
    let sourceIdx = null;
    if (h.sourceName) {
      const idx = ORIG_DISPATCHERS.findIndex(dd => dd.name === h.sourceName);
      if (idx >= 0) sourceIdx = idx;
    }
    const sched = h.schedule || { MONDAY:'OFF', TUESDAY:'OFF', WEDNESDAY:'OFF', THURSDAY:'OFF', FRIDAY:'OFF', SATURDAY:'OFF', SUNDAY:'OFF' };
    for (const day of DAYS) {
      const code = String(sched[day] || 'OFF').trim().toUpperCase();
      if (code && code !== 'OFF' && !SHIFT_CODES[code]) {
        const p = parseCustomShift(code);
        if (p) { SHIFT_CODES[p.code] = [p.start, p.end]; SHIFT_HOURS[p.code] = p.hours; }
      }
    }
    result.push({ name: h.name || 'HYPO', sourceIdx, schedule: sched, _enabled: h._enabled !== false });
  }
  return result;
}

function loadHypoState() {
  return SETTINGS_REF.get().then(doc => {
    if (!doc.exists) return;
    const d = doc.data();

    // New dual-set format
    if (d.hypoSetA !== undefined || d.hypoSetB !== undefined) {
      hypoSets.A = _deserializeHypoSet(d.hypoSetA);
      hypoSets.B = _deserializeHypoSet(d.hypoSetB);
      if (d.hypoSetNames) {
        hypoSetNames.A = d.hypoSetNames.A || 'SET A';
        hypoSetNames.B = d.hypoSetNames.B || 'SET B';
      }
      _activeHypoTab = d.activeTab || 'A';
      _appliedHypoSet = d.appliedSet || null;
      _hypoApplied = !!d.hypoApplied;
    }
    // Backward-compatible: old single-array format → import into Set A
    else if (Array.isArray(d.hypotheticals) && d.hypotheticals.length > 0) {
      hypoSets.A = _deserializeHypoSet(d.hypotheticals);
      hypoSets.B = [];
      _activeHypoTab = 'A';
      _hypoApplied = !!d.hypoApplied;
      _appliedHypoSet = _hypoApplied ? 'A' : null;
    }

    updateApplyBar();
  }).catch(e => console.warn('Failed to load hypotheticals:', e));
}

// Shared vacation doc — mirrors rotationops (rotation_plans collection)
let _vacSaveTs = 0;
let _vacUnsub = null;
function getVacDocRef() {
  const [yr, mo] = currentMonth.split('-').map(Number);
  const monthIndex = mo - 1; // rotationops uses 0-based month index
  return db.collection('rotation_plans').doc('rotation_' + yr + '_' + monthIndex);
}

function saveVacations() {
  _vacSaveTs = Date.now();
  getVacDocRef().set({ vacations }, { merge: true })
    .then(() => console.log('[StaffingOps] Vacations saved to rotation_plans:', vacations.length))
    .catch(e => { console.warn('Save vacations failed:', e); showToast('Vacation save failed: ' + (e.code || e.message)); });
}

function loadVacations() {
  return getVacDocRef().get().then(doc => {
    if (doc.exists && Array.isArray(doc.data().vacations)) {
      vacations = doc.data().vacations;
    } else {
      vacations = [];
    }
  }).catch(e => console.warn('Failed to load vacations:', e));
}

function listenVacations() {
  if (_vacUnsub) _vacUnsub();
  _vacUnsub = getVacDocRef().onSnapshot(doc => {
    if (Date.now() - _vacSaveTs < 3000) return;
    if (!doc.exists) return;
    const data = doc.data();
    if (Array.isArray(data.vacations)) {
      const incomingJson = JSON.stringify(data.vacations);
      const currentJson = JSON.stringify(vacations);
      if (incomingJson !== currentJson) {
        vacations = data.vacations;
        renderAll();
      }
    }
  });
}

function listenSettings() {
  if (_settingsUnsub) _settingsUnsub();
  _settingsUnsub = SETTINGS_REF.onSnapshot(doc => {
    if (Date.now() - _saveTs < 3000) return;
    if (!doc.exists) return;
    const data = doc.data();
    let changed = false;

    if (Array.isArray(data.excluded)) {
      const incoming = data.excluded;
      const currentNames = [...excluded].map(i => ORIG_DISPATCHERS[i]?.name).filter(Boolean);
      if (!(incoming.length === currentNames.length && incoming.every(n => currentNames.includes(n)))) {
        excluded.clear();
        for (const name of incoming) {
          const idx = ORIG_DISPATCHERS.findIndex(d => d.name === name);
          if (idx >= 0) excluded.add(idx);
        }
        changed = true;
      }
    }

    // OT assignments
    if (data.otAssignments !== undefined) {
      const incoming = JSON.stringify(data.otAssignments);
      const current = JSON.stringify(_otAssignments);
      if (incoming !== current) {
        _otAssignments = data.otAssignments || {};
        changed = true;
      }
    }

    // New dual-set format
    if (data.hypoSetA !== undefined || data.hypoSetB !== undefined) {
      const newA = _deserializeHypoSet(data.hypoSetA);
      const newB = _deserializeHypoSet(data.hypoSetB);
      const newNamesA = JSON.stringify(newA.map(h => h.name).sort());
      const newNamesB = JSON.stringify(newB.map(h => h.name).sort());
      const curNamesA = JSON.stringify(hypoSets.A.map(h => h.name).sort());
      const curNamesB = JSON.stringify(hypoSets.B.map(h => h.name).sort());
      if (newNamesA !== curNamesA || newNamesB !== curNamesB || newA.length !== hypoSets.A.length || newB.length !== hypoSets.B.length) {
        hypoSets.A = newA;
        hypoSets.B = newB;
        if (data.hypoSetNames) {
          hypoSetNames.A = data.hypoSetNames.A || 'SET A';
          hypoSetNames.B = data.hypoSetNames.B || 'SET B';
        }
        _activeHypoTab = data.activeTab || _activeHypoTab;
        _appliedHypoSet = data.appliedSet || null;
        _hypoApplied = !!data.hypoApplied;
        updateApplyBar();
        changed = true;
      }
    }
    // Old format backward compat
    else if (Array.isArray(data.hypotheticals)) {
      const incomingNames = data.hypotheticals.map(h => h.name).sort().join(',');
      const currentHNames = hypoSets.A.map(h => h.name).sort().join(',');
      if (incomingNames !== currentHNames || data.hypotheticals.length !== hypoSets.A.length) {
        hypoSets.A = _deserializeHypoSet(data.hypotheticals);
        _hypoApplied = !!data.hypoApplied;
        _appliedHypoSet = _hypoApplied ? 'A' : null;
        updateApplyBar();
        changed = true;
      }
    }

    if (changed) renderAll();
  });
}

// ========== ROLE SWITCH ==========
async function switchRole(newRole) {
  if (newRole === currentRole) return;
  currentRole = newRole;
  SETTINGS_REF = db.collection('staffingops').doc(getSettingsDocId());
  if (_settingsUnsub) { _settingsUnsub(); _settingsUnsub = null; }
  if (_ctUnsub) { _ctUnsub(); _ctUnsub = null; }
  _otAssignments = {};
  _ctAssignments = {};
  _hypoApplied = false;
  _appliedHypoSet = null;
  _activeHypoTab = 'A';
  updateApplyBar();
  await loadAllData();
}
document.getElementById('roleSelector').addEventListener('change', function() {
  switchRole(this.value);
});

// ========== MONTH SWITCH ==========
async function switchMonth(newMonth) {
  if (newMonth === currentMonth) return;
  currentMonth = newMonth;
  SETTINGS_REF = db.collection('staffingops').doc(getSettingsDocId());
  if (_settingsUnsub) { _settingsUnsub(); _settingsUnsub = null; }
  if (_vacUnsub) { _vacUnsub(); _vacUnsub = null; }
  if (_ctUnsub) { _ctUnsub(); _ctUnsub = null; }
  _hypoApplied = false;
  _appliedHypoSet = null;
  _activeHypoTab = 'A';
  _otAssignments = {};
  _ctAssignments = {};
  updateApplyBar();
  resetState();
  dispatchers = ORIG_DISPATCHERS.map(d => ({
    name: d.name, isLead: d.isLead, seniority: d.seniority,
    schedule: { ...d.schedule }
  }));
  await loadExcluded();
  await loadVacations();
  await loadHypoState();
  listenSettings();
  listenVacations();
  loadRotationCT();
  renderAll();
}

(function populateMonthSelector() {
  const sel = document.getElementById('monthSelector');
  const now = new Date();
  const MONTHS = ['JAN','FEB','MAR','APR','MAY','JUN','JUL','AUG','SEP','OCT','NOV','DEC'];
  for (let offset = -3; offset <= 6; offset++) {
    const d = new Date(now.getFullYear(), now.getMonth() + offset, 1);
    const val = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');
    const label = MONTHS[d.getMonth()] + ' ' + d.getFullYear();
    const opt = document.createElement('option');
    opt.value = val;
    opt.textContent = label;
    if (val === currentMonth) opt.selected = true;
    sel.appendChild(opt);
  }
})();

document.getElementById('monthSelector').addEventListener('change', function() {
  switchMonth(this.value);
});
document.getElementById('viewMode').addEventListener('change', function() {
  renderAll();
});

// ========== ROLE FLASH ANIMATION ==========
(function() {
  const inner = document.getElementById('roleFlashInner');
  if (!inner) return;
  const labels = ['CT','DP','PIC','SUP'];
  let ci = 0;
  inner.textContent = labels[0];
  inner.style.transition = 'transform .2s ease-in';
  setInterval(() => {
    inner.style.transform = 'rotateX(90deg)';
    setTimeout(() => {
      ci = (ci + 1) % labels.length;
      inner.textContent = labels[ci];
      inner.style.transition = 'none';
      inner.style.transform = 'rotateX(-90deg)';
      requestAnimationFrame(() => {
        inner.style.transition = 'transform .2s ease-out';
        inner.style.transform = 'rotateX(0deg)';
      });
    }, 200);
  }, 500);
})();

function toggleHypo(idx) {
  hypotheticals[idx]._enabled = hypotheticals[idx]._enabled === false ? true : false;
  saveHypoState();
  if (_hypoApplied) renderAll(); else renderHypoSection();
}

function toggleExclude(idx) {
  if (excluded.has(idx)) excluded.delete(idx); else excluded.add(idx);
  saveExcluded();
  renderAll();
}

function highlightCells(di, bi) {
  document.querySelectorAll(`.grid-cell[data-day="${di}"][data-block="${bi}"]`).forEach(c => c.classList.add('highlight'));
}

function highlightPerson(idx) {
  clearHighlights();
  if (excluded.has(idx)) return;
  const d = dispatchers[idx];
  for (let di = 0; di < 7; di++) {
    for (let bi = 0; bi < BLOCKS.length; bi++) {
      if (shiftCoversBlock(d.schedule[DAYS[di]], BLOCKS[bi])) highlightCells(di, bi);
    }
  }
}

function highlightSchedule(schedule) {
  for (let di = 0; di < 7; di++) {
    for (let bi = 0; bi < BLOCKS.length; bi++) {
      if (shiftCoversBlock(schedule[DAYS[di]], BLOCKS[bi])) highlightCells(di, bi);
    }
  }
}

function highlightHypo(idx) {
  clearHighlights();
  highlightSchedule(hypotheticals[idx].schedule);
}

function highlightHypoOrig(idx) {
  clearHighlights();
  const h = hypotheticals[idx];
  if (h.sourceIdx === undefined || h.sourceIdx === null) return;
  const orig = ORIG_DISPATCHERS[h.sourceIdx];
  if (orig) highlightSchedule(orig.schedule);
}

function clearHighlights() {
  document.querySelectorAll('.grid-cell.highlight').forEach(el => el.classList.remove('highlight'));
}

// ========== HYPO DRAWER ==========
function toggleHypoDrawer(forceOpen) {
  const drawer = document.getElementById('hypoDrawer');
  const isOpen = forceOpen === true ? true : forceOpen === false ? false : !drawer.classList.contains('open');
  drawer.classList.toggle('open', isOpen);
  if (isOpen) {
    setTimeout(() => drawer.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
  }
}
function updateHypoDrawerBadge() {
  const btn = document.getElementById('btnHypoDrawer');
  const totalCount = (hypoSets.A.filter(h => h._enabled !== false).length) + (hypoSets.B.filter(h => h._enabled !== false).length);
  btn.innerHTML = totalCount > 0 ? 'HYPOTHETICALS <span class="hypo-badge-count">' + totalCount + '</span>' : 'HYPOTHETICALS';
}
document.getElementById('btnHypoDrawer').addEventListener('click', () => toggleHypoDrawer());

// ========== VACATION DRAWER ==========
function toggleVacDrawer(forceOpen) {
  const drawer = document.getElementById('vacDrawer');
  const backdrop = document.getElementById('vacBackdrop');
  const isOpen = forceOpen === true ? true : forceOpen === false ? false : !drawer.classList.contains('open');
  drawer.classList.toggle('open', isOpen);
  backdrop.classList.toggle('open', isOpen);
  if (isOpen) populateVacEmployees();
}
function updateVacBadge() {
  const btn = document.getElementById('btnVacDrawer');
  const count = vacations.length;
  btn.innerHTML = count > 0 ? 'VACATIONS <span class="vac-badge-count">' + count + '</span>' : 'VACATIONS';
}
function populateVacEmployees() {
  const sel = document.getElementById('vacEmployee');
  const current = sel.value;
  sel.innerHTML = '<option value="">Select employee...</option>';
  const sorted = [...ORIG_DISPATCHERS].sort((a, b) => a.name.localeCompare(b.name));
  for (const d of sorted) {
    sel.innerHTML += `<option value="${esc(d.name)}">${esc(d.name)}</option>`;
  }
  sel.value = current;
}
function renderVacSection() {
  updateVacBadge();
  const list = document.getElementById('vacList');
  if (!list) return;
  if (vacations.length === 0) {
    list.innerHTML = '<div class="vac-empty">No vacations for this month.</div>';
    return;
  }
  let html = '<table class="vac-tbl"><thead><tr><th>Employee</th><th>From</th><th>To</th></tr></thead><tbody>';
  for (let i = 0; i < vacations.length; i++) {
    const v = vacations[i];
    const fromStr = v.from || '(start of month)';
    const toStr = v.to || '(end of month)';
    html += `<tr><td class="vac-name">${esc(v.name)}</td><td>${fromStr}</td><td>${toStr}</td></tr>`;
  }
  html += '</tbody></table>';
  list.innerHTML = html;
}
document.getElementById('btnVacDrawer').addEventListener('click', () => toggleVacDrawer());
document.getElementById('vacBackdrop').addEventListener('click', () => toggleVacDrawer(false));

// ========== HYPOTHETICALS ==========

// Load dispatcher from picker dropdown
document.getElementById('hypoPickDispatcher').addEventListener('change', function() {
  const idx = parseInt(this.value);
  if (isNaN(idx) || idx < 0 || idx >= dispatchers.length) return;
  const d = dispatchers[idx];
  hypotheticals.push({
    name: d.name,
    sourceIdx: idx,
    schedule: { ...ORIG_DISPATCHERS[idx].schedule }
  });
  this.value = '';
  updateApplyBar();
  saveHypoState();
  if (_hypoApplied) renderAll(); else renderHypoSection();
  toggleHypoDrawer(true);
  showToast(`${d.name} loaded — set IN/OUT and toggle days`);
});

// Add blank hypothetical
function openHypoModal() {
  document.getElementById('hypoName').value = 'HYPO ' + (hypotheticals.length + 1);
  document.getElementById('hypoModal').classList.add('show');
}
document.getElementById('btnAddHypoBlank').addEventListener('click', openHypoModal);
document.getElementById('btnHypoCancel').addEventListener('click', () => {
  document.getElementById('hypoModal').classList.remove('show');
});
document.getElementById('hypoModal').addEventListener('click', e => {
  if (e.target.id === 'hypoModal') document.getElementById('hypoModal').classList.remove('show');
});
document.getElementById('btnHypoAdd').addEventListener('click', () => {
  const name = document.getElementById('hypoName').value.trim().toUpperCase() || ('HYPO ' + (hypotheticals.length + 1));
  hypotheticals.push({
    name,
    sourceIdx: null,
    schedule: { MONDAY:'OFF', TUESDAY:'OFF', WEDNESDAY:'OFF', THURSDAY:'OFF', FRIDAY:'OFF', SATURDAY:'OFF', SUNDAY:'OFF' }
  });
  document.getElementById('hypoModal').classList.remove('show');
  updateApplyBar();
  saveHypoState();
  if (_hypoApplied) renderAll(); else renderHypoSection();
  toggleHypoDrawer(true);
  showToast(`${name} added — set IN/OUT times in the table`);
});

// ===== RECOMMENDATION HELPERS =====

function mirrorScheduleToNight(schedule) {
  const nightSched = {};
  let hasShift = false;
  for (const day of DAYS) {
    const code = (schedule[day] || 'OFF').toUpperCase();
    if (code === 'OFF') { nightSched[day] = 'OFF'; continue; }
    const hrs = SHIFT_HOURS[code];
    if (!hrs) { nightSched[day] = 'OFF'; continue; }
    if (hrs >= 12) nightSched[day] = '6P-6A';
    else nightSched[day] = '10P-6A';
    hasShift = true;
  }
  return hasShift ? nightSched : null;
}

function countProtectedShortfalls() {
  const { grid } = computeStaffing(false, hypoSets[_activeHypoTab]);
  let total = 0;
  for (let di = 0; di < 7; di++) {
    for (let bi = 0; bi < BLOCKS.length; bi++) {
      const bs = BLOCKS[bi].start;
      if (bs >= 10 && bs <= 17) continue; // 10A-5P OK to short
      if (grid[di][bi].delta < 0) total += Math.abs(grid[di][bi].delta);
    }
  }
  return total;
}

// Load recommendations — only approved picks: DONES, CLAYTON, FULLER
document.getElementById('btnLoadRecs').addEventListener('click', loadRecommendations);
function loadRecommendations() {
  if (hypotheticals.length > 0 && !confirm('This will clear existing hypotheticals in ' + hypoSetNames[_activeHypoTab] + ' and load DONES, CLAYTON, FULLER. Continue?')) return;
  hypotheticals = [];
  _hypoApplied = true;
  _appliedHypoSet = _activeHypoTab;
  let loaded = 0;

  // DONES — 2A-2P/2A-10A (12/8 pattern), Mon/Tue/Wed off, best 12h/8h split
  const donesIdx = ORIG_DISPATCHERS.findIndex(d => d.name === 'DONES');
  if (donesIdx !== -1) {
    const donesOff = new Set(['MONDAY', 'TUESDAY', 'WEDNESDAY']);
    const donesWorkDays = DAYS.filter(d => !donesOff.has(d)); // Thu Fri Sat Sun
    let bestSched = null, bestScore = Infinity;
    for (let x = 0; x < 4; x++) for (let y = x + 1; y < 4; y++) {
      const longSet = new Set([donesWorkDays[x], donesWorkDays[y]]);
      const sched = {};
      for (const day of DAYS) {
        if (donesOff.has(day)) sched[day] = 'OFF';
        else if (longSet.has(day)) sched[day] = '2A-2P';
        else sched[day] = '2A-10A';
      }
      hypotheticals.push({ name: 'DONES', sourceIdx: donesIdx, schedule: sched, _enabled: true });
      const score = countProtectedShortfalls();
      hypotheticals.pop();
      if (score < bestScore) { bestScore = score; bestSched = { ...sched }; }
    }
    if (bestSched) { hypotheticals.push({ name: 'DONES', sourceIdx: donesIdx, schedule: bestSched, _enabled: true }); loaded++; }
  }

  // CLAYTON — 10P-6A with best 2 consecutive days off Mon-Thu
  const claytonIdx = ORIG_DISPATCHERS.findIndex(d => d.name === 'CLAYTON');
  if (claytonIdx !== -1) {
    const offPairs = [['MONDAY','TUESDAY'],['TUESDAY','WEDNESDAY'],['WEDNESDAY','THURSDAY']];
    let bestPair = null, bestScore = Infinity;
    for (const pair of offPairs) {
      const sched = {};
      for (const day of DAYS) sched[day] = pair.includes(day) ? 'OFF' : '10P-6A';
      hypotheticals.push({ name: 'CLAYTON', sourceIdx: claytonIdx, schedule: sched, _enabled: true });
      const score = countProtectedShortfalls();
      hypotheticals.pop();
      if (score < bestScore) { bestScore = score; bestPair = pair; }
    }
    if (bestPair) {
      const sched = {};
      for (const day of DAYS) sched[day] = bestPair.includes(day) ? 'OFF' : '10P-6A';
      hypotheticals.push({ name: 'CLAYTON', sourceIdx: claytonIdx, schedule: sched, _enabled: true });
      loaded++;
    }
  }

  // FULLER — 2A-2P/2A-10A (12/8 pattern), Sun/Mon/Tue off, best 12h/8h split
  const fullerIdx = ORIG_DISPATCHERS.findIndex(d => d.name === 'FULLER');
  const fullerSource = fullerIdx !== -1 ? fullerIdx : null;
  {
    const fullerOff = new Set(['SUNDAY', 'MONDAY', 'TUESDAY']);
    const fullerWorkDays = DAYS.filter(d => !fullerOff.has(d));
    let bestSched = null, bestScore = Infinity;
    for (let x = 0; x < 4; x++) for (let y = x + 1; y < 4; y++) {
      const longSet = new Set([fullerWorkDays[x], fullerWorkDays[y]]);
      const sched = {};
      for (const day of DAYS) {
        if (fullerOff.has(day)) sched[day] = 'OFF';
        else if (longSet.has(day)) sched[day] = '2A-2P';
        else sched[day] = '2A-10A';
      }
      hypotheticals.push({ name: 'FULLER', sourceIdx: fullerSource, schedule: sched, _enabled: true });
      const score = countProtectedShortfalls();
      hypotheticals.pop();
      if (score < bestScore) { bestScore = score; bestSched = { ...sched }; }
    }
    if (bestSched) {
      hypotheticals.push({ name: 'FULLER', sourceIdx: fullerSource, schedule: bestSched, _enabled: true });
      loaded++;
    }
  }

  // FOWLERH (Helen Fowler) — 2A-2P/2A-10A (12/8 pattern), Wed/Thu/Fri off, best 12h/8h split
  const fowlerhIdx = ORIG_DISPATCHERS.findIndex(d => d.name === 'FOWLERH');
  const fowlerhSource = fowlerhIdx !== -1 ? fowlerhIdx : null;
  {
    const fowlerhOff = new Set(['WEDNESDAY', 'THURSDAY', 'FRIDAY']);
    const fowlerhWorkDays = DAYS.filter(d => !fowlerhOff.has(d)); // Mon Tue Sat Sun
    let bestSched = null, bestScore = Infinity;
    for (let x = 0; x < 4; x++) for (let y = x + 1; y < 4; y++) {
      const longSet = new Set([fowlerhWorkDays[x], fowlerhWorkDays[y]]);
      const sched = {};
      for (const day of DAYS) {
        if (fowlerhOff.has(day)) sched[day] = 'OFF';
        else if (longSet.has(day)) sched[day] = '2A-2P';
        else sched[day] = '2A-10A';
      }
      hypotheticals.push({ name: 'FOWLERH', sourceIdx: fowlerhSource, schedule: sched, _enabled: true });
      const score = countProtectedShortfalls();
      hypotheticals.pop();
      if (score < bestScore) { bestScore = score; bestSched = { ...sched }; }
    }
    if (bestSched) {
      hypotheticals.push({ name: 'FOWLERH', sourceIdx: fowlerhSource, schedule: bestSched, _enabled: true });
      loaded++;
    }
  }

  updateApplyBar();
  saveHypoState();
  renderAll();
  toggleHypoDrawer(true);
  showToast(`Loaded ${loaded} picks into ${hypoSetNames[_activeHypoTab]}: DONES, CLAYTON, FULLER, FOWLERH`);
}

// TRIM — find and remove redundant hypotheticals
document.getElementById('btnTrimRecs').addEventListener('click', trimRedundant);
function trimRedundant() {
  if (hypotheticals.length === 0) { showToast('No hypotheticals to trim'); return; }

  // Greedy trim: remove one at a time, re-evaluate, repeat
  const removed = [];
  let found = true;
  while (found) {
    found = false;
    const baseline = countProtectedShortfalls();
    for (let i = 0; i < hypotheticals.length; i++) {
      if (hypotheticals[i]._enabled === false) continue;
      hypotheticals[i]._enabled = false;
      const score = countProtectedShortfalls();
      if (score <= baseline) {
        // Safe to remove — actually remove it
        removed.push(hypotheticals[i].name);
        hypotheticals.splice(i, 1);
        found = true;
        break; // restart loop with updated list
      }
      hypotheticals[i]._enabled = true; // put it back
    }
  }

  if (removed.length === 0) {
    showToast('Everyone is needed — no one can be removed without increasing shortfalls');
    return;
  }

  const names = removed.join(', ');
  updateApplyBar();
  saveHypoState();
  renderAll();
  showToast(`Trimmed ${removed.length}: ${names}`);
}

// SUGGEST — find best minor-change candidates to fill remaining gaps
document.getElementById('btnSuggest').addEventListener('click', suggestCandidate);
function suggestCandidate() {
  if (hypotheticals.length === 0) { showToast('No hypotheticals — add some first'); return; }

  const usedIdx = new Set(hypotheticals.filter(h => h.sourceIdx !== null && h.sourceIdx !== undefined).map(h => h.sourceIdx));
  const results = [];

  for (let i = 0; i < ORIG_DISPATCHERS.length; i++) {
    if (usedIdx.has(i)) continue;
    if (excluded.has(i)) continue;
    const d = ORIG_DISPATCHERS[i];

    // Strategy 1: Convert any 6P-2A days to 10P-6A (minor — same hours, just shifted)
    let has62 = false;
    const sched1 = { ...d.schedule };
    for (const day of DAYS) {
      if (sched1[day] === '6P-2A') { sched1[day] = '10P-6A'; has62 = true; }
    }
    if (has62) {
      hypotheticals.push({ name: d.name, sourceIdx: i, schedule: sched1, _enabled: true });
      const score = countProtectedShortfalls();
      hypotheticals.pop();
      results.push({ name: d.name, idx: i, schedule: sched1, score, change: '6P-2A → 10P-6A' });
    }

    // Strategy 2: Mirror entire day schedule to nights (bigger change)
    const range0 = Object.values(d.schedule).some(s => {
      const r = SHIFT_CODES[s];
      return r && r[0] >= 18;
    });
    if (!range0) {
      const nightSched = mirrorScheduleToNight(d.schedule);
      if (nightSched) {
        hypotheticals.push({ name: d.name, sourceIdx: i, schedule: nightSched, _enabled: true });
        const score = countProtectedShortfalls();
        hypotheticals.pop();
        results.push({ name: d.name, idx: i, schedule: nightSched, score, change: 'Mirror to nights' });
      }
    }
  }

  if (results.length === 0) { showToast('No candidates found'); return; }

  // Sort by best score (lowest shortfalls), then by change type (prefer minor)
  results.sort((a, b) => a.score - b.score || (a.change === '6P-2A → 10P-6A' ? -1 : 1));
  const baseline = countProtectedShortfalls();

  // Show top 5
  const top = results.slice(0, 5);
  let msg = `Remaining protected shortfalls: ${baseline}\n\nTop candidates (minor changes first):\n\n`;
  for (const r of top) {
    const improvement = baseline - r.score;
    msg += `${r.name} — ${r.change} → shortfalls drop to ${r.score} (−${improvement})\n`;
  }
  msg += `\nAdd the top pick (${top[0].name})?`;

  if (confirm(msg)) {
    const pick = top[0];
    hypotheticals.push({ name: pick.name, sourceIdx: pick.idx, schedule: pick.schedule, _enabled: true });
    updateApplyBar();
    saveHypoState();
    renderAll();
    toggleHypoDrawer(true);
    showToast(`Added ${pick.name} (${pick.change})`);
  }
}

// APPLY SET toggles
function applyHypoSet(key) {
  if (_hypoApplied && _appliedHypoSet === key) {
    // Unapply
    _hypoApplied = false;
    _appliedHypoSet = null;
    showToast(hypoSetNames[key] + ' removed from grid');
  } else {
    // Apply this set (unapplies any other)
    _hypoApplied = true;
    _appliedHypoSet = key;
    showToast(hypoSetNames[key] + ' applied to grid');
  }
  updateApplyBar();
  saveHypoState();
  renderAll();
}
document.getElementById('btnApplyA').addEventListener('click', () => applyHypoSet('A'));
document.getElementById('btnApplyB').addEventListener('click', () => applyHypoSet('B'));

// CLEAR SET
document.getElementById('btnClearSet').addEventListener('click', () => {
  const key = _activeHypoTab;
  if (hypoSets[key].length === 0) { showToast('Nothing to clear'); return; }
  if (!confirm('Clear all hypotheticals in ' + hypoSetNames[key] + '?')) return;
  hypoSets[key] = [];
  if (_appliedHypoSet === key) { _hypoApplied = false; _appliedHypoSet = null; }
  updateApplyBar();
  saveHypoState();
  renderAll();
  showToast(hypoSetNames[key] + ' cleared');
});

// PRINT REPORT
document.getElementById('btnPrintReport').addEventListener('click', printSetReport);

function removeHypothetical(idx) {
  const name = hypotheticals[idx].name;
  hypotheticals.splice(idx, 1);
  updateApplyBar();
  saveHypoState();
  if (_hypoApplied) renderAll(); else renderHypoSection();
  showToast(`${name} removed`);
}

// ========== RESET ==========
document.getElementById('btnReset').addEventListener('click', () => {
  resetState();
  _hypoApplied = false;
  _appliedHypoSet = null;
  updateApplyBar();
  saveHypoState();
  renderAll();
  showToast('All changes reset to original');
});

// ========== SEARCH ==========
document.getElementById('rosterSearch').addEventListener('input', () => {
  renderRoster();
});

// ========== ROSTER TOGGLE ==========
function toggleRoster(forceCollapse) {
  const panel = document.getElementById('rosterPanel');
  const grid = document.getElementById('gridPanel');
  const btn = document.getElementById('btnCollapseRoster');
  if (forceCollapse !== undefined) {
    if (forceCollapse === panel.classList.contains('collapsed')) return; // already in desired state
    panel.classList.toggle('collapsed', forceCollapse);
  } else {
    panel.classList.toggle('collapsed');
  }
  const collapsed = panel.classList.contains('collapsed');
  grid.style.flex = collapsed ? '1' : '0 0 62%';
  grid.classList.toggle('expanded', collapsed);
  btn.textContent = collapsed ? 'SHOW ROSTER' : 'HIDE ROSTER';
}
document.getElementById('btnCollapseRoster').addEventListener('click', () => toggleRoster());

// Click outside roster to hide it
document.addEventListener('click', (e) => {
  const panel = document.getElementById('rosterPanel');
  if (panel.classList.contains('collapsed')) return;
  const btn = document.getElementById('btnCollapseRoster');
  if (panel.contains(e.target) || btn.contains(e.target)) return;
  // Ignore clicks on header buttons, modals, popups
  if (e.target.closest('.header') || e.target.closest('.hypo-edit') || e.target.closest('.modal')) return;
  toggleRoster(true);
});

// ========== THEME ==========
document.getElementById('btnTheme').addEventListener('click', () => {
  const isLight = document.body.classList.toggle('light');
  document.getElementById('themeIcon').textContent = isLight ? "\uD83C\uDF19" : "\u2600\uFE0F";
  document.getElementById('themeLabel').textContent = isLight ? "DARK" : "LIGHT";
  localStorage.setItem('staffingops-theme', isLight ? 'light' : 'dark');
});
if (localStorage.getItem('staffingops-theme') === 'light') {
  document.body.classList.add('light');
  document.getElementById('themeIcon').textContent = "\uD83C\uDF19";
  document.getElementById('themeLabel').textContent = "DARK";
}

// ========== UTILITIES ==========
function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// ========== PRINT CHANGES ==========
document.getElementById('btnPrintChanges').addEventListener('click', printChanges);
function printChanges() {
  const allHypos = getAppliedHypos().length > 0 ? getAppliedHypos() : hypotheticals;
  const changed = allHypos.filter(h => h.sourceIdx !== undefined && h.sourceIdx !== null);
  const newHypos = allHypos.filter(h => h.sourceIdx === undefined || h.sourceIdx === null);

  if (changed.length === 0 && newHypos.length === 0) {
    showToast('No hypotheticals to print');
    return;
  }

  const days = DAY_LABELS;
  const today = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

  let html = '<!DOCTYPE html><html><head><title>Schedule Changes</title><style>';
  html += 'body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;padding:24px 32px;color:#1f2937;font-size:12px;max-width:1000px;margin:0 auto}';
  html += 'h1{font-size:18px;margin:0 0 2px}';
  html += '.sub{color:#6b7280;font-size:11px;margin-bottom:16px}';
  html += '.summary{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:10px 14px;margin-bottom:20px;font-size:11px;color:#166534}';
  html += '.summary.has-short{background:#fef2f2;border-color:#fecaca;color:#991b1b}';
  html += '.person{page-break-inside:avoid;margin-bottom:18px;border:1px solid #e5e7eb;border-radius:8px;overflow:hidden}';
  html += '.person-header{background:#f9fafb;padding:8px 12px;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between}';
  html += '.person-name{font-size:14px;font-weight:800}';
  html += '.person-badge{font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px}';
  html += '.badge-mod{background:#dbeafe;color:#1d4ed8}';
  html += '.badge-new{background:#e0f2fe;color:#0369a1}';
  html += '.person-hrs{font-size:10px;color:#6b7280}';
  html += 'table{width:100%;border-collapse:collapse}';
  html += 'th{font-size:9px;font-weight:800;color:#6b7280;text-transform:uppercase;padding:6px 4px;text-align:center;border-bottom:1px solid #e5e7eb;letter-spacing:.5px}';
  html += 'th:first-child{text-align:left;padding-left:12px;width:70px}';
  html += 'td{padding:5px 4px;text-align:center;font-size:11px;font-weight:600;border-bottom:1px solid #f3f4f6}';
  html += 'td:first-child{text-align:left;padding-left:12px;font-size:10px;font-weight:700;color:#6b7280}';
  html += '.changed{background:#fef9c3;font-weight:800;color:#854d0e}';
  html += '.off{color:#d1d5db;font-weight:400}';
  html += '.arrow-row td{border:none;padding:2px 4px;font-size:10px;color:#9ca3af}';
  html += '.sig-line{margin-top:24px;display:flex;gap:40px}';
  html += '.sig-box{flex:1}';
  html += '.sig-box .label{font-size:9px;font-weight:700;color:#6b7280;margin-bottom:4px}';
  html += '.sig-box .line{border-bottom:1px solid #1f2937;height:28px}';
  html += '.sig-box .sub-label{font-size:8px;color:#9ca3af;margin-top:2px}';
  html += '.footer{margin-top:30px;text-align:center;color:#9ca3af;font-size:9px;border-top:1px solid #e5e7eb;padding-top:10px}';
  html += '@media print{body{padding:12px 16px}.person{break-inside:avoid}@page{margin:0.5in}}';
  html += '</style></head><body>';

  // Title
  html += '<h1>Proposed Schedule Changes</h1>';
  html += '<div class="sub">Generated ' + today + ' &mdash; StaffingOps</div>';

  // Summary
  const baseShort = BASELINE_SHORTFALL;
  const { grid } = computeStaffing();
  let newShort = 0;
  for (let d = 0; d < 7; d++) for (let b = 0; b < BLOCKS.length; b++) {
    if (grid[d][b].delta < 0) newShort++;
  }
  const delta = baseShort - newShort;
  html += '<div class="summary' + (newShort > 0 ? ' has-short' : '') + '">';
  html += '<strong>' + changed.length + '</strong> shift change' + (changed.length !== 1 ? 's' : '');
  if (newHypos.length > 0) html += ' + <strong>' + newHypos.length + '</strong> new addition' + (newHypos.length !== 1 ? 's' : '');
  html += ' &nbsp;|&nbsp; Shortfalls: <strong>' + baseShort + ' &rarr; ' + newShort + '</strong>';
  if (delta > 0) html += ' &nbsp;(<strong>' + delta + ' eliminated</strong>)';
  html += '</div>';

  // Each changed person — BEFORE and AFTER
  for (const h of changed) {
    const orig = ORIG_DISPATCHERS[h.sourceIdx];
    if (!orig) continue;

    // Count changed days
    const changedDays = [];
    for (let di = 0; di < 7; di++) {
      const d = DAYS[di];
      if ((h.schedule[d] || 'OFF') !== (orig.schedule[d] || 'OFF')) changedDays.push(di);
    }
    if (changedDays.length === 0) continue;

    const origHrs = weeklyHours(orig.schedule);
    const newHrs = weeklyHours(h.schedule);
    const hrsDiff = newHrs - origHrs;

    html += '<div class="person">';
    html += '<div class="person-header">';
    html += '<div><span class="person-name">' + esc(h.name) + '</span> <span class="person-badge badge-mod">SHIFT CHANGE</span></div>';
    html += '<div class="person-hrs">' + origHrs + 'h &rarr; ' + newHrs + 'h' + (hrsDiff !== 0 ? ' (' + (hrsDiff > 0 ? '+' : '') + hrsDiff + 'h)' : '') + '</div>';
    html += '</div>';

    html += '<table><thead><tr><th></th>';
    for (const lbl of days) html += '<th>' + lbl + '</th>';
    html += '</tr></thead><tbody>';

    // BEFORE row
    html += '<tr><td>BEFORE</td>';
    for (let di = 0; di < 7; di++) {
      const val = orig.schedule[DAYS[di]] || 'OFF';
      const isChanged = changedDays.includes(di);
      html += '<td class="' + (val === 'OFF' ? 'off' : '') + (isChanged ? ' changed' : '') + '">' + val + '</td>';
    }
    html += '</tr>';

    // Arrow row
    html += '<tr class="arrow-row"><td></td>';
    for (let di = 0; di < 7; di++) {
      html += '<td>' + (changedDays.includes(di) ? '&darr;' : '') + '</td>';
    }
    html += '</tr>';

    // AFTER row
    html += '<tr><td>AFTER</td>';
    for (let di = 0; di < 7; di++) {
      const val = h.schedule[DAYS[di]] || 'OFF';
      const isChanged = changedDays.includes(di);
      html += '<td class="' + (val === 'OFF' ? 'off' : '') + (isChanged ? ' changed' : '') + '">' + val + '</td>';
    }
    html += '</tr>';

    html += '</tbody></table>';

    // Signature lines
    html += '<div class="sig-line">';
    html += '<div class="sig-box"><div class="label">Employee Signature</div><div class="line"></div><div class="sub-label">' + esc(h.name) + ' &mdash; Date: ___/___/___</div></div>';
    html += '<div class="sig-box"><div class="label">Supervisor Signature</div><div class="line"></div><div class="sub-label">Approved &mdash; Date: ___/___/___</div></div>';
    html += '</div>';

    html += '</div>';
  }

  // New hypotheticals (no before)
  for (const h of newHypos) {
    const newHrs = weeklyHours(h.schedule);
    html += '<div class="person">';
    html += '<div class="person-header">';
    html += '<div><span class="person-name">' + esc(h.name) + '</span> <span class="person-badge badge-new">NEW ADDITION</span></div>';
    html += '<div class="person-hrs">' + newHrs + 'h/wk</div>';
    html += '</div>';

    html += '<table><thead><tr><th></th>';
    for (const lbl of days) html += '<th>' + lbl + '</th>';
    html += '</tr></thead><tbody>';

    html += '<tr><td>SCHEDULE</td>';
    for (let di = 0; di < 7; di++) {
      const val = h.schedule[DAYS[di]] || 'OFF';
      html += '<td class="' + (val === 'OFF' ? 'off' : '') + '">' + val + '</td>';
    }
    html += '</tr></tbody></table>';

    html += '<div class="sig-line">';
    html += '<div class="sig-box"><div class="label">Employee Signature</div><div class="line"></div><div class="sub-label">' + esc(h.name) + ' &mdash; Date: ___/___/___</div></div>';
    html += '<div class="sig-box"><div class="label">Supervisor Signature</div><div class="line"></div><div class="sub-label">Approved &mdash; Date: ___/___/___</div></div>';
    html += '</div>';

    html += '</div>';
  }

  html += '<div class="footer">Generated by StaffingOps &mdash; ' + today + '</div>';
  html += '</body></html>';

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  win.focus();
  setTimeout(() => win.print(), 400);
}

// ========== EXPORT ==========
document.getElementById('btnExport').addEventListener('click', () => {
  const { grid, summary, peopleLists } = computeStaffing();
  let totalShort = 0;
  for (let d = 0; d < 7; d++) for (let b = 0; b < BLOCKS.length; b++) {
    if (grid[d][b].delta < 0) totalShort++;
  }
  let out = '';

  // Header
  out += '=== STAFFINGOPS DATA EXPORT ===\n';
  out += 'Total Shortfalls: ' + totalShort + '\n';
  out += 'Active ' + ROLE_CONFIG[currentRole].label + ': ' + (dispatchers.length - excluded.size + getAppliedHypos().length) + '\n\n';

  // Staffing Grid
  out += '=== STAFFING GRID (Current / Needed) ===\n';
  const pad = (s, n) => String(s).padEnd(n);
  const rpad = (s, n) => String(s).padStart(n);
  out += pad('BLOCK', 14);
  for (const lbl of DAY_LABELS) out += rpad(lbl, 12);
  out += '\n' + '-'.repeat(14 + 12 * 7) + '\n';

  for (let b = 0; b < BLOCKS.length; b++) {
    out += pad(BLOCKS[b].label, 14);
    for (let d = 0; d < 7; d++) {
      const c = grid[d][b];
      const tag = c.delta < 0 ? ' SHORT ' + Math.abs(c.delta) : c.delta > 0 ? ' OVER ' + c.delta : ' OK';
      out += rpad(c.current + '/' + c.needed + tag, 12);
    }
    out += '\n';
  }
  out += pad('DAY TOTAL', 14);
  for (let d = 0; d < 7; d++) out += rpad(summary[d] > 0 ? 'SHORT ' + summary[d] : 'OK', 12);
  out += '\n\n';

  // Worst shortfalls
  const shortfalls = [];
  for (let d = 0; d < 7; d++) {
    for (let b = 0; b < BLOCKS.length; b++) {
      if (grid[d][b].delta < 0) shortfalls.push({ day: DAY_LABELS[d], block: BLOCKS[b].label, short: Math.abs(grid[d][b].delta), current: grid[d][b].current, needed: grid[d][b].needed });
    }
  }
  shortfalls.sort((a, b) => b.short - a.short);
  if (shortfalls.length) {
    out += '=== SHORTFALLS RANKED (worst first) ===\n';
    for (const s of shortfalls) out += s.day + ' ' + s.block + ': ' + s.current + '/' + s.needed + ' (SHORT ' + s.short + ')\n';
    out += '\n';
  }

  // Roster with schedules
  out += '=== ' + currentRole + ' ROSTER ===\n';
  out += pad('NAME', 16);
  for (const lbl of DAY_LABELS) out += rpad(lbl, 10);
  out += rpad('HRS', 5) + '  STATUS\n';
  out += '-'.repeat(16 + 10 * 7 + 5 + 10) + '\n';

  for (let i = 0; i < dispatchers.length; i++) {
    const d = dispatchers[i];
    const isExcl = excluded.has(i);
    const isMod = modifications.has(i);
    out += pad(d.name, 16);
    for (const day of DAYS) out += rpad(d.schedule[day] || 'OFF', 10);
    out += rpad(weeklyHours(d.schedule) + 'h', 5);
    out += '  ' + (isExcl ? 'EXCLUDED' : isMod ? 'MODIFIED' : '') + '\n';
  }
  for (const h of getAppliedHypos()) {
    if (h._enabled === false) continue;
    out += pad(h.name, 16);
    for (const day of DAYS) out += rpad(h.schedule[day] || 'OFF', 10);
    out += rpad(weeklyHours(h.schedule) + 'h', 5);
    const tag = (h.sourceIdx !== undefined && h.sourceIdx !== null) ? 'MODIFIED' : 'NEW-HYPO';
    out += '  ' + tag + '\n';
  }
  out += '\n';

  // Adequate staffing requirements
  out += '=== ADEQUATE STAFFING REQUIREMENTS ===\n';
  out += pad('BLOCK', 14);
  for (const lbl of DAY_LABELS) out += rpad(lbl, 8);
  out += '\n' + '-'.repeat(14 + 8 * 7) + '\n';
  for (const block of BLOCKS) {
    out += pad(block.label, 14);
    for (const day of DAYS) out += rpad(getNeededForBlock(day, block), 8);
    out += '\n';
  }
  out += '\n';

  // Coverage detail per block
  out += '=== WHO COVERS EACH BLOCK ===\n';
  for (let d = 0; d < 7; d++) {
    for (let b = 0; b < BLOCKS.length; b++) {
      if (peopleLists[d][b].length > 0 || grid[d][b].delta < 0) {
        const c = grid[d][b];
        out += DAY_LABELS[d] + ' ' + BLOCKS[b].label + ' (' + c.current + '/' + c.needed + '): ' + peopleLists[d][b].join(', ') + '\n';
      }
    }
  }

  document.getElementById('exportText').value = out;
  document.getElementById('exportModal').classList.add('show');
});

document.getElementById('btnCopyExport').addEventListener('click', () => {
  const ta = document.getElementById('exportText');
  ta.select();
  document.execCommand('copy');
  showToast('Copied to clipboard!');
});
document.getElementById('btnCloseExport').addEventListener('click', () => {
  document.getElementById('exportModal').classList.remove('show');
});
document.getElementById('exportModal').addEventListener('click', e => {
  if (e.target.id === 'exportModal') document.getElementById('exportModal').classList.remove('show');
});

// ========== PRINT SET REPORT (Before/After) ==========
function printSetReport() {
  if (!_hypoApplied || !_appliedHypoSet) {
    showToast('Apply a set first to print a report');
    return;
  }
  const setKey = _appliedHypoSet;
  const setName = hypoSetNames[setKey];
  const setHypos = hypoSets[setKey];
  const today = new Date().toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
  const MONTHS = ['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];
  const [yr, mo] = currentMonth.split('-').map(Number);
  const monthLabel = MONTHS[mo - 1] + ' ' + yr;

  // Compute BEFORE (no hypos) and AFTER (with applied set)
  const beforeResult = computeStaffing(true);
  const afterResult = computeStaffing();

  let beforeShort = 0, afterShort = 0;
  for (let d = 0; d < 7; d++) for (let b = 0; b < BLOCKS.length; b++) {
    if (beforeResult.grid[d][b].delta < 0) beforeShort++;
    if (afterResult.grid[d][b].delta < 0) afterShort++;
  }

  let html = '<!DOCTYPE html><html><head><title>Staffing Report — ' + esc(setName) + '</title><style>';
  html += 'body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;padding:24px 32px;color:#1f2937;font-size:12px;max-width:1200px;margin:0 auto}';
  html += 'h1{font-size:20px;margin:0 0 4px}';
  html += 'h2{font-size:15px;margin:20px 0 8px;border-bottom:2px solid #e5e7eb;padding-bottom:4px}';
  html += '.sub{color:#6b7280;font-size:11px;margin-bottom:16px}';
  html += '.summary{background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;padding:10px 14px;margin-bottom:16px;font-size:12px;color:#166534}';
  html += '.summary.has-short{background:#fef2f2;border-color:#fecaca;color:#991b1b}';
  html += '.grid-wrap{display:flex;gap:16px;margin-bottom:16px}';
  html += '.grid-half{flex:1}';
  html += '.grid-half h3{font-size:12px;font-weight:800;text-align:center;margin-bottom:4px;letter-spacing:1px}';
  html += 'table{width:100%;border-collapse:collapse;margin-bottom:12px}';
  html += 'th{font-size:9px;font-weight:800;color:#6b7280;text-transform:uppercase;padding:4px 3px;text-align:center;border:1px solid #e5e7eb;background:#f9fafb}';
  html += 'td{padding:4px 3px;text-align:center;font-size:11px;font-weight:600;border:1px solid #e5e7eb}';
  html += '.cell-short{background:#fef2f2;color:#dc2626;font-weight:800}';
  html += '.cell-ok{background:#f0fdf4;color:#16a34a}';
  html += '.cell-over{color:#16a34a}';
  html += '.cell-adeq{color:#ca8a04}';
  html += '.cell-diff-up{background:#dcfce7;color:#15803d;font-weight:900}';
  html += '.cell-diff-down{background:#fef2f2;color:#dc2626;font-weight:900}';
  html += '.change-card{border:1px solid #e5e7eb;border-radius:6px;padding:8px 10px;margin-bottom:8px;page-break-inside:avoid}';
  html += '.change-name{font-size:13px;font-weight:800;margin-bottom:4px}';
  html += '.change-badge{font-size:9px;padding:2px 6px;border-radius:4px;font-weight:700;margin-left:6px}';
  html += '.badge-mod{background:#dbeafe;color:#1d4ed8}';
  html += '.badge-new{background:#e0f2fe;color:#0369a1}';
  html += '.footer{margin-top:24px;text-align:center;color:#9ca3af;font-size:9px;border-top:1px solid #e5e7eb;padding-top:8px}';
  html += '@media print{body{padding:12px 16px}@page{margin:0.4in}.grid-wrap{break-inside:avoid}.change-card{break-inside:avoid}}';
  html += '</style></head><body>';

  // Header
  html += '<h1>Staffing Report: ' + esc(setName) + '</h1>';
  html += '<div class="sub">' + ROLE_CONFIG[currentRole].label + ' &mdash; ' + monthLabel + ' &mdash; Generated ' + today + '</div>';

  // Summary
  const improvement = beforeShort - afterShort;
  html += '<div class="summary' + (afterShort > 0 ? ' has-short' : '') + '">';
  html += 'Shortfalls: <strong>' + beforeShort + ' &rarr; ' + afterShort + '</strong>';
  if (improvement > 0) html += ' &nbsp;(<strong>' + improvement + ' eliminated</strong>)';
  else if (improvement < 0) html += ' &nbsp;(<strong>' + Math.abs(improvement) + ' added</strong>)';
  html += ' &nbsp;|&nbsp; ' + setHypos.filter(h => h._enabled !== false).length + ' hypothetical(s) in set';
  html += '</div>';

  // Helper to render a staffing grid table
  function renderGridTable(result, label) {
    let h = '<h3>' + label + '</h3>';
    // Day shift
    h += '<div style="font-size:9px;font-weight:800;text-align:center;color:#6b7280;margin:4px 0">DAY SHIFT</div>';
    h += '<table><thead><tr><th></th>';
    for (const lbl of DAY_LABELS) h += '<th>' + lbl + '</th>';
    h += '</tr></thead><tbody>';
    for (let b = 0; b < 12; b++) {
      h += '<tr><td style="font-weight:700;text-align:right;font-size:10px;color:#6b7280">' + BLOCKS[b].label + '</td>';
      for (let d = 0; d < 7; d++) {
        const c = result.grid[d][b];
        const cls = c.delta < 0 ? 'cell-short' : c.delta === 0 ? 'cell-adeq' : 'cell-over';
        h += '<td class="' + cls + '">' + c.current + '/' + c.needed + '</td>';
      }
      h += '</tr>';
    }
    h += '</tbody></table>';
    // Night shift
    h += '<div style="font-size:9px;font-weight:800;text-align:center;color:#6366f1;margin:4px 0">NIGHT SHIFT</div>';
    h += '<table><thead><tr><th></th>';
    for (const lbl of DAY_LABELS) h += '<th>' + lbl + '</th>';
    h += '</tr></thead><tbody>';
    for (let b = 12; b < BLOCKS.length; b++) {
      h += '<tr><td style="font-weight:700;text-align:right;font-size:10px;color:#6b7280">' + BLOCKS[b].label + '</td>';
      for (let d = 0; d < 7; d++) {
        const c = result.grid[d][b];
        const cls = c.delta < 0 ? 'cell-short' : c.delta === 0 ? 'cell-adeq' : 'cell-over';
        h += '<td class="' + cls + '">' + c.current + '/' + c.needed + '</td>';
      }
      h += '</tr>';
    }
    h += '</tbody></table>';
    return h;
  }

  // Before / After grids side by side
  html += '<h2>Staffing Grid Comparison</h2>';
  html += '<div class="grid-wrap">';
  html += '<div class="grid-half">' + renderGridTable(beforeResult, 'BEFORE (Baseline)') + '</div>';
  html += '<div class="grid-half">' + renderGridTable(afterResult, 'AFTER (' + esc(setName) + ')') + '</div>';
  html += '</div>';

  // Difference table
  html += '<h2>Cell-by-Cell Differences</h2>';
  html += '<table><thead><tr><th></th>';
  for (const lbl of DAY_LABELS) html += '<th>' + lbl + '</th>';
  html += '</tr></thead><tbody>';
  let anyDiff = false;
  for (let b = 0; b < BLOCKS.length; b++) {
    let rowHasDiff = false;
    for (let d = 0; d < 7; d++) {
      if (afterResult.grid[d][b].current !== beforeResult.grid[d][b].current) { rowHasDiff = true; break; }
    }
    if (!rowHasDiff) continue;
    anyDiff = true;
    html += '<tr><td style="font-weight:700;text-align:right;font-size:10px;color:#6b7280">' + BLOCKS[b].label + '</td>';
    for (let d = 0; d < 7; d++) {
      const diff = afterResult.grid[d][b].current - beforeResult.grid[d][b].current;
      if (diff === 0) {
        html += '<td>&mdash;</td>';
      } else {
        const cls = diff > 0 ? 'cell-diff-up' : 'cell-diff-down';
        html += '<td class="' + cls + '">' + (diff > 0 ? '+' : '') + diff + '</td>';
      }
    }
    html += '</tr>';
  }
  if (!anyDiff) html += '<tr><td colspan="8" style="text-align:center;color:#6b7280;padding:12px">No differences</td></tr>';
  html += '</tbody></table>';

  // Changes summary
  html += '<h2>Hypotheticals in ' + esc(setName) + '</h2>';
  for (const h of setHypos) {
    if (h._enabled === false) continue;
    const hasSource = h.sourceIdx !== undefined && h.sourceIdx !== null;
    const orig = hasSource ? ORIG_DISPATCHERS[h.sourceIdx]?.schedule : null;

    html += '<div class="change-card">';
    html += '<div class="change-name">' + esc(h.name);
    html += hasSource ? '<span class="change-badge badge-mod">MODIFIED</span>' : '<span class="change-badge badge-new">NEW</span>';
    html += ' &mdash; ' + weeklyHours(h.schedule) + 'h/wk</div>';

    html += '<table><thead><tr><th></th>';
    for (const lbl of DAY_LABELS) html += '<th>' + lbl + '</th>';
    html += '</tr></thead><tbody>';

    if (orig) {
      html += '<tr><td style="font-size:10px;font-weight:700;color:#6b7280">Before</td>';
      for (let di = 0; di < 7; di++) {
        const val = orig[DAYS[di]] || 'OFF';
        const changed = val !== (h.schedule[DAYS[di]] || 'OFF');
        html += '<td style="' + (changed ? 'text-decoration:line-through;color:#ca8a04' : (val === 'OFF' ? 'color:#d1d5db' : '')) + '">' + val + '</td>';
      }
      html += '</tr>';
    }

    html += '<tr><td style="font-size:10px;font-weight:700;color:#0369a1">After</td>';
    for (let di = 0; di < 7; di++) {
      const val = h.schedule[DAYS[di]] || 'OFF';
      const changed = orig && val !== (orig[DAYS[di]] || 'OFF');
      html += '<td style="' + (changed ? 'font-weight:800;color:#1d4ed8;background:#dbeafe' : (val === 'OFF' ? 'color:#d1d5db' : '')) + '">' + val + '</td>';
    }
    html += '</tr>';

    html += '</tbody></table></div>';
  }

  html += '<div class="footer">Generated by StaffingOps &mdash; ' + today + '</div>';
  html += '</body></html>';

  const win = window.open('', '_blank');
  win.document.write(html);
  win.document.close();
  win.focus();
  setTimeout(() => win.print(), 400);
}

// ===== BUG REPORT =====
document.getElementById('btnBugReport').addEventListener('click', () => {
  document.getElementById('bugReportName').value = '';
  document.getElementById('bugReportDetails').value = '';
  document.getElementById('bugReportModal').style.display = 'flex';
});
document.getElementById('btnBugCancel').addEventListener('click', () => {
  document.getElementById('bugReportModal').style.display = 'none';
});
document.getElementById('bugReportModal').addEventListener('click', (e) => {
  if (e.target.id === 'bugReportModal') document.getElementById('bugReportModal').style.display = 'none';
});
document.getElementById('btnBugSubmit').addEventListener('click', async () => {
  const name = document.getElementById('bugReportName').value.trim();
  const details = document.getElementById('bugReportDetails').value.trim();
  if (!name || !details) { alert('Please fill in both fields.'); return; }
  try {
    await db.collection('bugReports').add({
      name: name,
      details: details,
      app: 'StaffingOps',
      reportedBy: auth.currentUser ? auth.currentUser.email : 'unknown',
      timestamp: new Date().toISOString(),
      status: 'open'
    });
    document.getElementById('bugReportModal').style.display = 'none';
    alert('Bug report submitted. Thank you!');
  } catch (err) {
    console.error('Bug report failed:', err);
    alert('Failed to submit bug report. Try again.');
  }
});

// ===== HOW IT WORKS =====
(function initHowItWorks(){
  const btn = document.getElementById('btnHowItWorks');
  const popup = document.getElementById('howItWorksPopup');
  if(!btn||!popup) return;
  btn.addEventListener('click', e => {
    e.stopPropagation();
    const open = popup.style.display !== 'none';
    popup.style.display = open ? 'none' : 'block';
    if(!open) renderHowItWorks();
  });
  document.addEventListener('click', e => {
    if(!popup.contains(e.target) && e.target !== btn) popup.style.display = 'none';
  });
  popup.addEventListener('click', e => e.stopPropagation());
})();

function renderHowItWorks(){
  const el = document.getElementById('howItWorksContent');
  if(!el) return;
  const s = 'style="color:var(--text)"';
  const hdr = 'style="font-weight:800;font-size:12px;color:#4aa3ff;margin-top:14px;margin-bottom:4px;letter-spacing:.04em"';

  el.innerHTML =
    '<div style="font-weight:900;font-size:16px;color:var(--text);margin-bottom:4px">HOW IT WORKS</div>' +
    '<div style="font-size:11px;color:var(--muted);margin-bottom:14px">StaffingOps OT Needs — quick reference.</div>' +

    '<div ' + hdr + '>TWO VIEWS</div>' +
    '<div style="font-size:11px;line-height:1.7;color:var(--muted);margin-bottom:8px">' +
      '<b ' + s + '>OT NEEDS</b> &mdash; Month calendar showing who works each 4-hour block and where overtime is needed.<br>' +
      '<b ' + s + '>STAFFING NUMBERS</b> &mdash; Weekly grid showing hourly staffing counts vs. adequate levels.' +
    '</div>' +

    '<div ' + hdr + '>READING THE MONTH VIEW</div>' +
    '<div style="font-size:11px;line-height:1.7;color:var(--muted);margin-bottom:8px">' +
      '&bull; Each day has <b ' + s + '>6 blocks</b>: 6A-10A, 10A-2P, 2P-6P, 6P-10P, 10P-2A, 2A-6A.<br>' +
      '&bull; <b ' + s + '>Numbered chips</b> = staff scheduled for that block.<br>' +
      '&bull; <b ' + s + '>Blue "DISP IN CT"</b> badge = a dispatcher assigned to calltaking in RotationOps. They count toward calltaker staffing.<br>' +
      '&bull; <b ' + s + '>Red "OT"</b> badge = someone you manually assigned as overtime.<br>' +
      '&bull; <b ' + s + '>Red pulsing "NEEDED"</b> = remaining unfilled slots that still need coverage.' +
    '</div>' +

    '<div ' + hdr + '>ASSIGNING OT</div>' +
    '<div style="font-size:11px;line-height:1.7;color:var(--muted);margin-bottom:8px">' +
      '&bull; <b ' + s + '>Click a red NEEDED badge</b> &mdash; A popup opens with a dropdown of everyone not scheduled during that block.<br>' +
      '&bull; The dropdown is <b ' + s + '>grouped by position</b>: Calltakers, Dispatchers, PICs, Supervisors. Anyone from any position can fill the slot as OT.<br>' +
      '&bull; <b ' + s + '>Pick a name and hit ASSIGN</b> &mdash; They appear with a red OT badge and the NEEDED count goes down.<br>' +
      '&bull; <b ' + s + '>Click an OT chip to remove</b> &mdash; The assignment is removed and the NEEDED count goes back up.<br>' +
      '&bull; Assignments <b ' + s + '>save to Firestore</b> and sync across all open sessions in real time.' +
    '</div>' +

    '<div ' + hdr + '>DISP IN CT (AUTOMATIC)</div>' +
    '<div style="font-size:11px;line-height:1.7;color:var(--muted);margin-bottom:8px">' +
      '&bull; When dispatchers are assigned to CT in <b ' + s + '>RotationOps</b>, they automatically appear here with a blue badge.<br>' +
      '&bull; They <b ' + s + '>reduce the NEEDED count</b> just like a regular calltaker or OT assignment.<br>' +
      '&bull; This is <b ' + s + '>read-only</b> &mdash; to change CT assignments, use RotationOps.' +
    '</div>' +

    '<div ' + hdr + '>EXPORT</div>' +
    '<div style="font-size:11px;line-height:1.7;color:var(--muted);margin-bottom:8px">' +
      '&bull; <b ' + s + '>EXPORT OT NEEDS</b> &mdash; Downloads an XLSX with only the remaining unfilled slots (after CT and OT assignments are subtracted).<br>' +
      '&bull; Format is ready to upload to Teams Shifts.' +
    '</div>' +

    '<div style="margin-top:16px;text-align:center">' +
      '<button onclick="printHowItWorksStaffing()" style="background:#4aa3ff;color:#fff;border:none;border-radius:8px;padding:8px 22px;font-size:12px;font-weight:700;cursor:pointer">PRINT THIS GUIDE</button>' +
    '</div>';
}

function printHowItWorksStaffing(){
  const content = document.getElementById('howItWorksContent');
  if(!content) return;
  const w = window.open('','_blank','width=700,height=900');
  w.document.write('<!doctype html><html><head><title>StaffingOps - How It Works</title>' +
    '<style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:system-ui,-apple-system,sans-serif;color:#111;background:#fff;padding:0.5in 0.75in;font-size:11pt;line-height:1.6}' +
    '@media print{body{padding:0.4in 0.6in}@page{margin:0.4in}}</style></head><body>');
  w.document.write(content.innerHTML.replace(/color:var\(--text\)/g,'color:#111').replace(/color:var\(--muted\)/g,'color:#555'));
  w.document.write('</body></html>');
  w.document.close();
  w.focus();
  w.print();
}
</script>
</body>
</html>
