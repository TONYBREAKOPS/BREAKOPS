<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Employee Database Editor</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Ccircle cx='32' cy='32' r='29' stroke='%23233043' stroke-width='2' fill='%230b0f14'/%3E%3Crect x='20' y='28' width='24' height='18' rx='3' fill='none' stroke='%234aa3ff' stroke-width='2'/%3E%3Cpath d='M24 28V22a8 8 0 0 1 16 0v6' fill='none' stroke='%234aa3ff' stroke-width='2'/%3E%3Ccircle cx='32' cy='37' r='2' fill='%234aa3ff'/%3E%3C/svg%3E"/>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
<style>
:root {
  --bg: #0b0f14;
  --card: #111826;
  --border: #233043;
  --text: #e7eef8;
  --muted: #9aa4b2;
  --accent: #4aa3ff;
  --ok: #3fe7b6;
  --bad: #ff6b6b;
  --warn: #ffe066;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body {
  min-height: 100vh;
  font: 13px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color: var(--text);
  background: var(--bg);
}

/* Password gate */
#passGate {
  position: fixed; inset: 0; z-index: 1000;
  background: var(--bg);
  display: flex; align-items: center; justify-content: center;
}
#passGate .login-err { margin-top: 10px; }

/* Login gate */
#gate {
  position: fixed; inset: 0; z-index: 999;
  background: var(--bg);
  display: none; align-items: center; justify-content: center;
}
.login-box {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 36px 32px;
  width: 340px;
  text-align: center;
}
.login-box h2 { font-size: 22px; font-weight: 800; letter-spacing: -.01em; margin-bottom: 4px; }
.login-box .sub { color: var(--muted); font-size: 13px; margin-bottom: 20px; }
.login-box label {
  display: block; text-align: left;
  font-size: 11px; font-weight: 600; color: var(--muted);
  margin: 12px 0 4px; text-transform: uppercase; letter-spacing: .04em;
}
.login-box input {
  width: 100%; padding: 10px 14px;
  background: var(--bg); color: var(--text);
  border: 1px solid var(--border); border-radius: 8px;
  font-size: 14px;
}
.login-box input:focus { outline: none; border-color: var(--accent); }
.login-box .btn-login {
  width: 100%; margin-top: 18px;
  padding: 10px 28px; background: var(--accent); color: #000;
  border: none; border-radius: 8px; font-weight: 700; font-size: 13px;
  cursor: pointer;
}
.login-box .btn-login:hover { filter: brightness(1.15); }
.login-box .btn-login:disabled { opacity: .5; cursor: not-allowed; }
.login-err {
  color: var(--bad); font-size: 12px; min-height: 16px;
  margin-top: 10px;
  display: none;
}
.login-err.show { display: block; }

/* Main app */
#app { display: none; }
header {
  padding: 14px 20px;
  position: sticky; top: 0; z-index: 10;
  backdrop-filter: blur(10px);
  background: linear-gradient(180deg, rgba(11,15,20,.98), rgba(11,15,20,.75));
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
  flex-wrap: wrap;
}
header h1 { font-size: 20px; font-weight: 800; letter-spacing: -.01em; }
header .sub { color: var(--muted); font-size: 11px; }
.toolbar {
  display: flex; gap: 8px; align-items: center;
}
button {
  font: inherit; cursor: pointer;
  padding: 6px 14px; border-radius: 6px;
  font-size: 11px; font-weight: 700;
  border: 1px solid var(--border);
  background: var(--card); color: var(--text);
}
button:hover { border-color: var(--accent); }
button.primary { background: var(--accent); color: #000; border-color: var(--accent); }
button.primary:hover { filter: brightness(1.15); }
button.danger { background: rgba(255,107,107,.15); color: var(--bad); border-color: rgba(255,107,107,.3); }
button.danger:hover { background: rgba(255,107,107,.25); }
button.ok { background: rgba(63,231,182,.15); color: var(--ok); border-color: rgba(63,231,182,.3); }
button.ok:hover { background: rgba(63,231,182,.25); }

/* Stats bar */
.stats {
  padding: 8px 20px;
  background: var(--card);
  border-bottom: 1px solid var(--border);
  display: flex; gap: 20px; font-size: 11px; color: var(--muted);
}
.stats b { color: var(--text); }

/* Search */
.search-bar {
  padding: 10px 20px;
  background: rgba(17,24,38,.6);
  border-bottom: 1px solid var(--border);
  display: flex; gap: 10px; align-items: center;
}
.search-bar input {
  flex: 1; padding: 7px 12px;
  background: var(--card); color: var(--text);
  border: 1px solid var(--border); border-radius: 6px;
  font-size: 12px;
}
.search-bar input:focus { outline: none; border-color: var(--accent); }
.search-bar select {
  padding: 7px 10px;
  background: var(--card); color: var(--text);
  border: 1px solid var(--border); border-radius: 6px;
  font-size: 12px;
}

/* Table */
.table-wrap {
  overflow-x: auto;
  padding: 0 10px;
}
table {
  width: 100%; border-collapse: collapse;
  margin: 0;
}
th {
  position: sticky; top: 0; z-index: 5;
  background: #0d1117;
  padding: 8px 6px;
  font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: .06em;
  color: var(--muted);
  border-bottom: 2px solid var(--border);
  text-align: left;
  white-space: nowrap;
  cursor: pointer;
  user-select: none;
}
th:hover { color: var(--accent); }
th.sorted-asc::after { content: ' \u25B2'; font-size: 8px; }
th.sorted-desc::after { content: ' \u25BC'; font-size: 8px; }
td {
  padding: 3px 4px;
  border-bottom: 1px solid rgba(35,48,67,.5);
  vertical-align: middle;
}
tr:hover td { background: rgba(74,163,255,.04); }
tr.dirty td { background: rgba(255,190,50,.06) !important; }
tr.new-row td { background: rgba(63,231,182,.06) !important; }

/* Inline inputs */
td input, td select {
  width: 100%; padding: 4px 6px;
  background: transparent; color: var(--text);
  border: 1px solid transparent; border-radius: 4px;
  font: inherit; font-size: 12px;
}
td input:focus, td select:focus {
  outline: none;
  background: var(--card);
  border-color: var(--accent);
}
td input:hover, td select:hover {
  border-color: var(--border);
}
td input.name-input { font-weight: 700; min-width: 110px; }
td input.sen-input { width: 55px; text-align: center; }
td select.pos-select { min-width: 100px; }
td input.sched-input { min-width: 70px; text-align: center; font-size: 11px; }

/* Row actions */
.row-actions { display: flex; gap: 4px; }
.row-actions button { padding: 3px 8px; font-size: 10px; }

/* Toast */
#toast {
  position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
  padding: 10px 24px; border-radius: 8px;
  background: rgba(17,24,38,.95); border: 1px solid var(--border);
  color: var(--text); font-size: 12px; font-weight: 600;
  box-shadow: 0 8px 32px rgba(0,0,0,.4);
  z-index: 100; display: none;
  backdrop-filter: blur(8px);
}

/* Add row form */
#addForm {
  display: none;
  padding: 12px 20px;
  background: rgba(63,231,182,.04);
  border-bottom: 1px solid rgba(63,231,182,.15);
}
#addForm .form-row {
  display: flex; gap: 8px; align-items: center; flex-wrap: wrap;
}
#addForm input, #addForm select {
  padding: 6px 10px; background: var(--card); color: var(--text);
  border: 1px solid var(--border); border-radius: 6px; font-size: 12px;
}
#addForm input:focus, #addForm select:focus { outline: none; border-color: var(--accent); }
#addForm label { font-size: 10px; color: var(--muted); font-weight: 700; text-transform: uppercase; }
.field-group { display: flex; flex-direction: column; gap: 2px; }

/* Tab bar */
.tab-bar {
  display: flex; gap: 0; border-bottom: 2px solid var(--border);
  background: var(--card); padding: 0 20px;
}
.tab-bar button {
  padding: 10px 24px; border: none; border-bottom: 2px solid transparent;
  background: transparent; color: var(--muted); font-size: 13px; font-weight: 700;
  cursor: pointer; margin-bottom: -2px; border-radius: 0;
  transition: color .15s, border-color .15s;
}
.tab-bar button:hover { color: var(--text); }
.tab-bar button.active { color: var(--accent); border-bottom-color: var(--accent); }

/* Reasons section */
#sectionReasons .reasons-header {
  padding: 14px 20px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(11,15,20,.98), rgba(11,15,20,.75));
  flex-wrap: wrap;
}
#sectionReasons .reasons-header h2 { font-size: 18px; font-weight: 800; }
#sectionReasons .count-pill {
  background: var(--accent); color: #000; font-size: 11px; font-weight: 800;
  padding: 2px 10px; border-radius: 99px; margin-left: 8px;
}
#addReasonForm {
  display: none; padding: 12px 20px;
  background: rgba(63,231,182,.04); border-bottom: 1px solid rgba(63,231,182,.15);
}
#addReasonForm .form-row { display: flex; gap: 8px; align-items: center; }
#addReasonForm input {
  padding: 6px 10px; background: var(--card); color: var(--text);
  border: 1px solid var(--border); border-radius: 6px; font-size: 12px; width: 220px;
}
#addReasonForm input:focus { outline: none; border-color: var(--accent); }
#reasonsTable { width: 100%; border-collapse: collapse; margin: 0; }
#reasonsTable th {
  padding: 8px 12px; font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: .06em; color: var(--muted);
  border-bottom: 2px solid var(--border); text-align: left; background: #0d1117;
}
#reasonsTable td {
  padding: 4px 8px; border-bottom: 1px solid rgba(35,48,67,.5); vertical-align: middle;
}
#reasonsTable tr:hover td { background: rgba(74,163,255,.04); }
#reasonsTable tr.dirty td { background: rgba(255,190,50,.06) !important; }
#reasonsTable tr.new-row td { background: rgba(63,231,182,.06) !important; }
#reasonsTable input {
  width: 100%; max-width: 300px; padding: 4px 8px; background: transparent;
  color: var(--text); border: 1px solid transparent; border-radius: 4px;
  font: inherit; font-size: 12px; font-weight: 700; text-transform: uppercase;
}
#reasonsTable input:focus { outline: none; background: var(--card); border-color: var(--accent); }
#reasonsTable input:hover { border-color: var(--border); }

/* Migration progress */
.migrate-progress { padding: 8px 20px; font-size: 12px; color: var(--warn); display: none; }

/* Adequate Staffing section */
#sectionAdeq .adeq-header {
  padding: 14px 20px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(11,15,20,.98), rgba(11,15,20,.75));
  flex-wrap: wrap;
}
#sectionAdeq .adeq-header h2 { font-size: 18px; font-weight: 800; }
.adeqRoleTabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); padding: 0 20px; background: rgba(17,24,38,.6); }
.adeqRoleTabs button {
  padding: 8px 20px; border: none; border-bottom: 2px solid transparent;
  background: transparent; color: var(--muted); font-size: 12px; font-weight: 700;
  cursor: pointer; margin-bottom: -2px; border-radius: 0; transition: color .15s, border-color .15s;
}
.adeqRoleTabs button:hover { color: var(--text); }
.adeqRoleTabs button.active { color: var(--accent); border-bottom-color: var(--accent); }
#adeqAddRow {
  display: none; padding: 12px 20px;
  background: rgba(63,231,182,.04); border-bottom: 1px solid rgba(63,231,182,.15);
}
#adeqAddRow .form-row { display: flex; gap: 8px; align-items: center; }
#adeqAddRow select {
  padding: 6px 10px; background: var(--card); color: var(--text);
  border: 1px solid var(--border); border-radius: 6px; font-size: 12px;
}
#adeqAddRow select:focus { outline: none; border-color: var(--accent); }
#adeqTable { width: 100%; border-collapse: collapse; margin: 0; }
#adeqTable th {
  padding: 8px 6px; font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: .06em; color: var(--muted);
  border-bottom: 2px solid var(--border); text-align: center; background: #0d1117;
}
#adeqTable th:first-child { text-align: left; }
#adeqTable td { padding: 4px 4px; border-bottom: 1px solid rgba(35,48,67,.5); vertical-align: middle; text-align: center; }
#adeqTable td:first-child { text-align: left; font-weight: 700; font-size: 12px; padding-left: 12px; }
#adeqTable tr:hover td { background: rgba(74,163,255,.04); }
#adeqTable tr.dirty td { background: rgba(255,190,50,.06) !important; }
#adeqTable input[type="number"] {
  width: 54px; padding: 4px 4px; background: transparent; color: var(--text);
  border: 1px solid transparent; border-radius: 4px; font: inherit; font-size: 12px;
  text-align: center; font-weight: 600;
}
#adeqTable input[type="number"]:focus { outline: none; background: var(--card); border-color: var(--accent); }
#adeqTable input[type="number"]:hover { border-color: var(--border); }
.adeq-status { padding: 8px 20px; font-size: 12px; min-height: 18px; display: none; }

/* Seat Assignments section */
#sectionSeats .seats-header {
  padding: 14px 20px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(11,15,20,.98), rgba(11,15,20,.75));
  flex-wrap: wrap;
}
#sectionSeats .seats-header h2 { font-size: 18px; font-weight: 800; }
.seatsRoleTabs { display: flex; gap: 0; border-bottom: 2px solid var(--border); padding: 0 20px; background: rgba(17,24,38,.6); }
.seatsRoleTabs button {
  padding: 8px 20px; border: none; border-bottom: 2px solid transparent;
  background: transparent; color: var(--muted); font-size: 12px; font-weight: 700;
  cursor: pointer; margin-bottom: -2px; border-radius: 0; transition: color .15s, border-color .15s;
}
.seatsRoleTabs button:hover { color: var(--text); }
.seatsRoleTabs button.active { color: var(--accent); border-bottom-color: var(--accent); }
#seatAddForm {
  display: none; padding: 12px 20px;
  background: rgba(63,231,182,.04); border-bottom: 1px solid rgba(63,231,182,.15);
}
#seatAddForm .form-row { display: flex; gap: 8px; align-items: center; }
#seatAddForm input {
  padding: 6px 10px; background: var(--card); color: var(--text);
  border: 1px solid var(--border); border-radius: 6px; font-size: 12px; width: 220px;
}
#seatAddForm input:focus { outline: none; border-color: var(--accent); }
#seatsTable { width: 100%; border-collapse: collapse; margin: 0; }
#seatsTable th {
  padding: 8px 12px; font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: .06em; color: var(--muted);
  border-bottom: 2px solid var(--border); text-align: left; background: #0d1117;
}
#seatsTable td {
  padding: 4px 8px; border-bottom: 1px solid rgba(35,48,67,.5); vertical-align: middle;
}
#seatsTable tr:hover td { background: rgba(74,163,255,.04); }
#seatsTable tr.dirty td { background: rgba(255,190,50,.06) !important; }
#seatsTable tr.new-row td { background: rgba(63,231,182,.06) !important; }
#seatsTable input {
  width: 100%; max-width: 300px; padding: 4px 8px; background: transparent;
  color: var(--text); border: 1px solid transparent; border-radius: 4px;
  font: inherit; font-size: 12px; font-weight: 700;
}
#seatsTable input:focus { outline: none; background: var(--card); border-color: var(--accent); }
#seatsTable input:hover { border-color: var(--border); }

/* Scheduled Changes section */
#sectionScheduled .sched-header {
  padding: 14px 20px;
  display: flex; align-items: center; justify-content: space-between; gap: 12px;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(11,15,20,.98), rgba(11,15,20,.75));
  flex-wrap: wrap;
}
#sectionScheduled .sched-header h2 { font-size: 18px; font-weight: 800; }
.sched-filter-bar {
  padding: 10px 20px;
  background: rgba(17,24,38,.6);
  border-bottom: 1px solid var(--border);
  display: flex; gap: 10px; align-items: center;
}
.sched-filter-bar select {
  padding: 7px 10px; background: var(--card); color: var(--text);
  border: 1px solid var(--border); border-radius: 6px; font-size: 12px;
}
.badge {
  display: inline-block; padding: 2px 10px; border-radius: 99px;
  font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: .04em;
}
.badge-pending { background: rgba(255,224,102,.18); color: var(--warn); }
.badge-active { background: rgba(63,231,182,.18); color: var(--ok); }
.badge-expired { background: rgba(154,164,178,.18); color: var(--muted); }
#schedTable { width: 100%; border-collapse: collapse; margin: 0; }
#schedTable th {
  padding: 8px 12px; font-size: 10px; font-weight: 700;
  text-transform: uppercase; letter-spacing: .06em; color: var(--muted);
  border-bottom: 2px solid var(--border); text-align: left; background: #0d1117;
}
#schedTable td {
  padding: 6px 10px; border-bottom: 1px solid rgba(35,48,67,.5); vertical-align: middle;
  font-size: 12px;
}
#schedTable tr:hover td { background: rgba(74,163,255,.04); }
#addSchedForm {
  display: none; padding: 16px 20px;
  background: rgba(63,231,182,.04); border-bottom: 1px solid rgba(63,231,182,.15);
}
#addSchedForm .form-row {
  display: flex; gap: 8px; align-items: flex-end; flex-wrap: wrap;
}
#addSchedForm input, #addSchedForm select, #addSchedForm textarea {
  padding: 6px 10px; background: var(--card); color: var(--text);
  border: 1px solid var(--border); border-radius: 6px; font-size: 12px;
}
#addSchedForm input:focus, #addSchedForm select:focus, #addSchedForm textarea:focus {
  outline: none; border-color: var(--accent);
}
#addSchedForm textarea { resize: vertical; font: inherit; font-size: 12px; }
#addSchedForm label { font-size: 10px; color: var(--muted); font-weight: 700; text-transform: uppercase; }
.sched-day-grid {
  display: flex; gap: 6px; flex-wrap: wrap; margin: 8px 0;
}
.sched-day-grid .field-group input { width: 70px; text-align: center; }
.trainer-preview {
  margin: 8px 0; padding: 8px 12px; background: rgba(74,163,255,.06);
  border: 1px solid rgba(74,163,255,.2); border-radius: 6px; font-size: 11px;
  color: var(--muted); display: none;
}
.trainer-preview b { color: var(--text); }
#schedEmpty {
  text-align: center; color: var(--muted); padding: 40px 20px; font-size: 13px;
}
</style>
</head>
<body>

<!-- Password Gate -->
<div id="passGate">
  <div class="login-box">
    <svg width="48" height="48" viewBox="0 0 64 64" fill="none" style="margin-bottom:12px">
      <circle cx="32" cy="32" r="29" stroke="#233043" stroke-width="2" fill="#0b0f14"/>
      <rect x="20" y="28" width="24" height="18" rx="3" fill="none" stroke="#4aa3ff" stroke-width="2"/>
      <path d="M24 28V22a8 8 0 0 1 16 0v6" fill="none" stroke="#4aa3ff" stroke-width="2"/>
      <circle cx="32" cy="37" r="2" fill="#4aa3ff"/>
    </svg>
    <h2>Employee DB Access</h2>
    <div class="sub">Enter access code to continue</div>
    <div class="login-err" id="passError"></div>
    <form id="passForm">
      <label>Access Code</label>
      <input type="password" id="passInput" placeholder="Enter access code" required autocomplete="off"/>
      <button type="submit" class="btn-login" id="btnUnlock">Unlock</button>
    </form>
  </div>
</div>

<!-- Login Gate -->
<div id="gate">
  <div class="login-box">
    <svg width="48" height="48" viewBox="0 0 64 64" fill="none" style="margin-bottom:12px">
      <circle cx="32" cy="32" r="29" stroke="#233043" stroke-width="2" fill="#0b0f14"/>
      <rect x="20" y="28" width="24" height="18" rx="3" fill="none" stroke="#4aa3ff" stroke-width="2"/>
      <path d="M24 28V22a8 8 0 0 1 16 0v6" fill="none" stroke="#4aa3ff" stroke-width="2"/>
      <circle cx="32" cy="37" r="2" fill="#4aa3ff"/>
    </svg>
    <h2>Employee Database</h2>
    <div class="sub">Sign in to access the editor</div>
    <div class="login-err" id="loginError"></div>
    <form id="loginForm">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="you@example.com" required autocomplete="email"/>
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="Enter password" required autocomplete="current-password"/>
      <button type="submit" class="btn-login" id="btnLogin">Sign In</button>
    </form>
  </div>
</div>

<!-- Main App -->
<div id="app">

<div class="tab-bar">
  <button class="active" onclick="switchTab('employees')">Employees</button>
  <button onclick="switchTab('reasons')">Absence Reasons</button>
  <button onclick="switchTab('adeq')">Adequate Staffing</button>
  <button onclick="switchTab('seats')">Seat Assignments</button>
  <button onclick="switchTab('scheduled')">Scheduled Changes</button>
</div>

<div id="sectionEmployees">
<header>
  <div>
    <h1>Employee Database Editor</h1>
    <div class="sub">ShiftOPS / ShiftOps Firestore &bull; <span id="empCount">0</span> employees</div>
  </div>
  <div class="toolbar">
    <button class="primary" id="btnAdd">+ Add Employee</button>
    <button class="ok" id="btnSaveAll">Save All Changes</button>
    <button id="btnReload">Reload</button>
    <button class="danger" onclick="auth.signOut()">Sign Out</button>
    <button style="margin-left:auto;background:#1a73e8;color:#fff;border:none;padding:6px 14px;border-radius:4px;cursor:pointer" onclick="exportSchedules()">Export Schedules</button>
  </div>
</header>

<div class="stats" id="statsBar">Loading...</div>

<div class="search-bar">
  <input type="text" id="searchInput" placeholder="Search by name..."/>
  <select id="filterPos">
    <option value="">All Positions</option>
    <option value="CALLTAKER">Calltaker</option>
    <option value="DISPATCHER">Dispatcher</option>
    <option value="PIC">PIC</option>
    <option value="SUPERVISOR">Supervisor</option>
  </select>
</div>

<div id="addForm">
  <div class="form-row">
    <div class="field-group"><label>Name</label><input type="text" id="addName" placeholder="LAST NAME" style="width:130px"/></div>
    <div class="field-group"><label>Seniority</label><input type="number" id="addSen" placeholder="#" style="width:60px"/></div>
    <div class="field-group"><label>Position</label>
      <select id="addPos" style="width:120px">
        <option value="CALLTAKER">CALLTAKER</option>
        <option value="DISPATCHER">DISPATCHER</option>
        <option value="PIC">PIC</option>
        <option value="SUPERVISOR">SUPERVISOR</option>
      </select>
    </div>
    <div class="field-group"><label>Mon</label><input type="text" id="addMon" placeholder="6A-2P" style="width:70px"/></div>
    <div class="field-group"><label>Tue</label><input type="text" id="addTue" placeholder="6A-2P" style="width:70px"/></div>
    <div class="field-group"><label>Wed</label><input type="text" id="addWed" placeholder="6A-2P" style="width:70px"/></div>
    <div class="field-group"><label>Thu</label><input type="text" id="addThu" placeholder="6A-2P" style="width:70px"/></div>
    <div class="field-group"><label>Fri</label><input type="text" id="addFri" placeholder="6A-2P" style="width:70px"/></div>
    <div class="field-group"><label>Sat</label><input type="text" id="addSat" placeholder="OFF" style="width:70px"/></div>
    <div class="field-group"><label>Sun</label><input type="text" id="addSun" placeholder="OFF" style="width:70px"/></div>
    <button class="primary" onclick="addEmployee()" style="margin-top:14px">Add</button>
    <button onclick="document.getElementById('addForm').style.display='none'" style="margin-top:14px">Cancel</button>
  </div>
</div>

<div class="table-wrap">
<table>
<thead>
<tr>
  <th data-col="Employee" class="sorted-asc">Name</th>
  <th data-col="SENIORITY">Sen</th>
  <th data-col="POSITION">Position</th>
  <th data-col="MONDAY">Mon</th>
  <th data-col="TUESDAY">Tue</th>
  <th data-col="WEDNESDAY">Wed</th>
  <th data-col="THURSDAY">Thu</th>
  <th data-col="FRIDAY">Fri</th>
  <th data-col="SATURDAY">Sat</th>
  <th data-col="SUNDAY">Sun</th>
  <th style="width:100px">Actions</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>
</div>
</div><!-- /sectionEmployees -->

<div id="sectionReasons" style="display:none">
  <div class="reasons-header">
    <div>
      <h2>Absence Reasons<span class="count-pill" id="reasonCount">0</span></h2>
      <div class="sub" style="color:var(--muted);font-size:11px;margin-top:2px">Manage absence reason codes used across ShiftOps</div>
    </div>
    <div class="toolbar">
      <button class="primary" onclick="toggleAddReason()">+ Add Reason</button>
      <button class="ok" onclick="saveAllReasons()">Save All</button>
      <button onclick="loadReasons()">Reload</button>
      <button onclick="migrateOldRecords()">Migrate Old Records</button>
    </div>
  </div>
  <div id="addReasonForm">
    <div class="form-row">
      <input type="text" id="addReasonInput" placeholder="NEW REASON NAME" />
      <button class="primary" onclick="addReason()">Add</button>
      <button onclick="document.getElementById('addReasonForm').style.display='none'">Cancel</button>
    </div>
  </div>
  <div class="migrate-progress" id="migrateProgress"></div>
  <div class="table-wrap" style="padding:0 10px">
    <table id="reasonsTable">
      <thead><tr><th style="width:60%">Reason</th><th>Actions</th></tr></thead>
      <tbody id="reasonsTbody"></tbody>
    </table>
  </div>
</div><!-- /sectionReasons -->

<div id="sectionAdeq" style="display:none">
  <div class="adeq-header">
    <div>
      <h2>Adequate Staffing Numbers</h2>
      <div class="sub" style="color:var(--muted);font-size:11px;margin-top:2px">Manage minimum staffing levels per hour &amp; day &mdash; used by ShiftOps staffing boxes</div>
    </div>
    <div class="toolbar">
      <button class="primary" id="btnAddAdeqHour">+ Add Hour</button>
      <button class="ok" id="btnSaveAdeq">Save All</button>
      <button id="btnReloadAdeq">Reload</button>
    </div>
  </div>
  <div class="adeqRoleTabs" id="adeqRoleTabs">
    <button class="active" data-role="CALLTAKER">Calltaker</button>
    <button data-role="DISPATCHER">Dispatcher</button>
    <button data-role="PIC">PIC</button>
  </div>
  <div id="adeqAddRow">
    <div class="form-row">
      <select id="adeqNewHourSel"></select>
      <button class="primary" onclick="addAdeqHour()">Add</button>
      <button onclick="document.getElementById('adeqAddRow').style.display='none'">Cancel</button>
    </div>
  </div>
  <div class="adeq-status" id="adeqStatus"></div>
  <div class="table-wrap" style="padding:0 10px">
    <table id="adeqTable">
      <thead><tr>
        <th>Time</th><th>Sun</th><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th><th>Actions</th>
      </tr></thead>
      <tbody id="adeqTbody"></tbody>
    </table>
  </div>
</div><!-- /sectionAdeq -->

<div id="sectionSeats" style="display:none">
  <div class="seats-header">
    <div>
      <h2>Seat Assignments<span class="count-pill" id="seatCount">0</span></h2>
      <div class="sub" style="color:var(--muted);font-size:11px;margin-top:2px">Manage seat/position names per role &mdash; used by ShiftOps assignment dropdowns</div>
    </div>
    <div class="toolbar">
      <button class="primary" id="btnAddSeat">+ Add Seat</button>
      <button class="ok" id="btnSaveSeats">Save All</button>
      <button id="btnReloadSeats">Reload</button>
    </div>
  </div>
  <div class="seatsRoleTabs" id="seatsRoleTabs">
    <button class="active" data-role="CALLTAKER">Calltaker</button>
    <button data-role="DISPATCHER">Dispatcher</button>
    <button data-role="PIC">PIC</button>
    <button data-role="SUPERVISOR">Supervisor</button>
  </div>
  <div id="seatAddForm">
    <div class="form-row">
      <input type="text" id="seatAddInput" placeholder="SEAT NAME" />
      <button class="primary" onclick="addSeat()">Add</button>
      <button onclick="document.getElementById('seatAddForm').style.display='none'">Cancel</button>
    </div>
  </div>
  <div class="table-wrap" style="padding:0 10px">
    <table id="seatsTable">
      <thead><tr><th style="width:60%">Seat Name</th><th>Actions</th></tr></thead>
      <tbody id="seatsTbody"></tbody>
    </table>
  </div>
</div><!-- /sectionSeats -->

<div id="sectionScheduled" style="display:none">
  <div class="sched-header">
    <div>
      <h2>Scheduled Changes<span class="count-pill" id="schedCount">0</span></h2>
      <div class="sub" style="color:var(--muted);font-size:11px;margin-top:2px">Plan schedule changes and training mirrors ahead of time</div>
    </div>
    <div class="toolbar">
      <button class="primary" id="btnAddSched">+ Add Scheduled Change</button>
      <button id="btnReloadSched">Reload</button>
    </div>
  </div>
  <div class="sched-filter-bar">
    <select id="schedFilter" onchange="renderScheduled()">
      <option value="">All Statuses</option>
      <option value="pending">Pending</option>
      <option value="active">Active</option>
      <option value="expired">Expired</option>
    </select>
  </div>
  <div id="addSchedForm">
    <div style="margin-bottom:10px">
      <label>Type</label>
      <select id="schedType" onchange="onSchedTypeChange()" style="margin-left:6px">
        <option value="schedule">Schedule Change</option>
        <option value="mirror">Training Mirror</option>
      </select>
    </div>
    <!-- Schedule Change fields -->
    <div id="schedFieldsSchedule">
      <div class="form-row">
        <div class="field-group"><label>Employee</label>
          <select id="schedEmployee" onchange="onSchedEmployeeChange()" style="width:160px"><option value="">Select...</option></select>
        </div>
        <div class="field-group"><label>Effective Date</label><input type="date" id="schedStart" style="width:140px"/></div>
        <div class="field-group"><label>End Date (optional)</label><input type="date" id="schedEnd" style="width:140px"/></div>
        <div class="field-group"><label>New Position (optional)</label>
          <select id="schedNewPos" style="width:130px">
            <option value="">Keep Current</option>
            <option value="CALLTAKER">CALLTAKER</option>
            <option value="DISPATCHER">DISPATCHER</option>
            <option value="PIC">PIC</option>
            <option value="SUPERVISOR">SUPERVISOR</option>
          </select>
        </div>
      </div>
      <div class="sched-day-grid">
        <div class="field-group"><label>Mon</label><input type="text" id="schedMon" placeholder="6A-2P"/></div>
        <div class="field-group"><label>Tue</label><input type="text" id="schedTue" placeholder="6A-2P"/></div>
        <div class="field-group"><label>Wed</label><input type="text" id="schedWed" placeholder="6A-2P"/></div>
        <div class="field-group"><label>Thu</label><input type="text" id="schedThu" placeholder="6A-2P"/></div>
        <div class="field-group"><label>Fri</label><input type="text" id="schedFri" placeholder="6A-2P"/></div>
        <div class="field-group"><label>Sat</label><input type="text" id="schedSat" placeholder="OFF"/></div>
        <div class="field-group"><label>Sun</label><input type="text" id="schedSun" placeholder="OFF"/></div>
      </div>
    </div>
    <!-- Mirror fields -->
    <div id="schedFieldsMirror" style="display:none">
      <div class="form-row">
        <div class="field-group"><label>Trainee Name</label>
          <select id="schedTrainee" onchange="onSchedTraineeChange()" style="width:160px"><option value="">Select...</option></select>
          <input type="text" id="schedTraineeCustom" placeholder="LAST NAME" style="width:160px;display:none;margin-top:4px"/>
        </div>
        <div class="trainer-preview" id="traineePreview" style="display:none"></div>
        <div class="field-group"><label>Trainer</label>
          <select id="schedTrainer" onchange="onSchedTrainerChange()" style="width:160px"><option value="">Select...</option></select>
        </div>
        <div class="field-group"><label>Effective Date</label><input type="date" id="schedMirrorStart" style="width:140px"/></div>
        <div class="field-group"><label>End Date (optional)</label><input type="date" id="schedMirrorEnd" style="width:140px"/></div>
      </div>
      <div class="trainer-preview" id="trainerPreview"></div>
    </div>
    <div class="form-row" style="margin-top:8px">
      <div class="field-group" style="flex:1"><label>Description</label><input type="text" id="schedDesc" placeholder="Brief description of change" style="width:100%"/></div>
    </div>
    <div class="form-row" style="margin-top:10px">
      <button class="primary" onclick="addScheduledChange()">Add Change</button>
      <button onclick="document.getElementById('addSchedForm').style.display='none'">Cancel</button>
    </div>
  </div>
  <div class="table-wrap" style="padding:0 10px">
    <table id="schedTable">
      <thead><tr>
        <th>Status</th><th>Type</th><th>Employee</th><th>Dates</th><th>Description</th><th>Actions</th>
      </tr></thead>
      <tbody id="schedTbody"></tbody>
    </table>
    <div id="schedEmpty" style="display:none">No scheduled changes yet. Click "+ Add Scheduled Change" to create one.</div>
  </div>
</div><!-- /sectionScheduled -->

</div>

<div id="toast"></div>

<script>
// Password gate
const PASS_HASH = "e9ea85886c6f94643bcc7b5f9ed746d72f5ac6f6b955684bf3858c0dd58c645c";
let passUnlocked = false;

async function sha256(text) {
  const data = new TextEncoder().encode(text);
  const buf = await crypto.subtle.digest("SHA-256", data);
  return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
}

document.getElementById("passForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const input = document.getElementById("passInput").value;
  const errEl = document.getElementById("passError");
  const hash = await sha256(input);
  if (hash === PASS_HASH) {
    passUnlocked = true;
    document.getElementById("passGate").style.display = "none";
    // If already signed into Firebase, go straight to app
    if (auth.currentUser) {
      document.getElementById("app").style.display = "block";
      loadEmployees();
    } else {
      document.getElementById("gate").style.display = "flex";
    }
  } else {
    errEl.textContent = "Incorrect access code";
    errEl.classList.add("show");
    document.getElementById("passInput").value = "";
    document.getElementById("passInput").focus();
  }
});

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyA6KELmSyotefK0zhahQZ0-mbYur8_nTsg",
  authDomain: "commandops-93846.firebaseapp.com",
  databaseURL: "https://commandops-93846-default-rtdb.firebaseio.com",
  projectId: "commandops-93846",
  storageBucket: "commandops-93846.firebasestorage.app",
  messagingSenderId: "262613721964",
  appId: "1:262613721964:web:478a694d357234e3be4949"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

// Auth state listener â€” never bypass the password gate
auth.onAuthStateChanged((user) => {
  if(!passUnlocked) return;          // password gate still active, do nothing
  if(user){
    document.getElementById("gate").style.display = "none";
    document.getElementById("app").style.display = "block";
    loadEmployees();
  } else {
    document.getElementById("app").style.display = "none";
    document.getElementById("gate").style.display = "flex";
  }
});

// Login form
document.getElementById("loginForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value;
  const errEl = document.getElementById("loginError");
  const btn = document.getElementById("btnLogin");

  errEl.classList.remove("show");
  btn.disabled = true;
  btn.textContent = "Signing in...";

  try {
    await auth.signInWithEmailAndPassword(email, password);
  } catch(err){
    let msg = "Sign in failed";
    if(err.code === "auth/user-not-found") msg = "No account found with this email";
    else if(err.code === "auth/wrong-password") msg = "Incorrect password";
    else if(err.code === "auth/invalid-email") msg = "Invalid email address";
    else if(err.code === "auth/too-many-requests") msg = "Too many attempts. Try again later.";
    else if(err.code === "auth/invalid-credential") msg = "Invalid email or password";
    errEl.textContent = msg;
    errEl.classList.add("show");
  }

  btn.disabled = false;
  btn.textContent = "Sign In";
});

const DAYS = ["MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY","SATURDAY","SUNDAY"];
const POSITIONS = ["CALLTAKER","DISPATCHER","PIC","SUPERVISOR"];

let employees = []; // {docId, data:{Employee, SENIORITY, POSITION, MON..SUN}, dirty, isNew}
let sortCol = "Employee";
let sortAsc = true;

function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg; el.style.display = "block";
  clearTimeout(toast._t);
  toast._t = setTimeout(()=> el.style.display="none", 2500);
}

async function loadEmployees(){
  try {
    const snap = await db.collection("employees").get();
    employees = snap.docs.map(doc => {
      const d = doc.data();
      return {
        docId: doc.id,
        data: {
          Employee: d.Employee || doc.id,
          SENIORITY: d.SENIORITY ?? d.Seniority ?? "",
          POSITION: normalizePos(d.POSITION ?? d.Position ?? ""),
          MONDAY: d.MONDAY ?? "",
          TUESDAY: d.TUESDAY ?? "",
          WEDNESDAY: d.WEDNESDAY ?? "",
          THURSDAY: d.THURSDAY ?? "",
          FRIDAY: d.FRIDAY ?? "",
          SATURDAY: d.SATURDAY ?? "",
          SUNDAY: d.SUNDAY ?? "",
        },
        dirty: false,
        isNew: false
      };
    });
    toast("Loaded " + employees.length + " employees.");
    renderAll();
    // Process scheduled changes on every load
    await processScheduledChanges();
  } catch(e){
    console.error(e);
    toast("Failed to load: " + e.message);
  }
}

function normalizePos(p){
  const s = String(p||"").toUpperCase().trim();
  if(s.includes("CALL") || s === "CT") return "CALLTAKER";
  if(s.includes("DISP") || s === "DP") return "DISPATCHER";
  if(s.includes("PIC")) return "PIC";
  if(s.includes("SUP")) return "SUPERVISOR";
  return s || "";
}

function exportSchedules(){
  if(!employees.length){ alert("No employees loaded."); return; }
  const DAY_LABELS = {MONDAY:"Mon",TUESDAY:"Tue",WEDNESDAY:"Wed",THURSDAY:"Thu",FRIDAY:"Fri",SATURDAY:"Sat",SUNDAY:"Sun"};
  const base = employees.map(e => {
    const d = e.data;
    const sched = {};
    const offIndices = [];
    for(let i = 0; i < DAYS.length; i++){
      const val = (d[DAYS[i]] || "").trim() || "OFF";
      sched[DAYS[i]] = val;
      if(val.toUpperCase() === "OFF" || val === "") offIndices.push(i);
    }
    // Rotation-based ordering: find consecutive block start in circular week
    const ALL_LABELS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    let daysOffStr = "None";
    if(offIndices.length){
      let startIdx = 0;
      if(offIndices.length < 7){
        let maxGap = 0, gapAfter = 0;
        for(let j = 0; j < offIndices.length; j++){
          const next = offIndices[(j+1) % offIndices.length];
          const gap = (next - offIndices[j] + 7) % 7;
          if(gap > maxGap){ maxGap = gap; gapAfter = j; }
        }
        startIdx = (gapAfter + 1) % offIndices.length;
      }
      const ordered = [];
      for(let j = 0; j < offIndices.length; j++){
        ordered.push(ALL_LABELS[offIndices[(startIdx + j) % offIndices.length]]);
      }
      daysOffStr = ordered.join("/");
    }
    return {
      Employee: d.Employee || "",
      Seniority: typeof d.SENIORITY === "number" ? d.SENIORITY : (parseInt(d.SENIORITY,10) || 0),
      Position: d.POSITION || "",
      DaysOff: daysOffStr,
      Present: "YES",
      Schedule: sched
    };
  });
  base.sort((a,b) => a.Position.localeCompare(b.Position) || a.Seniority - b.Seniority);
  const json = JSON.stringify(base);
  const txt = "const BASE = " + json + ";";
  navigator.clipboard.writeText(txt).then(() => {
    alert("Exported " + base.length + " employees to clipboard!\nPaste it to update admin.html / index.html.");
  }).catch(() => {
    const ta = document.createElement("textarea");
    ta.value = txt;
    ta.style.cssText = "position:fixed;top:10%;left:5%;width:90%;height:80%;z-index:9999;font-size:11px";
    document.body.appendChild(ta);
    ta.select();
    alert("Could not copy to clipboard. Select all text in the textarea and copy manually.");
  });
}

function renderStats(){
  const counts = {CALLTAKER:0, DISPATCHER:0, PIC:0, SUPERVISOR:0, OTHER:0};
  let dirty = 0;
  for(const e of employees){
    const p = e.data.POSITION;
    if(counts[p] !== undefined) counts[p]++;
    else counts.OTHER++;
    if(e.dirty) dirty++;
  }
  document.getElementById("empCount").textContent = employees.length;
  let html = `<span>Total: <b>${employees.length}</b></span>`;
  html += `<span>CT: <b>${counts.CALLTAKER}</b></span>`;
  html += `<span>DP: <b>${counts.DISPATCHER}</b></span>`;
  html += `<span>PIC: <b>${counts.PIC}</b></span>`;
  html += `<span>SUP: <b>${counts.SUPERVISOR}</b></span>`;
  if(counts.OTHER) html += `<span>Other: <b>${counts.OTHER}</b></span>`;
  if(dirty) html += `<span style="color:var(--warn)">Unsaved: <b>${dirty}</b></span>`;
  document.getElementById("statsBar").innerHTML = html;
}

function getFilteredSorted(){
  const q = document.getElementById("searchInput").value.trim().toLowerCase();
  const pos = document.getElementById("filterPos").value;
  let list = employees.filter(e => {
    if(q && !e.data.Employee.toLowerCase().includes(q)) return false;
    if(pos && e.data.POSITION !== pos) return false;
    return true;
  });
  list.sort((a,b) => {
    let va = a.data[sortCol], vb = b.data[sortCol];
    if(sortCol === "SENIORITY"){
      va = Number(va) || 9999;
      vb = Number(vb) || 9999;
    } else {
      va = String(va||"").toLowerCase();
      vb = String(vb||"").toLowerCase();
    }
    if(va < vb) return sortAsc ? -1 : 1;
    if(va > vb) return sortAsc ? 1 : -1;
    return 0;
  });
  return list;
}

function renderTable(){
  const list = getFilteredSorted();
  const tbody = document.getElementById("tbody");
  const posOpts = POSITIONS.map(p => `<option value="${p}">${p}</option>`).join("");

  tbody.innerHTML = list.map((e, idx) => {
    const d = e.data;
    const cls = e.isNew ? "new-row" : (e.dirty ? "dirty" : "");
    const origIdx = employees.indexOf(e);
    return `<tr class="${cls}" data-idx="${origIdx}">
      <td><input class="name-input" value="${esc(d.Employee)}" data-field="Employee"/></td>
      <td><input class="sen-input" type="number" value="${esc(String(d.SENIORITY))}" data-field="SENIORITY"/></td>
      <td><select class="pos-select" data-field="POSITION">${posOpts.replace(`value="${esc(d.POSITION)}"`, `value="${esc(d.POSITION)}" selected`)}</select></td>
      <td><input class="sched-input" value="${esc(d.MONDAY)}" data-field="MONDAY" placeholder="OFF"/></td>
      <td><input class="sched-input" value="${esc(d.TUESDAY)}" data-field="TUESDAY" placeholder="OFF"/></td>
      <td><input class="sched-input" value="${esc(d.WEDNESDAY)}" data-field="WEDNESDAY" placeholder="OFF"/></td>
      <td><input class="sched-input" value="${esc(d.THURSDAY)}" data-field="THURSDAY" placeholder="OFF"/></td>
      <td><input class="sched-input" value="${esc(d.FRIDAY)}" data-field="FRIDAY" placeholder="OFF"/></td>
      <td><input class="sched-input" value="${esc(d.SATURDAY)}" data-field="SATURDAY" placeholder="OFF"/></td>
      <td><input class="sched-input" value="${esc(d.SUNDAY)}" data-field="SUNDAY" placeholder="OFF"/></td>
      <td class="row-actions">
        <button class="ok" onclick="saveOne(${origIdx})" title="Save this employee">Save</button>
        <button class="danger" onclick="deleteOne(${origIdx})" title="Delete this employee">Del</button>
      </td>
    </tr>`;
  }).join("");

  // Attach change listeners
  tbody.querySelectorAll("input, select").forEach(el => {
    el.addEventListener("change", onFieldChange);
    el.addEventListener("input", onFieldChange);
  });
}

function onFieldChange(e){
  const tr = e.target.closest("tr");
  const idx = parseInt(tr.dataset.idx);
  const field = e.target.dataset.field;
  let val = e.target.value;
  if(field === "SENIORITY") val = val === "" ? "" : Number(val);
  if(field === "POSITION") val = val.toUpperCase();
  employees[idx].data[field] = val;
  employees[idx].dirty = true;
  tr.classList.add("dirty");
  renderStats();
}

function esc(s){ return String(s||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }

function renderAll(){
  renderStats();
  renderTable();
  updateSortHeaders();
}

function updateSortHeaders(){
  document.querySelectorAll("th[data-col]").forEach(th => {
    th.classList.remove("sorted-asc","sorted-desc");
    if(th.dataset.col === sortCol){
      th.classList.add(sortAsc ? "sorted-asc" : "sorted-desc");
    }
  });
}

// Sort on header click
document.querySelectorAll("th[data-col]").forEach(th => {
  th.addEventListener("click", () => {
    const col = th.dataset.col;
    if(sortCol === col) sortAsc = !sortAsc;
    else { sortCol = col; sortAsc = true; }
    renderAll();
  });
});

// Search & filter
document.getElementById("searchInput").addEventListener("input", renderTable);
document.getElementById("filterPos").addEventListener("change", renderTable);

// Add employee
document.getElementById("btnAdd").addEventListener("click", () => {
  const f = document.getElementById("addForm");
  f.style.display = f.style.display === "none" ? "block" : "none";
  if(f.style.display === "block") document.getElementById("addName").focus();
});

function addEmployee(){
  const name = document.getElementById("addName").value.trim();
  if(!name){ toast("Name is required."); return; }
  const sen = document.getElementById("addSen").value;
  const pos = document.getElementById("addPos").value;

  const data = {
    Employee: name,
    SENIORITY: sen === "" ? "" : Number(sen),
    POSITION: pos,
    MONDAY: document.getElementById("addMon").value.trim() || "OFF",
    TUESDAY: document.getElementById("addTue").value.trim() || "OFF",
    WEDNESDAY: document.getElementById("addWed").value.trim() || "OFF",
    THURSDAY: document.getElementById("addThu").value.trim() || "OFF",
    FRIDAY: document.getElementById("addFri").value.trim() || "OFF",
    SATURDAY: document.getElementById("addSat").value.trim() || "OFF",
    SUNDAY: document.getElementById("addSun").value.trim() || "OFF",
  };

  employees.push({ docId: null, data, dirty: true, isNew: true });
  document.getElementById("addForm").style.display = "none";
  // Clear form
  ["addName","addSen","addMon","addTue","addWed","addThu","addFri","addSat","addSun"].forEach(id => document.getElementById(id).value = "");
  toast("Added " + name + " (unsaved). Click Save to write to Firestore.");
  renderAll();
}

async function saveOne(idx){
  const e = employees[idx];
  if(!e) return;
  const d = e.data;
  if(!d.Employee.trim()){ toast("Name cannot be empty."); return; }

  const payload = {
    Employee: d.Employee.trim(),
    SENIORITY: d.SENIORITY === "" ? "" : Number(d.SENIORITY),
    POSITION: d.POSITION,
    MONDAY: d.MONDAY || "",
    TUESDAY: d.TUESDAY || "",
    WEDNESDAY: d.WEDNESDAY || "",
    THURSDAY: d.THURSDAY || "",
    FRIDAY: d.FRIDAY || "",
    SATURDAY: d.SATURDAY || "",
    SUNDAY: d.SUNDAY || "",
  };

  try {
    if(e.docId){
      await db.collection("employees").doc(e.docId).set(payload);
    } else {
      const ref = await db.collection("employees").add(payload);
      e.docId = ref.id;
    }
    e.dirty = false;
    e.isNew = false;
    toast("Saved " + d.Employee);
    renderAll();
  } catch(err){
    console.error(err);
    toast("Save failed: " + err.message);
  }
}

async function deleteOne(idx){
  const e = employees[idx];
  if(!e) return;
  if(!confirm("Delete " + e.data.Employee + "?\n\nThis cannot be undone.")) return;

  try {
    if(e.docId){
      await db.collection("employees").doc(e.docId).delete();
    }
    employees.splice(idx, 1);
    toast("Deleted " + e.data.Employee);
    renderAll();
  } catch(err){
    console.error(err);
    toast("Delete failed: " + err.message);
  }
}

// Save all dirty
document.getElementById("btnSaveAll").addEventListener("click", async () => {
  const dirtyList = employees.filter(e => e.dirty);
  if(!dirtyList.length){ toast("Nothing to save."); return; }
  if(!confirm("Save " + dirtyList.length + " changed employee(s) to Firestore?")) return;

  let saved = 0, errors = 0;
  for(const e of dirtyList){
    const d = e.data;
    if(!d.Employee.trim()){ errors++; continue; }
    const payload = {
      Employee: d.Employee.trim(),
      SENIORITY: d.SENIORITY === "" ? "" : Number(d.SENIORITY),
      POSITION: d.POSITION,
      MONDAY: d.MONDAY || "",
      TUESDAY: d.TUESDAY || "",
      WEDNESDAY: d.WEDNESDAY || "",
      THURSDAY: d.THURSDAY || "",
      FRIDAY: d.FRIDAY || "",
      SATURDAY: d.SATURDAY || "",
      SUNDAY: d.SUNDAY || "",
    };
    try {
      if(e.docId){
        await db.collection("employees").doc(e.docId).set(payload);
      } else {
        const ref = await db.collection("employees").add(payload);
        e.docId = ref.id;
      }
      e.dirty = false;
      e.isNew = false;
      saved++;
    } catch(err){
      console.error(err);
      errors++;
    }
  }
  toast("Saved " + saved + (errors ? ", " + errors + " errors" : ""));
  renderAll();
});

// Reload
document.getElementById("btnReload").addEventListener("click", () => {
  const dirty = employees.filter(e => e.dirty).length;
  if(dirty && !confirm(dirty + " unsaved change(s) will be lost. Reload?")) return;
  loadEmployees();
});

// ===== Tab switching =====
let _activeTab = 'employees';
let _reasonsLoaded = false;
let _adeqLoaded = false;
let _seatsLoaded = false;
let _scheduledLoaded = false;

function switchTab(tab){
  _activeTab = tab;
  document.getElementById('sectionEmployees').style.display = tab === 'employees' ? '' : 'none';
  document.getElementById('sectionReasons').style.display = tab === 'reasons' ? '' : 'none';
  document.getElementById('sectionAdeq').style.display = tab === 'adeq' ? '' : 'none';
  document.getElementById('sectionSeats').style.display = tab === 'seats' ? '' : 'none';
  document.getElementById('sectionScheduled').style.display = tab === 'scheduled' ? '' : 'none';
  document.querySelectorAll('.tab-bar button').forEach((btn, i) => {
    const targets = ['employees','reasons','adeq','seats','scheduled'];
    btn.classList.toggle('active', targets[i] === tab);
  });
  if(tab === 'reasons' && !_reasonsLoaded){
    _reasonsLoaded = true;
    loadReasons();
  }
  if(tab === 'adeq' && !_adeqLoaded){
    _adeqLoaded = true;
    loadAdeqData();
  }
  if(tab === 'seats' && !_seatsLoaded){
    _seatsLoaded = true;
    loadSeats();
  }
  if(tab === 'scheduled' && !_scheduledLoaded){
    _scheduledLoaded = true;
    loadScheduled();
  }
}

// ===== Absence Reasons CRUD =====
let reasons = []; // {docId, data:{reason}, dirty, isNew, fieldName}

async function loadReasons(){
  try {
    const snap = await db.collection("Absent_Reason").get();
    reasons = snap.docs.map(doc => {
      const d = doc.data();
      // The doc might store reason under various field names; find the first string value
      let reason = "";
      let fieldName = "reason";
      for(const [k, v] of Object.entries(d)){
        if(typeof v === "string" && v.trim()){
          reason = v.trim();
          fieldName = k;
          break;
        }
      }
      return { docId: doc.id, data: { reason }, dirty: false, isNew: false, fieldName };
    });
    reasons.sort((a,b) => a.data.reason.localeCompare(b.data.reason));
    toast("Loaded " + reasons.length + " absence reasons.");
    renderReasons();
  } catch(e){
    console.error(e);
    toast("Failed to load reasons: " + e.message);
  }
}

function renderReasons(){
  document.getElementById("reasonCount").textContent = reasons.length;
  const tbody = document.getElementById("reasonsTbody");
  tbody.innerHTML = reasons.map((r, idx) => {
    const cls = r.isNew ? "new-row" : (r.dirty ? "dirty" : "");
    return `<tr class="${cls}">
      <td><input value="${esc(r.data.reason)}" onchange="onReasonChange(${idx}, this.value)" oninput="onReasonChange(${idx}, this.value)"/></td>
      <td class="row-actions">
        <button class="ok" onclick="saveOneReason(${idx})">Save</button>
        <button class="danger" onclick="deleteOneReason(${idx})">Del</button>
      </td>
    </tr>`;
  }).join("");
}

function onReasonChange(idx, val){
  reasons[idx].data.reason = val.toUpperCase();
  reasons[idx].dirty = true;
  renderReasons();
}

function toggleAddReason(){
  const f = document.getElementById("addReasonForm");
  f.style.display = f.style.display === "none" ? "block" : "none";
  if(f.style.display === "block") document.getElementById("addReasonInput").focus();
}

function addReason(){
  const val = document.getElementById("addReasonInput").value.trim().toUpperCase();
  if(!val){ toast("Reason name is required."); return; }
  if(reasons.some(r => r.data.reason === val)){ toast("Reason already exists."); return; }
  reasons.push({ docId: null, data: { reason: val }, dirty: true, isNew: true, fieldName: "reason" });
  document.getElementById("addReasonInput").value = "";
  document.getElementById("addReasonForm").style.display = "none";
  toast("Added " + val + " (unsaved).");
  renderReasons();
}

async function saveOneReason(idx){
  const r = reasons[idx];
  if(!r) return;
  const val = r.data.reason.trim().toUpperCase();
  if(!val){ toast("Reason cannot be empty."); return; }

  try {
    if(r.docId){
      // Preserve original field name for existing docs
      await db.collection("Absent_Reason").doc(r.docId).set({ [r.fieldName]: val });
    } else {
      const ref = await db.collection("Absent_Reason").add({ reason: val });
      r.docId = ref.id;
      r.fieldName = "reason";
    }
    r.dirty = false;
    r.isNew = false;
    r.data.reason = val;
    toast("Saved " + val);
    renderReasons();
  } catch(err){
    console.error(err);
    toast("Save failed: " + err.message);
  }
}

async function deleteOneReason(idx){
  const r = reasons[idx];
  if(!r) return;
  if(!confirm("Delete reason \"" + r.data.reason + "\"?\n\nThis cannot be undone.")) return;

  try {
    if(r.docId){
      await db.collection("Absent_Reason").doc(r.docId).delete();
    }
    reasons.splice(idx, 1);
    toast("Deleted " + r.data.reason);
    renderReasons();
  } catch(err){
    console.error(err);
    toast("Delete failed: " + err.message);
  }
}

async function saveAllReasons(){
  const dirtyList = reasons.filter(r => r.dirty);
  if(!dirtyList.length){ toast("Nothing to save."); return; }
  if(!confirm("Save " + dirtyList.length + " reason(s) to Firestore?")) return;

  let saved = 0, errors = 0;
  for(const r of dirtyList){
    const val = r.data.reason.trim().toUpperCase();
    if(!val){ errors++; continue; }
    try {
      if(r.docId){
        await db.collection("Absent_Reason").doc(r.docId).set({ [r.fieldName]: val });
      } else {
        const ref = await db.collection("Absent_Reason").add({ reason: val });
        r.docId = ref.id;
        r.fieldName = "reason";
      }
      r.dirty = false;
      r.isNew = false;
      r.data.reason = val;
      saved++;
    } catch(err){
      console.error(err);
      errors++;
    }
  }
  toast("Saved " + saved + (errors ? ", " + errors + " errors" : ""));
  renderReasons();
}

// ===== Migration: SICKâ†’REASON 1, FMLAâ†’REASON 2 in daily_edits =====
async function migrateOldRecords(){
  if(!confirm("This will scan ALL daily_edits documents and replace:\n\n  SICK â†’ REASON 1\n  FMLA â†’ REASON 2\n\nin AbsenceReason and PartialReason fields.\n\nContinue?")) return;

  const prog = document.getElementById("migrateProgress");
  prog.style.display = "block";
  prog.textContent = "Scanning daily_edits...";

  try {
    const snap = await db.collection("daily_edits").get();
    prog.textContent = "Found " + snap.size + " docs. Processing...";

    let docsModified = 0, recordsChanged = 0;

    for(const doc of snap.docs){
      const data = doc.data();
      const edits = data.edits;
      if(!edits || typeof edits !== "object") continue;

      let docDirty = false;

      for(const emp of Object.keys(edits)){
        const empEdits = edits[emp];
        if(!empEdits || typeof empEdits !== "object") continue;

        for(const blockId of Object.keys(empEdits)){
          const entry = empEdits[blockId];
          if(!entry || typeof entry !== "object") continue;

          if(entry.AbsenceReason === "SICK"){
            entry.AbsenceReason = "REASON 1";
            docDirty = true; recordsChanged++;
          } else if(entry.AbsenceReason === "FMLA"){
            entry.AbsenceReason = "REASON 2";
            docDirty = true; recordsChanged++;
          }

          if(entry.PartialReason === "SICK"){
            entry.PartialReason = "REASON 1";
            docDirty = true; recordsChanged++;
          } else if(entry.PartialReason === "FMLA"){
            entry.PartialReason = "REASON 2";
            docDirty = true; recordsChanged++;
          }
        }
      }

      if(docDirty){
        await db.collection("daily_edits").doc(doc.id).update({ edits });
        docsModified++;
        prog.textContent = "Updated " + docsModified + " docs so far...";
      }
    }

    prog.style.display = "none";
    toast("Migrated " + recordsChanged + " records across " + docsModified + " docs.");
  } catch(err){
    console.error(err);
    prog.style.display = "none";
    toast("Migration failed: " + err.message);
  }
}

// ===== Adequate Staffing CRUD =====
const ADEQ_ROLES = [
  { key: "CALLTAKER",  collection: "Calltaker_Adequate_Staffing",  timeField: "Calltaker Adequate staffing" },
  { key: "DISPATCHER", collection: "Dispatcher_Adequate_Staffing", timeField: "Dispatcher Adequate Staffing" },
  { key: "PIC",        collection: "PIC_Adequate_Staffing",        timeField: "PIC Adequate Staffing" },
];
const ADEQ_DAY_COLS = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];

let adeqData = { CALLTAKER: [], DISPATCHER: [], PIC: [] };
// Each entry: { docId, time:"06:00", hourKey:"0600", Sun:n, Mon:n, ..., dirty, isNew }
let _adeqRole = "CALLTAKER";

async function loadAdeqData(){
  const status = document.getElementById("adeqStatus");
  status.style.display = "block"; status.style.color = "var(--accent)"; status.textContent = "Loading...";
  try {
    for(const r of ADEQ_ROLES){
      const snap = await db.collection(r.collection).get();
      adeqData[r.key] = snap.docs.map(doc => {
        const d = doc.data();
        const timeVal = d[r.timeField];
        if(timeVal === "Time" || timeVal === undefined || timeVal === null) return null;
        const hourKey = String(timeVal).replace(/[^0-9]/g,"").padStart(4,"0");
        const entry = { docId: doc.id, time: String(timeVal), hourKey, dirty: false, isNew: false };
        for(const col of ADEQ_DAY_COLS){
          entry[col] = (d[col] !== undefined && d[col] !== null && d[col] !== "") ? Number(d[col]) : "";
        }
        return entry;
      }).filter(Boolean);
      adeqData[r.key].sort((a,b) => parseInt(a.hourKey,10) - parseInt(b.hourKey,10));
    }
    status.style.display = "none";
    toast("Loaded adequate staffing data.");
    renderAdeqTable();
  } catch(e){
    console.error(e);
    status.style.color = "var(--bad)"; status.textContent = "Failed: " + e.message;
    toast("Failed to load adequate staffing: " + e.message);
  }
}

function renderAdeqTable(){
  const list = (adeqData[_adeqRole] || []).filter(r => !r._deleted);
  const tbody = document.getElementById("adeqTbody");

  if(!list.length){
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:20px">No hours configured. Click "+ Add Hour" to start.</td></tr>';
    populateAdeqHourSelect();
    return;
  }

  const fullList = adeqData[_adeqRole] || [];
  tbody.innerHTML = list.map((row) => {
    const origIdx = fullList.indexOf(row);
    const cls = row.isNew ? "new-row" : (row.dirty ? "dirty" : "");
    const disp = row.hourKey.slice(0,2) + ":" + row.hourKey.slice(2);
    let html = `<tr class="${cls}" data-aidx="${origIdx}"><td>${esc(disp)}</td>`;
    for(const col of ADEQ_DAY_COLS){
      html += `<td><input type="number" min="0" value="${row[col] !== "" ? row[col] : ""}" data-col="${col}"/></td>`;
    }
    html += `<td class="row-actions"><button class="danger" onclick="deleteAdeqHour(${origIdx})" title="Remove hour">Del</button></td></tr>`;
    return html;
  }).join("");

  tbody.querySelectorAll('input[type="number"]').forEach(inp => {
    inp.addEventListener("change", onAdeqCellChange);
    inp.addEventListener("input", onAdeqCellChange);
  });
  populateAdeqHourSelect();
}

function onAdeqCellChange(e){
  const tr = e.target.closest("tr");
  const idx = parseInt(tr.dataset.aidx);
  const col = e.target.dataset.col;
  const val = e.target.value;
  adeqData[_adeqRole][idx][col] = val === "" ? "" : Number(val);
  adeqData[_adeqRole][idx].dirty = true;
  tr.classList.add("dirty");
}

function populateAdeqHourSelect(){
  const sel = document.getElementById("adeqNewHourSel");
  const existing = new Set((adeqData[_adeqRole]||[]).map(r => r.hourKey));
  sel.innerHTML = '';
  for(let h = 0; h < 24; h++){
    const hk = (h * 100).toString().padStart(4,"0");
    if(!existing.has(hk)){
      const disp = hk.slice(0,2) + ":" + hk.slice(2);
      sel.innerHTML += `<option value="${hk}">${disp}</option>`;
    }
  }
  if(!sel.options.length) sel.innerHTML = '<option value="">All hours added</option>';
}

function addAdeqHour(){
  const sel = document.getElementById("adeqNewHourSel");
  const hk = sel.value;
  if(!hk) return;
  const disp = hk.slice(0,2) + ":" + hk.slice(2);
  const entry = { docId: null, time: disp, hourKey: hk, dirty: true, isNew: true };
  for(const col of ADEQ_DAY_COLS) entry[col] = "";
  adeqData[_adeqRole].push(entry);
  adeqData[_adeqRole].sort((a,b) => parseInt(a.hourKey,10) - parseInt(b.hourKey,10));
  document.getElementById("adeqAddRow").style.display = "none";
  toast("Added " + disp + " (unsaved).");
  renderAdeqTable();
}

function deleteAdeqHour(idx){
  const row = adeqData[_adeqRole][idx];
  if(!row) return;
  const disp = row.hourKey.slice(0,2) + ":" + row.hourKey.slice(2);
  if(!confirm("Delete hour " + disp + "?\n\nThis will be removed on save.")) return;

  if(row.docId){
    // Mark for deletion on save
    row._deleted = true;
    row.dirty = true;
  } else {
    adeqData[_adeqRole].splice(idx, 1);
  }
  toast("Removed " + disp);
  renderAdeqTable();
}

async function saveAllAdeq(){
  const role = ADEQ_ROLES.find(r => r.key === _adeqRole);
  if(!role) return;
  const list = adeqData[_adeqRole] || [];
  const dirtyList = list.filter(r => r.dirty);
  if(!dirtyList.length){ toast("Nothing to save."); return; }
  if(!confirm("Save " + _adeqRole + " staffing changes to Firestore?")) return;

  const status = document.getElementById("adeqStatus");
  status.style.display = "block"; status.style.color = "var(--accent)"; status.textContent = "Saving...";

  let saved = 0, errors = 0;
  try {
    for(const row of dirtyList){
      if(row._deleted){
        if(row.docId){
          await db.collection(role.collection).doc(row.docId).delete();
        }
        saved++;
        continue;
      }
      const docData = {};
      docData[role.timeField] = row.time;
      for(const col of ADEQ_DAY_COLS){
        docData[col] = (row[col] !== "" && row[col] !== undefined) ? Number(row[col]) : "";
      }
      try {
        if(row.docId){
          await db.collection(role.collection).doc(row.docId).set(docData);
        } else {
          const ref = await db.collection(role.collection).add(docData);
          row.docId = ref.id;
        }
        row.dirty = false;
        row.isNew = false;
        saved++;
      } catch(err){
        console.error(err);
        errors++;
      }
    }
    // Remove deleted entries from local array
    adeqData[_adeqRole] = adeqData[_adeqRole].filter(r => !r._deleted);
    status.style.display = "none";
    toast("Saved " + saved + (errors ? ", " + errors + " errors" : "") + " for " + _adeqRole);
    renderAdeqTable();
  } catch(err){
    console.error(err);
    status.style.color = "var(--bad)"; status.textContent = "Save failed: " + err.message;
  }
}

// Adequate Staffing event listeners
document.getElementById("btnAddAdeqHour").addEventListener("click", () => {
  const f = document.getElementById("adeqAddRow");
  f.style.display = f.style.display === "none" ? "block" : "none";
});
document.getElementById("btnSaveAdeq").addEventListener("click", saveAllAdeq);
document.getElementById("btnReloadAdeq").addEventListener("click", () => {
  const dirty = (adeqData[_adeqRole]||[]).some(r => r.dirty);
  if(dirty && !confirm("Unsaved changes will be lost. Reload?")) return;
  _adeqLoaded = false;
  loadAdeqData();
});
document.querySelectorAll('#adeqRoleTabs button').forEach(btn => {
  btn.addEventListener("click", () => {
    _adeqRole = btn.dataset.role;
    document.querySelectorAll('#adeqRoleTabs button').forEach(b => b.classList.toggle('active', b === btn));
    renderAdeqTable();
  });
});

// ===== Seat Assignments CRUD =====
const SEAT_ROLES = [
  { key: "CALLTAKER",   collection: "Calltaker_Seat_Assignments" },
  { key: "DISPATCHER",  collection: "Dispatcher_Seat_Assignments" },
  { key: "PIC",         collection: "PIC_Seat_Assignments" },
  { key: "SUPERVISOR",  collection: "Supervisor_seat_Assignments" },
];

let seatsData = { CALLTAKER: [], DISPATCHER: [], PIC: [], SUPERVISOR: [] };
// Each entry: { docId, name, fieldName, dirty, isNew }
let _seatsRole = "CALLTAKER";

async function loadSeats(){
  try {
    for(const r of SEAT_ROLES){
      const snap = await db.collection(r.collection).get();
      seatsData[r.key] = snap.docs.map(doc => {
        const d = doc.data();
        const entries = Object.entries(d);
        const firstEntry = entries.length ? entries[0] : ["seat",""];
        return {
          docId: doc.id,
          name: String(firstEntry[1] || "").trim(),
          fieldName: firstEntry[0],
          dirty: false,
          isNew: false
        };
      }).filter(e => e.name);
      seatsData[r.key].sort((a,b) => a.name.localeCompare(b.name));
    }
    toast("Loaded seat assignments.");
    renderSeats();
  } catch(e){
    console.error(e);
    toast("Failed to load seats: " + e.message);
  }
}

function renderSeats(){
  const list = seatsData[_seatsRole] || [];
  document.getElementById("seatCount").textContent = list.length;
  const tbody = document.getElementById("seatsTbody");
  tbody.innerHTML = list.map((s, idx) => {
    const cls = s.isNew ? "new-row" : (s.dirty ? "dirty" : "");
    return `<tr class="${cls}">
      <td><input value="${esc(s.name)}" onchange="onSeatChange(${idx}, this.value)" oninput="onSeatChange(${idx}, this.value)"/></td>
      <td class="row-actions">
        <button class="ok" onclick="saveOneSeat(${idx})">Save</button>
        <button class="danger" onclick="deleteOneSeat(${idx})">Del</button>
      </td>
    </tr>`;
  }).join("");
}

function onSeatChange(idx, val){
  seatsData[_seatsRole][idx].name = val.trim();
  seatsData[_seatsRole][idx].dirty = true;
  renderSeats();
}

function addSeat(){
  const val = document.getElementById("seatAddInput").value.trim();
  if(!val){ toast("Seat name is required."); return; }
  if(seatsData[_seatsRole].some(s => s.name.toLowerCase() === val.toLowerCase())){ toast("Seat already exists."); return; }
  seatsData[_seatsRole].push({ docId: null, name: val, fieldName: "seat", dirty: true, isNew: true });
  seatsData[_seatsRole].sort((a,b) => a.name.localeCompare(b.name));
  document.getElementById("seatAddInput").value = "";
  document.getElementById("seatAddForm").style.display = "none";
  toast("Added " + val + " (unsaved).");
  renderSeats();
}

async function saveOneSeat(idx){
  const s = seatsData[_seatsRole][idx];
  if(!s) return;
  const val = s.name.trim();
  if(!val){ toast("Seat name cannot be empty."); return; }
  const role = SEAT_ROLES.find(r => r.key === _seatsRole);

  try {
    if(s.docId){
      await db.collection(role.collection).doc(s.docId).set({ [s.fieldName]: val });
    } else {
      const ref = await db.collection(role.collection).add({ seat: val });
      s.docId = ref.id;
      s.fieldName = "seat";
    }
    s.dirty = false;
    s.isNew = false;
    toast("Saved " + val);
    renderSeats();
  } catch(err){
    console.error(err);
    toast("Save failed: " + err.message);
  }
}

async function deleteOneSeat(idx){
  const s = seatsData[_seatsRole][idx];
  if(!s) return;
  if(!confirm("Delete seat \"" + s.name + "\"?\n\nThis cannot be undone.")) return;

  try {
    if(s.docId){
      await db.collection(SEAT_ROLES.find(r => r.key === _seatsRole).collection).doc(s.docId).delete();
    }
    seatsData[_seatsRole].splice(idx, 1);
    toast("Deleted " + s.name);
    renderSeats();
  } catch(err){
    console.error(err);
    toast("Delete failed: " + err.message);
  }
}

async function saveAllSeats(){
  const dirtyList = seatsData[_seatsRole].filter(s => s.dirty);
  if(!dirtyList.length){ toast("Nothing to save."); return; }
  if(!confirm("Save " + dirtyList.length + " seat(s) for " + _seatsRole + " to Firestore?")) return;
  const role = SEAT_ROLES.find(r => r.key === _seatsRole);

  let saved = 0, errors = 0;
  for(const s of dirtyList){
    const val = s.name.trim();
    if(!val){ errors++; continue; }
    try {
      if(s.docId){
        await db.collection(role.collection).doc(s.docId).set({ [s.fieldName]: val });
      } else {
        const ref = await db.collection(role.collection).add({ seat: val });
        s.docId = ref.id;
        s.fieldName = "seat";
      }
      s.dirty = false;
      s.isNew = false;
      saved++;
    } catch(err){
      console.error(err);
      errors++;
    }
  }
  toast("Saved " + saved + (errors ? ", " + errors + " errors" : "") + " for " + _seatsRole);
  renderSeats();
}

// Seat Assignments event listeners
document.getElementById("btnAddSeat").addEventListener("click", () => {
  const f = document.getElementById("seatAddForm");
  f.style.display = f.style.display === "none" ? "block" : "none";
  if(f.style.display === "block") document.getElementById("seatAddInput").focus();
});
document.getElementById("btnSaveSeats").addEventListener("click", saveAllSeats);
document.getElementById("btnReloadSeats").addEventListener("click", () => {
  const dirty = (seatsData[_seatsRole]||[]).some(s => s.dirty);
  if(dirty && !confirm("Unsaved changes will be lost. Reload?")) return;
  _seatsLoaded = false;
  loadSeats();
});
document.querySelectorAll('#seatsRoleTabs button').forEach(btn => {
  btn.addEventListener("click", () => {
    _seatsRole = btn.dataset.role;
    document.querySelectorAll('#seatsRoleTabs button').forEach(b => b.classList.toggle('active', b === btn));
    renderSeats();
  });
});

// ===== Scheduled Changes CRUD =====
let scheduledChanges = []; // {docId, data:{...}, ...}

function todayStr(){
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

async function loadScheduled(){
  try {
    const snap = await db.collection("scheduledChanges").get();
    scheduledChanges = snap.docs.map(doc => ({ docId: doc.id, data: doc.data() }));
    // Sort by effectiveDate desc
    scheduledChanges.sort((a,b) => (b.data.effectiveDate || '').localeCompare(a.data.effectiveDate || ''));
    renderScheduled();
  } catch(e){
    console.error(e);
    toast("Failed to load scheduled changes: " + e.message);
  }
}

function renderScheduled(){
  const filter = document.getElementById("schedFilter").value;
  let list = scheduledChanges;
  if(filter) list = list.filter(c => c.data.status === filter);

  document.getElementById("schedCount").textContent = scheduledChanges.length;
  const tbody = document.getElementById("schedTbody");
  const emptyEl = document.getElementById("schedEmpty");

  if(!list.length){
    tbody.innerHTML = '';
    emptyEl.style.display = 'block';
    document.getElementById("schedTable").style.display = 'none';
    return;
  }
  emptyEl.style.display = 'none';
  document.getElementById("schedTable").style.display = '';

  tbody.innerHTML = list.map((c, idx) => {
    const d = c.data;
    const origIdx = scheduledChanges.indexOf(c);
    const badgeCls = d.status === 'active' ? 'badge-active' : (d.status === 'expired' ? 'badge-expired' : 'badge-pending');
    const typeLabel = d.type === 'mirror' ? 'Mirror' : 'Schedule';
    const empLabel = d.type === 'mirror' ? esc(d.employee || d.traineeName || '') + ' &#8594; ' + esc(d.trainerName || '') : esc(d.employee || '');
    const dateRange = esc(d.effectiveDate || '') + (d.endDate ? ' to ' + esc(d.endDate) : ' (permanent)');
    return `<tr>
      <td><span class="badge ${badgeCls}">${esc(d.status || 'pending')}</span></td>
      <td>${esc(typeLabel)}</td>
      <td>${empLabel}</td>
      <td>${dateRange}</td>
      <td>${esc(d.description || '')}</td>
      <td class="row-actions"><button class="danger" onclick="deleteScheduledChange(${origIdx})">Del</button></td>
    </tr>`;
  }).join("");
}

function onSchedTypeChange(){
  const type = document.getElementById("schedType").value;
  document.getElementById("schedFieldsSchedule").style.display = type === 'schedule' ? '' : 'none';
  document.getElementById("schedFieldsMirror").style.display = type === 'mirror' ? '' : 'none';
}

function populateSchedDropdowns(){
  const empSelect = document.getElementById("schedEmployee");
  const trainerSelect = document.getElementById("schedTrainer");
  const traineeSelect = document.getElementById("schedTrainee");
  const sorted = [...employees].sort((a,b) => (a.data.Employee||'').localeCompare(b.data.Employee||''));
  const opts = sorted.map(e => `<option value="${esc(e.data.Employee)}">${esc(e.data.Employee)}</option>`).join("");
  empSelect.innerHTML = '<option value="">Select...</option>' + opts;
  trainerSelect.innerHTML = '<option value="">Select...</option>' + opts;
  traineeSelect.innerHTML = '<option value="">Select...</option>' + opts + '<option value="__CUSTOM__">Custom (New Trainee)</option>';
}

function onSchedEmployeeChange(){
  const name = document.getElementById("schedEmployee").value;
  const emp = employees.find(e => e.data.Employee === name);
  if(!emp) return;
  // Pre-fill day inputs with current schedule
  const d = emp.data;
  document.getElementById("schedMon").value = d.MONDAY || '';
  document.getElementById("schedTue").value = d.TUESDAY || '';
  document.getElementById("schedWed").value = d.WEDNESDAY || '';
  document.getElementById("schedThu").value = d.THURSDAY || '';
  document.getElementById("schedFri").value = d.FRIDAY || '';
  document.getElementById("schedSat").value = d.SATURDAY || '';
  document.getElementById("schedSun").value = d.SUNDAY || '';
}

function onSchedTrainerChange(){
  const name = document.getElementById("schedTrainer").value;
  const prev = document.getElementById("trainerPreview");
  const emp = employees.find(e => e.data.Employee === name);
  if(!emp){ prev.style.display = 'none'; return; }
  const d = emp.data;
  prev.style.display = 'block';
  prev.innerHTML = `<b>${esc(name)}'s Schedule:</b> Mon: ${esc(d.MONDAY)} | Tue: ${esc(d.TUESDAY)} | Wed: ${esc(d.WEDNESDAY)} | Thu: ${esc(d.THURSDAY)} | Fri: ${esc(d.FRIDAY)} | Sat: ${esc(d.SATURDAY)} | Sun: ${esc(d.SUNDAY)}`;
}

function onSchedTraineeChange(){
  const val = document.getElementById("schedTrainee").value;
  const customInput = document.getElementById("schedTraineeCustom");
  const prev = document.getElementById("traineePreview");
  if(val === "__CUSTOM__"){
    customInput.style.display = '';
    customInput.focus();
    prev.style.display = 'none';
  } else {
    customInput.style.display = 'none';
    customInput.value = '';
    const emp = employees.find(e => e.data.Employee === val);
    if(!emp || !val){ prev.style.display = 'none'; return; }
    const d = emp.data;
    prev.style.display = 'block';
    prev.innerHTML = `<b>${esc(val)}'s Current Schedule:</b> ${esc(d.POSITION || '')} â€” Mon: ${esc(d.MONDAY)} | Tue: ${esc(d.TUESDAY)} | Wed: ${esc(d.WEDNESDAY)} | Thu: ${esc(d.THURSDAY)} | Fri: ${esc(d.FRIDAY)} | Sat: ${esc(d.SATURDAY)} | Sun: ${esc(d.SUNDAY)}`;
  }
}

async function addScheduledChange(){
  const type = document.getElementById("schedType").value;
  const desc = document.getElementById("schedDesc").value.trim();

  if(type === 'schedule'){
    const empName = document.getElementById("schedEmployee").value;
    if(!empName){ toast("Select an employee."); return; }
    const effectiveDate = document.getElementById("schedStart").value;
    if(!effectiveDate){ toast("Effective date is required."); return; }
    const endDate = document.getElementById("schedEnd").value || "";
    const newPos = document.getElementById("schedNewPos").value || "";
    const emp = employees.find(e => e.data.Employee === empName);
    const seniority = emp ? (emp.data.SENIORITY ?? "") : "";

    const newSchedule = {
      MONDAY: document.getElementById("schedMon").value.trim() || "",
      TUESDAY: document.getElementById("schedTue").value.trim() || "",
      WEDNESDAY: document.getElementById("schedWed").value.trim() || "",
      THURSDAY: document.getElementById("schedThu").value.trim() || "",
      FRIDAY: document.getElementById("schedFri").value.trim() || "",
      SATURDAY: document.getElementById("schedSat").value.trim() || "",
      SUNDAY: document.getElementById("schedSun").value.trim() || "",
    };

    // Build days off label from schedule
    const dayNames = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
    const dayKeys = ["MONDAY","TUESDAY","WEDNESDAY","THURSDAY","FRIDAY","SATURDAY","SUNDAY"];
    const offDays = dayKeys.map((k,i) => (!newSchedule[k] || newSchedule[k].toUpperCase() === "OFF") ? dayNames[i] : null).filter(Boolean);
    const newDaysOff = offDays.join("/") || "";

    const payload = {
      type: "schedule",
      employee: empName,
      seniority,
      effectiveDate,
      endDate,
      status: "pending",
      newSchedule,
      newDaysOff,
      newPosition: newPos,
      description: desc,
      _originalData: null,
      _appliedAt: null,
      _revertedAt: null,
    };

    try {
      const ref = await db.collection("scheduledChanges").add(payload);
      scheduledChanges.push({ docId: ref.id, data: payload });
      scheduledChanges.sort((a,b) => (b.data.effectiveDate||'').localeCompare(a.data.effectiveDate||''));
      toast("Scheduled change added for " + empName);
      document.getElementById("addSchedForm").style.display = "none";
      clearSchedForm();
      renderScheduled();
    } catch(err){
      console.error(err);
      toast("Failed to add: " + err.message);
    }

  } else if(type === 'mirror'){
    const traineeVal = document.getElementById("schedTrainee").value;
    let trainee;
    let traineeSeniority = 9999;
    if(traineeVal === "__CUSTOM__"){
      trainee = document.getElementById("schedTraineeCustom").value.trim().toUpperCase();
    } else {
      trainee = traineeVal;
      const existingEmp = employees.find(e => e.data.Employee === trainee);
      if(existingEmp) traineeSeniority = existingEmp.data.SENIORITY ?? 9999;
    }
    if(!trainee){ toast("Trainee name is required."); return; }
    const trainerName = document.getElementById("schedTrainer").value;
    if(!trainerName){ toast("Select a trainer."); return; }
    if(trainee === trainerName){ toast("Trainee and trainer cannot be the same person."); return; }
    const effectiveDate = document.getElementById("schedMirrorStart").value;
    if(!effectiveDate){ toast("Effective date is required."); return; }
    const endDate = document.getElementById("schedMirrorEnd").value || "";

    const payload = {
      type: "mirror",
      employee: trainee,
      seniority: traineeSeniority,
      effectiveDate,
      endDate,
      status: "pending",
      trainerName,
      description: desc || (trainee + " mirrors " + trainerName),
      _originalData: null,
      _appliedAt: null,
      _revertedAt: null,
    };

    try {
      const ref = await db.collection("scheduledChanges").add(payload);
      scheduledChanges.push({ docId: ref.id, data: payload });
      scheduledChanges.sort((a,b) => (b.data.effectiveDate||'').localeCompare(a.data.effectiveDate||''));
      toast("Training mirror added: " + trainee + " â†’ " + trainerName);
      document.getElementById("addSchedForm").style.display = "none";
      clearSchedForm();
      renderScheduled();
    } catch(err){
      console.error(err);
      toast("Failed to add: " + err.message);
    }
  }
}

function clearSchedForm(){
  document.getElementById("schedEmployee").value = "";
  document.getElementById("schedStart").value = "";
  document.getElementById("schedEnd").value = "";
  document.getElementById("schedNewPos").value = "";
  ["schedMon","schedTue","schedWed","schedThu","schedFri","schedSat","schedSun"].forEach(id => document.getElementById(id).value = "");
  document.getElementById("schedTrainee").value = "";
  document.getElementById("schedTraineeCustom").value = "";
  document.getElementById("schedTraineeCustom").style.display = "none";
  document.getElementById("schedTrainer").value = "";
  document.getElementById("schedMirrorStart").value = "";
  document.getElementById("schedMirrorEnd").value = "";
  document.getElementById("schedDesc").value = "";
  document.getElementById("trainerPreview").style.display = "none";
  document.getElementById("traineePreview").style.display = "none";
}

async function deleteScheduledChange(idx){
  const c = scheduledChanges[idx];
  if(!c) return;
  const d = c.data;
  const label = d.employee || "this change";

  // If active, warn about revert
  if(d.status === 'active'){
    if(!confirm("Delete active change for " + label + "?\n\nThis will REVERT the employee back to their original schedule.")) return;
    // Revert employee data
    await revertChange(c);
  } else {
    if(!confirm("Delete scheduled change for " + label + "?")) return;
  }

  try {
    if(c.docId){
      await db.collection("scheduledChanges").doc(c.docId).delete();
    }
    scheduledChanges.splice(idx, 1);
    toast("Deleted scheduled change for " + label);
    renderScheduled();
  } catch(err){
    console.error(err);
    toast("Delete failed: " + err.message);
  }
}

async function revertChange(c){
  const d = c.data;
  if(!d._originalData) return;

  try {
    if(d._originalData._wasNewlyCreated){
      // If trainee was newly created, delete them
      const empEntry = employees.find(e => e.data.Employee === d.employee);
      if(empEntry && empEntry.docId){
        await db.collection("employees").doc(empEntry.docId).delete();
      }
    } else {
      // Restore original data
      const empEntry = employees.find(e => e.data.Employee === d.employee);
      if(empEntry && empEntry.docId){
        const orig = d._originalData;
        const payload = {
          Employee: orig.Employee,
          SENIORITY: orig.SENIORITY ?? "",
          POSITION: orig.POSITION || "",
          MONDAY: orig.MONDAY || "",
          TUESDAY: orig.TUESDAY || "",
          WEDNESDAY: orig.WEDNESDAY || "",
          THURSDAY: orig.THURSDAY || "",
          FRIDAY: orig.FRIDAY || "",
          SATURDAY: orig.SATURDAY || "",
          SUNDAY: orig.SUNDAY || "",
        };
        await db.collection("employees").doc(empEntry.docId).set(payload);
      }
    }
    // Reload employees to reflect revert
    await loadEmployeesQuiet();
  } catch(err){
    console.error("Revert failed:", err);
    toast("Warning: revert may have failed â€” " + err.message);
  }
}

// Quiet reload (no toast, no re-process scheduled)
async function loadEmployeesQuiet(){
  try {
    const snap = await db.collection("employees").get();
    employees = snap.docs.map(doc => {
      const d = doc.data();
      return {
        docId: doc.id,
        data: {
          Employee: d.Employee || doc.id,
          SENIORITY: d.SENIORITY ?? d.Seniority ?? "",
          POSITION: normalizePos(d.POSITION ?? d.Position ?? ""),
          MONDAY: d.MONDAY ?? "",
          TUESDAY: d.TUESDAY ?? "",
          WEDNESDAY: d.WEDNESDAY ?? "",
          THURSDAY: d.THURSDAY ?? "",
          FRIDAY: d.FRIDAY ?? "",
          SATURDAY: d.SATURDAY ?? "",
          SUNDAY: d.SUNDAY ?? "",
        },
        dirty: false,
        isNew: false
      };
    });
    renderAll();
  } catch(e){ console.error(e); }
}

async function processScheduledChanges(){
  try {
    const snap = await db.collection("scheduledChanges").get();
    scheduledChanges = snap.docs.map(doc => ({ docId: doc.id, data: doc.data() }));
    const today = todayStr();
    let anyChanged = false;

    // Phase 1: Apply pending changes whose date has arrived
    for(const c of scheduledChanges){
      const d = c.data;
      if(d.status !== 'pending') continue;
      if(d.effectiveDate > today) continue;

      if(d.type === 'schedule'){
        const emp = employees.find(e => e.data.Employee === d.employee);
        if(!emp || !emp.docId) continue;

        // Save original data
        const origData = { ...emp.data };
        d._originalData = origData;

        // Apply new schedule
        const newSched = d.newSchedule || {};
        const payload = {
          Employee: emp.data.Employee,
          SENIORITY: emp.data.SENIORITY,
          POSITION: d.newPosition || emp.data.POSITION,
          MONDAY: newSched.MONDAY !== undefined ? newSched.MONDAY : emp.data.MONDAY,
          TUESDAY: newSched.TUESDAY !== undefined ? newSched.TUESDAY : emp.data.TUESDAY,
          WEDNESDAY: newSched.WEDNESDAY !== undefined ? newSched.WEDNESDAY : emp.data.WEDNESDAY,
          THURSDAY: newSched.THURSDAY !== undefined ? newSched.THURSDAY : emp.data.THURSDAY,
          FRIDAY: newSched.FRIDAY !== undefined ? newSched.FRIDAY : emp.data.FRIDAY,
          SATURDAY: newSched.SATURDAY !== undefined ? newSched.SATURDAY : emp.data.SATURDAY,
          SUNDAY: newSched.SUNDAY !== undefined ? newSched.SUNDAY : emp.data.SUNDAY,
        };
        await db.collection("employees").doc(emp.docId).set(payload);

        d.status = 'active';
        d._appliedAt = new Date().toISOString();
        await db.collection("scheduledChanges").doc(c.docId).update({
          status: 'active',
          _appliedAt: d._appliedAt,
          _originalData: d._originalData,
        });
        anyChanged = true;

      } else if(d.type === 'mirror'){
        const trainer = employees.find(e => e.data.Employee === d.trainerName);
        if(!trainer) continue;

        let trainee = employees.find(e => e.data.Employee === d.employee);
        let wasNewlyCreated = false;

        if(!trainee){
          // Create trainee employee doc
          const traineePayload = {
            Employee: d.employee,
            SENIORITY: d.seniority || 9999,
            POSITION: trainer.data.POSITION,
            MONDAY: trainer.data.MONDAY,
            TUESDAY: trainer.data.TUESDAY,
            WEDNESDAY: trainer.data.WEDNESDAY,
            THURSDAY: trainer.data.THURSDAY,
            FRIDAY: trainer.data.FRIDAY,
            SATURDAY: trainer.data.SATURDAY,
            SUNDAY: trainer.data.SUNDAY,
          };
          const ref = await db.collection("employees").add(traineePayload);
          wasNewlyCreated = true;
          d._originalData = { _wasNewlyCreated: true };
        } else {
          // Save original data then copy trainer schedule
          d._originalData = { ...trainee.data };
          const payload = {
            Employee: trainee.data.Employee,
            SENIORITY: trainee.data.SENIORITY,
            POSITION: trainer.data.POSITION,
            MONDAY: trainer.data.MONDAY,
            TUESDAY: trainer.data.TUESDAY,
            WEDNESDAY: trainer.data.WEDNESDAY,
            THURSDAY: trainer.data.THURSDAY,
            FRIDAY: trainer.data.FRIDAY,
            SATURDAY: trainer.data.SATURDAY,
            SUNDAY: trainer.data.SUNDAY,
          };
          await db.collection("employees").doc(trainee.docId).set(payload);
        }

        d.status = 'active';
        d._appliedAt = new Date().toISOString();
        await db.collection("scheduledChanges").doc(c.docId).update({
          status: 'active',
          _appliedAt: d._appliedAt,
          _originalData: d._originalData,
        });
        anyChanged = true;
      }
    }

    // Phase 2: Revert active changes whose end date has passed
    for(const c of scheduledChanges){
      const d = c.data;
      if(d.status !== 'active') continue;
      if(!d.endDate || d.endDate >= today) continue;

      // End date has passed â€” revert
      if(d._originalData){
        if(d._originalData._wasNewlyCreated){
          // Delete the newly created trainee
          const snap2 = await db.collection("employees").where("Employee", "==", d.employee).get();
          for(const doc of snap2.docs) await doc.ref.delete();
        } else {
          // Restore original data
          const snap2 = await db.collection("employees").where("Employee", "==", d.employee).get();
          if(!snap2.empty){
            const orig = d._originalData;
            const payload = {
              Employee: orig.Employee,
              SENIORITY: orig.SENIORITY ?? "",
              POSITION: orig.POSITION || "",
              MONDAY: orig.MONDAY || "",
              TUESDAY: orig.TUESDAY || "",
              WEDNESDAY: orig.WEDNESDAY || "",
              THURSDAY: orig.THURSDAY || "",
              FRIDAY: orig.FRIDAY || "",
              SATURDAY: orig.SATURDAY || "",
              SUNDAY: orig.SUNDAY || "",
            };
            await db.collection("employees").doc(snap2.docs[0].id).set(payload);
          }
        }
      }

      d.status = 'expired';
      d._revertedAt = new Date().toISOString();
      await db.collection("scheduledChanges").doc(c.docId).update({
        status: 'expired',
        _revertedAt: d._revertedAt,
      });
      anyChanged = true;
    }

    // Phase 3: If anything changed, reload employees
    if(anyChanged){
      await loadEmployeesQuiet();
      toast("Scheduled changes processed.");
    }

    // Sort and render the table if we're on the scheduled tab
    scheduledChanges.sort((a,b) => (b.data.effectiveDate||'').localeCompare(a.data.effectiveDate||''));
    if(_scheduledLoaded) renderScheduled();

  } catch(e){
    console.error("processScheduledChanges error:", e);
  }
}

// Scheduled Changes event listeners
document.getElementById("btnAddSched").addEventListener("click", () => {
  const f = document.getElementById("addSchedForm");
  f.style.display = f.style.display === "none" ? "block" : "none";
  if(f.style.display === "block") populateSchedDropdowns();
});
document.getElementById("btnReloadSched").addEventListener("click", () => {
  _scheduledLoaded = false;
  _scheduledLoaded = true;
  loadScheduled();
});
</script>
</body>
</html>
